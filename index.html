<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Workforce Hub & Dashboard | V3.0</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2canvas for copying tables as images -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaaw3X8J9t9W4rVHSwxrppq8jv3gXzH7z+AHdf2az6KddJaNbIsldCXdrkjdDBV4c+dIVhELbdjv94AJi5dFw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Library for generating Word documents -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.1.3/docx.umd.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#020617', 800: '#0f172a', 700: '#1e293b', 600: '#334155' },
                        brand: { 500: '#6366f1', 400: '#818cf8', 600: '#4f46e5' },
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } }
                }
            }
        }
        Chart.defaults.color = '#94a3b8'; Chart.defaults.borderColor = '#1e293b';
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; overflow-x: hidden; scroll-behavior: smooth; }
        .num-font { font-family: 'JetBrains Mono', monospace; }
        .glass-card { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); transition: all 0.3s ease; position: relative; overflow: hidden; }
        .glass-card:hover { transform: translateY(-3px); border-color: rgba(99, 102, 241, 0.4); }
        
        /* Shift Card Hover Effect */
        .shift-card-container { position: relative; }
/* Ø«Ø¨ÙØª Ø§Ø±ØªÙØ§Ø¹ Ø§ÙÙØ±Øª Ø§ÙØ£Ø³Ø§Ø³Ù Ø¹Ø´Ø§Ù Ø§ÙØ«ÙØ§Ø«Ø© ÙÙÙÙÙÙ ÙÙØ³ Ø§ÙØ´Ù */
.d-shift-card { min-height: 185px; }  /* Ø¥Ø°Ø§ ÙØ¯Ù Ø£Ø·ÙÙ/Ø£ÙØµØ± ØºÙÙØ± Ø§ÙØ±ÙÙ */

/* Overlay */
.shift-staff-overlay {
  position: absolute;
  inset: 0;
  background: rgba(2, 6, 23, 0.95);
  opacity: 0;
  transition: opacity 0.25s ease;
  z-index: 20;
  padding: 1rem;
  text-align: center;
  backdrop-filter: blur(6px);
  pointer-events: none;

  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;   /* Ø¨Ø¯Ù Ø§ÙÙØ³Ø· */
}

.shift-card-container:hover .shift-staff-overlay {
  opacity: 1;
  pointer-events: auto;
}

/* Ø®ÙÙ ÙØ§Ø¦ÙØ© Ø§ÙØ£Ø³ÙØ§Ø¡ Ø¯Ø§Ø®Ù overlay ÙØ§ ØªØ·ÙØ¹ Ø¨Ø±Ø§ + ØªØµÙØ± Ø£Ø¹ÙØ¯Ø© */
.shift-staff-overlay .staff-wrap {
  width: 100%;
  margin-top: .5rem;
  max-height: calc(100% - 40px);
  overflow: auto;
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr)); /* Ø¹ÙÙØ¯ÙÙ */
  gap: 6px;
  align-content: start;
}
.shift-staff-overlay .staff-pill{
  font-size: 12px;
  padding: 4px 6px;
  border-radius: 8px;
  background: rgba(148, 163, 184, 0.12);
  border: 1px solid rgba(148, 163, 184, 0.18);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

        .sparkline-container { height: 50px; width: 100%; margin-top: 10px; opacity: 0.8; }
        .chart-box { position: relative; height: 320px; width: 100%; }
        
        #loginOverlay { position: fixed; inset: 0; background: #020617; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        #loadingOverlayData { position: fixed; inset: 0; background: rgba(2,6,23,0.9); z-index: 9000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        
        /* Interactive Matrix Table */
        .matrix-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid #334155; user-select: none; }
        .matrix-table { width: 100%; border-collapse: separate; border-spacing: 1px; min-width: 1000px; background: #0f172a; }
        .matrix-th { background: #1e293b; color: #94a3b8; padding: 8px; text-align: center; font-size: 0.7rem; width: 30px; }
        .matrix-td-name { background: #1e293b; color: white; padding: 6px 12px; font-weight: 600; min-width: 150px; position: sticky; left: 0; z-index: 10; border-right: 2px solid #334155; }
        .matrix-cell { 
            background: #0f172a; cursor: pointer; height: 36px; text-align: center; 
            transition: background 0.1s; border: 1px solid #1e293b; font-size: 0.75rem; color: #fff;
        }
        .matrix-cell:hover { border-color: white; }
        .matrix-td-action { background: #1e293b; padding: 4px; border-left: 2px solid #334155; position: sticky; right: 0; z-index: 10; width: 120px; text-align: center; }

        /* Matrix Colors */
        .cell-m { background-color: #facc15 !important; color: black !important; } /* Morning - Yellow */
        .cell-e { background-color: #60a5fa !important; color: black !important; } /* Evening - Blue */
        .cell-n { background-color: #f87171 !important; color: black !important; } /* Night - Red */
        .cell-weekend { background-color: #334155; opacity: 0.4; pointer-events: none; }
        .cell-nowork { background-color: #475569 !important; color: white !important; } /* No Work - Slate */

        /* Tool Palette */
        .tool-btn { transition: all 0.2s; border: 2px solid transparent; }
        .tool-btn.active { transform: scale(1.1); border-color: white; box-shadow: 0 0 10px rgba(255,255,255,0.3); }

        /* Email Table Styles (Hidden, used for Copy) */
        .email-table-out { width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; font-size: 12px; text-align: center; color: black; background: white; }
        .email-th { background-color: #f4b084; color: black; font-weight: bold; padding: 6px; border: 1px solid #000; }
        .email-td { border: 1px solid #000; padding: 4px; height: 20px; }
        .email-td-name { border: 1px solid #000; padding: 4px; text-align: left; font-weight: bold; background: #eee; width: 120px; }
        .email-m { background-color: #ffff00; color: black; }
        .email-e { background-color: #00b0f0; color: black; }
        .email-n { background-color: #ff0000; color: black; }

        /* Dashboard Shift Cards */
        .d-shift-card { padding: 1.5rem; border-radius: 1rem; display: flex; flex-direction: column; height: 100%; border: 1px solid rgba(255,255,255,0.1); }
        .d-morning { background: linear-gradient(135deg, rgba(234, 179, 8, 0.2), rgba(234, 179, 8, 0.05)); border-color: rgba(234, 179, 8, 0.5); }
        .d-evening { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.05)); border-color: rgba(59, 130, 246, 0.5); }
        .d-night { background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.05)); border-color: rgba(239, 68, 68, 0.5); }

        .admin-hidden, .manager-hidden, .supervisor-hidden { display: none !important; }
        .manager-access { display: block; } 
        
        .nav-tab { cursor: pointer; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.85rem; font-weight: 600; transition: all 0.2s; color: #94a3b8; }
        .nav-tab:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-tab.active { background: #4f46e5; color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3); }

        /* Quick Nav */
        /* Remove unused quick-nav dot styles */
        .quick-nav { display: none; }
        .quick-nav-dot { display: none; }

        /* Styles for the dashboard section links (under Dashboard) */
        #dashboard-links a {
            display: block;
            padding: 6px 12px;
            border-radius: 8px;
            background: #0f172a;
            color: #94a3b8;
            font-weight: 600;
            transition: background 0.2s, color 0.2s;
        }
        #dashboard-links a:hover {
            background: #4f46e5;
            color: #ffffff;
        }
        
        .section-title { font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; border-left: 3px solid; padding-left: 0.75rem; }
        .title-container { margin-bottom: 1.5rem; display: flex; align-items: center; }

        /* Icon Picker Grid */
        .icon-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; max-height: 150px; overflow-y: auto; margin-top: 10px; border: 1px solid #334155; padding: 8px; border-radius: 8px; }
        .icon-option { background: #334155; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; height: 36px; transition: all 0.2s; color: #94a3b8; }
        .icon-option:hover, .icon-option.selected { background: #6366f1; color: white; transform: scale(1.1); border: 1px solid white; }

        /* Hide delete buttons in dashboard for custom cards */
        #custom-cards-grid .fa-trash { display: none; }

        /* CSV form tab active state */
        #csv-form-tabs button.csv-tab-active { background-color: #6366f1; color: white; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- LOGIN -->
    <div id="loginOverlay">
        <div class="glass-card p-8 rounded-2xl w-96 text-center border border-dark-600">
            <div class="mb-6 flex justify-center"><div class="h-14 w-14 bg-brand-600 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-shield-alt text-2xl text-white"></i></div></div>
            <h2 class="text-xl font-bold text-white mb-2">Logistics Manager</h2>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="text" id="username" placeholder="Username" class="w-full bg-dark-900 border border-dark-600 text-white rounded-lg py-2.5 px-4 outline-none focus:border-brand-500" required>
                <input type="password" id="password" placeholder="Password" class="w-full bg-dark-900 border border-dark-600 text-white rounded-lg py-2.5 px-4 outline-none focus:border-brand-500" required>
                <button type="submit" id="loginBtn" class="w-full bg-brand-600 hover:bg-brand-500 text-white font-bold py-2.5 rounded-lg shadow-lg">Access System</button>
            </form>
            <p id="loginError" class="text-red-500 text-xs mt-4 hidden">Invalid Credentials</p>
        </div>
    </div>

    <!-- LOADING -->
    <div id="loadingOverlayData"><div class="w-16 h-16 border-4 border-dark-700 border-t-brand-500 rounded-full animate-spin mb-4"></div><p class="text-slate-400 font-mono text-sm">Syncing Data...</p></div>

    <!-- SIDEBAR -->
    <aside class="w-20 md:w-72 bg-dark-800 border-r border-dark-700 flex flex-col z-20 hidden md:flex">
        <div class="h-20 flex items-center px-6 border-b border-dark-700 bg-dark-900/50">
            <div class="h-10 w-10 bg-brand-600 rounded-lg flex items-center justify-center mr-3"><i class="fas fa-cubes text-white"></i></div>
            <div class="hidden md:block"><h1 class="text-lg font-bold text-white">Logistics Manager</h1><p class="text-[10px] text-brand-400 tracking-[0.2em] font-bold"></p></div>
        </div>
        <nav class="flex-1 overflow-y-auto py-6 space-y-1 px-3">
            <a href="#" onclick="showMainView('dashboard')" class="nav-btn bg-dark-700 text-white flex items-center px-4 py-3 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-chart-pie w-5"></i><span class="ml-3 text-sm font-bold hidden md:block">Dashboard</span></a>

            <!-- Dashboard section links with icons for quick access -->
            <div class="mt-5">
                <p class="px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 hidden md:block">Dashboard Access</p>
                <a href="#" onclick="scrollToId('shift-log-display')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-calendar-alt w-4 text-green-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Daily Shift Performance</span></a>
                <a href="#" onclick="scrollToId('overview')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-globe w-4 text-indigo-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Overview</span></a>
                <a href="#" onclick="scrollToId('storage')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-boxes w-4 text-orange-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Storage</span></a>
                <a href="#" onclick="scrollToId('quality')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-thumbs-up w-4 text-emerald-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Quality</span></a>
                <a href="#" onclick="scrollToId('inbound')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-arrow-down w-4 text-blue-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Inbound</span></a>
                <a href="#" onclick="scrollToId('outbound')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-arrow-up w-4 text-indigo-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Outbound</span></a>
                <a href="#" onclick="scrollToId('finance')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-money-bill-wave w-4 text-yellow-400"></i><span class="ml-3 text-sm font-bold hidden md:block">RSD & Finance</span></a>
                <a href="#" onclick="scrollToId('pending')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-exclamation-circle w-4 text-red-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Pending Actions</span></a>
                <a href="#" onclick="scrollToId('monthly-schedule')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-calendar w-4 text-slate-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Monthly Schedule</span></a>
                <a href="#" onclick="scrollToId('pallets-summary')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-pallet w-4 text-amber-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Pallets Inventory</span></a>
            </div>
            
            <div class="mt-6 border-t border-dark-700 pt-4">
                <!-- Removed Operations label -->
                <p class="px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 hidden md:block" style="display:none;">Operations</p>
                <!-- Hide Workforce Hub navigation link in sidebar; quick access provided in header -->
                <a href="#" onclick="showMainView('workforce')" class="nav-btn flex items-center px-4 py-3 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all" style="display:none !important;"><i class="fas fa-users-cog w-5 text-blue-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Workforce Hub</span></a>
            </div>
        </nav>
        <div class="p-6 border-t border-dark-700 bg-dark-900/30 hidden md:block footer-info">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs text-white font-bold" id="userAvatar">U</div>
                <div><p class="text-xs text-white font-bold" id="userNameDisplay">User</p><button onclick="location.reload()" class="text-[10px] text-red-400 hover:text-red-300">Logout</button></div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full bg-dark-900 relative overflow-hidden">
        <!-- HEADER -->
        <header class="h-16 bg-dark-800/80 backdrop-blur-md border-b border-dark-700 flex items-center justify-between px-8 z-30">
            <div><h2 class="text-xl font-bold text-white" id="pageTitle">Dashboard Overview</h2><p class="text-xs text-slate-400" id="lastUpdateTxt">Syncing...</p></div>
            <div class="flex items-center gap-4">
                <div id="save-indicator" class="hidden flex items-center text-green-400 text-xs font-bold mr-4"><i class="fas fa-check-circle mr-2"></i> Saved</div>
                <div class="h-6 w-px bg-dark-600 mx-2"></div>
                <select id="monthSelect" class="bg-dark-900 border border-dark-600 text-white text-xs rounded pl-3 pr-8 py-1.5 outline-none focus:border-brand-500"></select>
                <!-- Refresh Data Button -->
                <button id="refresh-btn" onclick="refreshAllData()" class="bg-green-600 hover:bg-green-500 text-white px-2 py-1 rounded text-xs font-bold flex items-center gap-1 ml-2"><i class="fas fa-sync-alt"></i></button>

                <div id="warehouse-filter" class="flex items-center gap-3 ml-4 text-xs"></div>
                <!-- Presentation Button -->
                <button id="presentation-btn" onclick="startPresentation()" class="bg-brand-600 hover:bg-brand-500 text-white px-3 py-1 rounded text-xs font-bold flex items-center gap-1 ml-2"><i class="fas fa-film"></i> Present</button>
            </div>
        </header>

        <div id="contentArea" class="flex-1 overflow-y-auto p-6 md:p-10 scroll-smooth relative">
            
            <!-- Quick Nav -->
            <div id="quickNav" class="quick-nav hidden">
                <div class="quick-nav-dot" data-label="Shift Log" onclick="scrollToId('shift-log-display')"></div>
                <div class="quick-nav-dot" data-label="Overview" onclick="scrollToId('overview')"></div>
                <div class="quick-nav-dot" data-label="Storage" onclick="scrollToId('storage')"></div>
                <div class="quick-nav-dot" data-label="Quality" onclick="scrollToId('quality')"></div>
                <div class="quick-nav-dot" data-label="Inbound" onclick="scrollToId('inbound')"></div>
                <div class="quick-nav-dot" data-label="Outbound" onclick="scrollToId('outbound')"></div>
                <div class="quick-nav-dot" data-label="RSD/Finance" onclick="scrollToId('finance')"></div>
                <div class="quick-nav-dot" data-label="Monthly Schedule" onclick="scrollToId('monthly-schedule')"></div>
            </div>

            <!-- ===== DASHBOARD ===== -->
            <div id="view-dashboard" class="main-view space-y-12 pb-20">
                <!-- FIX: Removed redundant Dashboard links to address bug (the one that shows in WF hub and disappears) -->
                
                <!-- SHIFT CARDS & LOG (Restricted to Manager/Admin) -->
                <div id="shift-log-display" class="hidden animate-fade-in mb-10 manager-access">
                    <div class="flex justify-between items-center mb-6">
                        <div class="title-container border-green-500 m-0"><h3 class="section-title text-green-400">Daily Shift Performance</h3></div>
                        <span class="bg-green-900/30 text-green-400 px-3 py-1 rounded text-xs font-mono font-bold" id="shift-log-date">--/--/----</span>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Morning -->
                        <div class="shift-card-container group">
                            <div class="d-shift-card d-morning">
                                <div class="flex justify-between items-center mb-4 border-b border-yellow-500/30 pb-2">
                                    <h4 class="text-xl font-bold text-yellow-100 flex items-center gap-2"><i class="fas fa-sun text-yellow-400"></i> Morning Shift</h4>
                                </div>
                                <div class="space-y-3 text-sm text-yellow-50/80 flex-1" id="card-stats-morning">
                                    <p class="italic opacity-50">No data loaded via Shift Log CSV</p>
                                </div>
                            </div>
                            <div class="shift-staff-overlay rounded-xl">
                                <h5 class="text-yellow-400 font-bold mb-2 uppercase text-sm tracking-wider">Staff on Duty</h5>
                                <div id="card-staff-morning" class="staff-wrap"></div>
                            </div>
                        </div>
                        <!-- Evening -->
                        <div class="shift-card-container group">
                            <div class="d-shift-card d-evening">
                                <div class="flex justify-between items-center mb-4 border-b border-blue-500/30 pb-2">
                                    <h4 class="text-xl font-bold text-blue-100 flex items-center gap-2"><i class="fas fa-moon text-blue-400"></i> Evening Shift</h4>
                                </div>
                                <div class="space-y-3 text-sm text-blue-50/80 flex-1" id="card-stats-evening">
                                    <p class="italic opacity-50">No data loaded via Shift Log CSV</p>
                                </div>
                            </div>
                            <div class="shift-staff-overlay rounded-xl">
                                <h5 class="text-blue-400 font-bold mb-2 uppercase text-sm tracking-wider">Staff on Duty</h5>
                                <div id="card-staff-evening" class="staff-wrap"></div>
                            </div>
                        </div>
                        <!-- Night -->
                        <div class="shift-card-container group">
                            <div class="d-shift-card d-night">
                                <div class="flex justify-between items-center mb-4 border-b border-red-500/30 pb-2">
                                    <h4 class="text-xl font-bold text-red-100 flex items-center gap-2"><i class="fas fa-star text-red-400"></i> Night Shift</h4>
                                </div>
                                <div class="space-y-3 text-sm text-red-50/80 flex-1" id="card-stats-night">
                                    <p class="italic opacity-50">No data loaded via Shift Log CSV</p>
                                </div>
                            </div>
                            <div class="shift-staff-overlay rounded-xl">
                                <h5 class="text-red-400 font-bold mb-2 uppercase text-sm tracking-wider">Staff on Duty</h5>
                                <div id="card-staff-night" class="staff-wrap"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Shift Trend Chart -->
                    <div class="glass-card rounded-2xl p-6 mt-6 border border-dark-700">
                        <h4 class="text-white font-bold text-sm mb-4"><i class="fas fa-chart-line text-brand-400 mr-2"></i>Shift Performance Trend (Last 7 Days)</h4>
                        <div class="h-64 w-full">
                            <canvas id="chart-shift-trend"></canvas>
                        </div>
                    </div>
                </div>

                <div id="custom-cards-grid" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 hidden"></div>
                
                <!-- SECTIONS -->
                <section id="overview" class="animate-fade-in"><div class="title-container border-brand-500"><h3 class="section-title text-brand-400">Overview</h3></div><div class="grid grid-cols-3 gap-6 mb-8" id="row-orders"></div><div class="grid grid-cols-3 gap-6 mb-8" id="row-returns"></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-10"><div class="glass-card rounded-2xl p-8"><div class="flex justify-between items-center mb-6"><h4 class="text-white font-bold text-lg">Orders Trend</h4></div><div class="chart-box"><canvas id="chart-orders-trend"></canvas></div></div><div class="glass-card rounded-2xl p-8"><div class="flex justify-between items-center mb-6"><h4 class="text-white font-bold text-lg">Market Share</h4></div><div class="chart-box"><canvas id="chart-orders-dist"></canvas></div></div></div></section>
                
                <!-- STORAGE SECTION -->
                <section id="storage" class="animate-fade-in"><div class="title-container border-orange-500"><h3 class="section-title text-orange-400">Storage Capacity & Utilization</h3></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="storage-grid"></div></section>

                <section id="quality" class="animate-fade-in"><div class="title-container border-emerald-500"><h3 class="section-title text-emerald-400">Quality</h3></div><div class="grid grid-cols-3 gap-6 mb-8" id="quality-grid"></div><div class="glass-card rounded-2xl p-8 mt-10"><h4 class="text-white font-bold text-lg mb-6">Comparative Quality</h4><div class="chart-box"><canvas id="chart-quality-comp"></canvas></div></div></section>
                <section id="inbound" class="animate-fade-in"><div class="title-container border-blue-500"><h3 class="section-title text-blue-400">Inbound</h3></div><div class="grid grid-cols-3 gap-5 mb-6" id="inbound-cases-grid"></div><div class="grid grid-cols-3 gap-5 mb-6" id="inbound-pallets-grid"></div><div class="grid grid-cols-3 gap-5 mb-6" id="inbound-trucks-grid"></div><div class="grid grid-cols-2 gap-6 mt-8"><div class="glass-card rounded-2xl p-8 chart-box"><canvas id="chart-inbound-vol"></canvas></div><div class="glass-card rounded-2xl p-8 chart-box"><canvas id="chart-inbound-trucks"></canvas></div></div></section>
                <section id="outbound" class="animate-fade-in">
                    <div class="title-container border-indigo-500"><h3 class="section-title text-indigo-400">Outbound</h3></div>
                    <div class="grid grid-cols-3 gap-5 mb-6" id="outbound-cases-grid"></div>
                    <div class="grid grid-cols-3 gap-5 mb-6" id="outbound-pallets-grid"></div>
                    <div class="grid grid-cols-3 gap-5 mb-6" id="outbound-trucks-grid"></div>
                    <!-- New grids for dedicated truck metrics -->
                    <div class="grid grid-cols-3 gap-5 mb-6" id="outbound-10ton-grid"></div>
                    <div class="grid grid-cols-3 gap-5 mb-6" id="outbound-20ton-grid"></div>
                    <div class="grid grid-cols-2 gap-6 mt-8">
                        <div class="glass-card rounded-2xl p-8 chart-box"><canvas id="chart-outbound-vol"></canvas></div>
                        <div class="glass-card rounded-2xl p-8 chart-box"><canvas id="chart-outbound-trucks"></canvas></div>
                    </div>
                    <!-- Comparative charts for PROCEED vs DSV metrics -->
                    <div class="grid grid-cols-2 gap-6 mt-8">
                        <div class="glass-card rounded-2xl p-8 chart-box">
                            <h5 class="text-slate-300 text-sm font-bold mb-2">Total Trips Comparison</h5>
                            <canvas id="chart-outbound-trips-comp"></canvas>
                        </div>
                        <div class="glass-card rounded-2xl p-8 chart-box">
                            <h5 class="text-slate-300 text-sm font-bold mb-2">Total Destinations Comparison</h5>
                            <canvas id="chart-outbound-dest-comp"></canvas>
                        </div>
                    </div>
                </section>
                
                <section id="finance" class="animate-fade-in">
                    <div class="title-container border-yellow-500"><h3 class="section-title text-yellow-400">Stock Reconciliation</h3></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="rsd-grid"></div>
                    <!-- SAP vs RSD chart removed as per request -->
                </section>
                <section id="pending" class="animate-fade-in mt-16 mb-8"><div class="title-container border-red-600"><h3 class="section-title text-red-500">Pending Actions</h3></div><div class="grid grid-cols-3 gap-6 mb-8" id="pod-pending-grid"></div><div class="grid grid-cols-3 gap-6 mb-8" id="return-pending-grid"></div></section>
            
                <!-- MONTHLY SCHEDULE SNAPSHOT (Restricted) -->
                <section id="monthly-schedule" class="animate-fade-in mt-12 mb-8 manager-access hidden">
                    <div class="title-container border-slate-500"><h3 class="section-title text-slate-400"><i class="far fa-calendar-alt mr-2"></i> Monthly Schedule Snapshot</h3></div>
                    <div id="dashboard-monthly-preview" class="w-full">
                        <!-- Populated via JS -->
                    </div>
                </section>

                <!-- Pallets Inventory Summary -->
                <section id="pallets-summary" class="animate-fade-in mb-8">
                    <div class="title-container border-amber-500"><h3 class="section-title text-amber-400">Pallets Inventory</h3></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-card rounded-2xl p-6 border-l-4 border-amber-500 flex justify-between items-center">
                            <div>
                                <h4 class="text-slate-400 text-xs font-bold uppercase mb-1">Euro Pallets</h4>
                                <span id="pallets-euro-count" class="text-3xl font-bold text-white num-font">0</span>
                            </div>
                        </div>
                        <div class="glass-card rounded-2xl p-6 border-l-4 border-amber-500 flex justify-between items-center">
                            <div>
                                <h4 class="text-slate-400 text-xs font-bold uppercase mb-1">Used Pallets</h4>
                                <span id="pallets-used-count" class="text-3xl font-bold text-white num-font">0</span>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- ===== WORKFORCE HUB ===== -->
            <div id="view-workforce" class="main-view hidden animate-fade-in h-full flex flex-col">
                <div class="flex justify-between items-center border-b border-dark-700 pb-2 mb-6">
                    <div class="flex gap-2 overflow-x-auto">
                        <button onclick="switchAdminTab('roster')" class="nav-tab active" id="tab-roster">Live Operations</button>
                        <button onclick="switchAdminTab('planner')" class="nav-tab ops-access" id="tab-planner">Shift Planner</button>
                        <button onclick="switchAdminTab('overtime')" class="nav-tab ops-access" id="tab-overtime">Weekend & OT</button>
                        <button onclick="switchAdminTab('data')" class="nav-tab admin-only" id="tab-data">Uploads & Metrics</button>
                        <button onclick="switchAdminTab('staff')" class="nav-tab ops-access" id="tab-staff">Staff Directory</button>
                        <!-- Additional tabs -->
                        <button onclick="switchAdminTab('incidents')" class="nav-tab" id="tab-incidents">Incidents</button>
                        <button onclick="switchAdminTab('pallets')" class="nav-tab ops-access" id="tab-pallets">Pallets</button>
                        <button onclick="switchAdminTab('manager')" class="nav-tab manager-access" id="tab-manager">Manager Report</button>
                        <button onclick="switchAdminTab('shiftlogs')" class="nav-tab admin-only" id="tab-shiftlogs">Shift Logs</button>
                        <button onclick="switchAdminTab('permissions')" class="nav-tab admin-only" id="tab-permissions">Permissions</button>
                        <button onclick="switchAdminTab('presentation')" class="nav-tab admin-only" id="tab-presentation">Presentation Config</button>
                    </div>
                </div>

                <div id="subview-roster" class="sub-view flex-1 flex flex-col space-y-8">
                      <div id="ot-leaderboard-section" class="glass-card p-6 rounded-xl border-t-4 border-purple-500 manager-access">
                        <h4 class="text-white font-bold mb-4 flex items-center gap-2"><i class="fas fa-trophy text-purple-400"></i> Monthly OT Leaderboard</h4>
						<div class="flex items-center gap-2">
  <input
    type="month"
    id="otLeaderboardMonth"
    class="bg-dark-800 border border-dark-600 text-white rounded px-3 py-2 text-sm"
    onchange="renderManagerLeaderboard()"
  >
</div>
                        <div class="overflow-hidden rounded-lg border border-dark-700">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-dark-800 text-slate-400"><tr><th class="p-3">Rank</th><th class="p-3">Name</th><th class="p-3 text-right">Hours</th></tr></thead>
                                <tbody id="mgr-leaderboard" class="text-slate-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="subview-planner" class="sub-view hidden h-full flex flex-col">
                    <div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-4 mb-4">
                        <div class="flex items-center gap-3">
                            <div><label class="block text-xs text-slate-400 mb-1">Year</label><input type="number" id="plannerYear" class="bg-dark-800 border border-dark-600 rounded px-2 py-1 text-white w-20" onchange="initPlannerMatrix()"></div>
                            <div><label class="block text-xs text-slate-400 mb-1">Month</label><select id="plannerMonth" class="bg-dark-800 border border-dark-600 rounded px-2 py-1 text-white w-32" onchange="initPlannerMatrix()"><option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option><option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option><option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option></select></div>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="copyTableToClipboard('planner-matrix')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded text-xs font-bold shadow-lg flex items-center gap-2"><i class="fas fa-envelope"></i> Copy for Email</button>
                             <button onclick="exportPlannerExcel()" class="bg-green-700 hover:bg-green-600 text-white px-4 py-2 rounded text-xs font-bold shadow-lg flex items-center gap-2"><i class="fas fa-file-csv"></i> Export CSV</button>
                             <button onclick="savePlanner()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded text-xs font-bold shadow-lg flex items-center gap-2 admin-only"><i class="fas fa-save"></i> Save Schedule</button>
                        </div>
                    </div>
                    <div class="flex gap-4 mb-4 bg-dark-800/50 p-2 rounded-lg border border-dark-700 admin-only">
                        <span class="text-xs text-slate-400 self-center mr-2 uppercase font-bold">Paint Tools:</span>
                        <button onclick="setTool('morning')" class="tool-btn w-8 h-8 rounded bg-yellow-400 flex items-center justify-center text-black text-xs font-bold" title="Morning">1st</button>
                        <button onclick="setTool('evening')" class="tool-btn w-8 h-8 rounded bg-blue-400 flex items-center justify-center text-black text-xs font-bold" title="Evening">2nd</button>
                        <button onclick="setTool('night')" class="tool-btn w-8 h-8 rounded bg-red-400 flex items-center justify-center text-black text-xs font-bold" title="Night">3rd</button>
                        <button onclick="setTool('nowork')" class="tool-btn w-8 h-8 rounded bg-slate-500 flex items-center justify-center text-white text-xs font-bold" title="No Work">NW</button>
                        <button onclick="setTool('clear')" class="tool-btn w-8 h-8 rounded bg-dark-600 border border-slate-500 flex items-center justify-center text-white text-xs" title="Clear"><i class="fas fa-eraser"></i></button>
                        <span class="text-xs text-slate-500 self-center ml-auto">Click & Drag to paint. Use <b>Actions</b> column to fill month.</span>
                    </div>
                    <div class="matrix-wrapper flex-1 custom-scrollbar"><table class="matrix-table" id="planner-matrix"></table></div>
                </div>

                <div id="subview-overtime" class="sub-view hidden h-full">
                    <div class="flex flex-col lg:flex-row gap-6 h-full">
                         <div class="glass-card p-6 rounded-xl border-t-4 border-orange-500 lg:w-1/3 shrink-0">
                            <h3 class="text-white font-bold mb-4">Add Weekend / OT</h3>
                            <div class="space-y-3">
                                <select id="otEmpSelect" class="w-full bg-dark-900 border border-dark-600 text-white rounded px-3 py-2 text-sm"></select>
                                <div class="flex gap-2">
                                    <!-- Changed date input to dedicated date picker for single date selection -->
                                    <input type="date" id="otDate" class="w-full bg-dark-900 border border-dark-600 text-white rounded px-3 py-2 text-sm">
                                    <button onclick="addNoWork()" class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded font-bold text-sm shrink-0 admin-only">No Work</button>
                                </div>
                                <div class="flex gap-2">
                                  <input type="time" id="otTimeFrom" class="w-full bg-dark-900 border border-dark-600 text-white rounded px-2 py-2 text-sm" placeholder="From">
                                  <input type="time" id="otTimeTo" class="w-full bg-dark-900 border border-dark-600 text-white rounded px-2 py-2 text-sm" placeholder="To">
                                </div>
                                
                                <input type="text" id="otTask" class="w-full bg-dark-900 border border-dark-600 text-white rounded px-3 py-2 text-sm" placeholder="Task (optional)">
                                
                                <div class="flex gap-2">
                                  <button onclick="addOvertime()" class="w-full bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded font-bold">Add Overtime</button>
								  <button onclick="finalizeWeekendSession()" class="w-full bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded font-bold">Save Weekly Table</button>
								</div>
                            </div>
                        </div>
                        <div class="glass-card p-6 rounded-xl border-t-4 border-brand-500 flex-1 min-h-[300px]">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-white font-bold">Current Weekend Schedule</h3>
                                <div class="flex gap-2">
                                </div>
                            </div>
                            <div id="ot-content-current" class="ot-content-view">
<div class="flex gap-4 items-start">
  <div class="flex-1 overflow-x-auto text-black bg-white p-4 rounded-lg" id="weekend-table-preview"></div>
  <!-- ÙÙÙÙ Ø§ÙØ¬Ø¯ÙÙ: Ø³Ø¬Ù/ÙÙÙ -->
  <div class="w-[340px] max-w-[340px] bg-dark-900/50 p-4 rounded-lg" id="weekend-log-container"></div>
</div>
                                <button onclick="copyTableToClipboard('weekend-table-preview')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded text-xs font-bold shadow-lg flex items-center gap-2 mt-4"><i class="fas fa-envelope"></i> Copy for Email</button>
                            </div>
                            <!-- New History Log View -->
                            <div id="ot-content-history-log" class="ot-content-view hidden">
                                <div id="ot-history-log-table" class="overflow-x-auto bg-dark-900/50 p-4 rounded-lg">
                                    <!-- Rendered via JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="subview-data" class="sub-view hidden h-full space-y-8 admin-only">
                    <!-- Manual Metrics Editor removed; data will be managed through the master JSON file -->

                    <div class="glass-card p-8 rounded-xl border-l-4 border-indigo-500">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-white mb-1">Master JSON Editor</h3>
                                <p class="text-xs text-slate-400">Edit general metrics in <b>WHSdata.json</b>.</p>
                            </div>
                            <div class="flex gap-2">
                                <!-- Hidden file input for CSV import -->
                                <input type="file" id="import-csv-file" accept=".csv" class="hidden" onchange="importDatasetCSV(this)">
                                <button onclick="document.getElementById('import-csv-file').click()" class="bg-green-700 hover:bg-green-600 text-white px-3 py-2 rounded font-bold shadow-lg text-sm flex items-center"><i class="fas fa-file-csv mr-2"></i> Import CSV</button>
                                <button onclick="saveCSV()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-2 rounded font-bold shadow-lg flex items-center text-sm"><i class="fas fa-save mr-2"></i> Save Changes</button>
                            </div>
                        </div>

                        <div class="overflow-auto max-h-96 border border-dark-600 rounded bg-dark-900 custom-scrollbar"><table class="w-full text-xs text-left" id="csv-editor-table"></table></div>
                    </div>

                    <!-- Add New Record Form -->
                    <div class="glass-card p-8 rounded-xl border-l-4 border-green-500">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-white mb-1">Add New Record</h3>
                            <button onclick="addCSVRow()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded font-bold shadow-lg text-sm"><i class="fas fa-plus mr-2"></i> Add Row</button>
                        </div>
                        <p class="text-xs text-slate-400 mb-4">Populate each field to append a new row to the dataset. All values will be saved to <b>WHSdata.json</b>.</p>
                        <!-- Tabs for organizing the record form -->
                        <div id="csv-form-tabs" class="flex flex-wrap gap-2 mb-4"></div>
                        <!-- Container for tabbed form sections -->
                        <div id="csv-form-contents"></div>
                    </div>

                    <div class="glass-card p-8 rounded-xl border-l-4 border-green-500">
                        <h3 class="text-xl font-bold text-white mb-4">Upload Daily Shift Log</h3>
                        <label class="inline-block bg-green-600 hover:bg-green-500 text-white border border-green-500 px-6 py-3 rounded-lg font-bold cursor-pointer transition-colors shadow-lg"><i class="fas fa-file-csv mr-2"></i> Select CSV File<input type="file" onchange="handleShiftLogUpload(this)" class="hidden" accept=".csv"></label>
                    </div>
                    
                    <div class="glass-card p-8 rounded-xl border-l-4 border-brand-500">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-white font-bold text-xl">Add Custom Metric Card</h3>
                            <button onclick="openAddCardModal()" class="bg-brand-600 text-white px-3 py-1.5 rounded text-xs font-bold">Add New</button>
                        </div>
                        <div id="custom-metric-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>
                </div>

                <div id="subview-staff" class="sub-view hidden h-full">
                    <div class="flex justify-between items-center mb-4 ops-access"><h3 class="text-white font-bold">Staff Directory</h3><button onclick="addNewEmployee()" class="bg-brand-600 text-white px-4 py-2 rounded text-xs font-bold admin-only">+ New Employee</button></div>
                    <div class="glass-card rounded-xl overflow-hidden"><table class="w-full text-left"><thead class="bg-dark-800 text-slate-400 text-xs uppercase"><tr><th class="p-4">Name</th><th class="p-4 text-center admin-only">Actions</th></tr></thead><tbody id="emp-table-body" class="text-slate-300 text-sm divide-y divide-dark-700"></tbody></table></div>
                </div>
                <!-- Incidents Report Subview -->
                <div id="subview-incidents" class="sub-view hidden h-full flex flex-col gap-6">
                    <div class="glass-card p-6 rounded-xl border-t-4 border-red-500">
                        <h3 class="text-white font-bold text-lg mb-4 flex items-center gap-2"><i class="fas fa-exclamation-triangle text-red-400"></i> Damaged Product Report</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="text-xs text-slate-400 uppercase mb-1 block">Product</label>
                                <input type="text" id="damage-product" class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm" placeholder="Product name">
                            </div>
                            <div>
                                <label class="text-xs text-slate-400 uppercase mb-1 block">Batch</label>
                                <input type="text" id="damage-batch" class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm" placeholder="Batch number">
                            </div>
                            <div>
                                <label class="text-xs text-slate-400 uppercase mb-1 block">Quantity</label>
                                <input type="number" id="damage-qty" class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm" placeholder="Quantity">
                            </div>
                        </div>
                        <label class="text-xs text-slate-400 uppercase mb-1 block">Notes</label>
                        <textarea id="damage-notes" rows="3" class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm mb-4" placeholder="Additional details"></textarea>
                        <label class="text-xs text-slate-400 uppercase mb-1 block">Upload Photo</label>
                        <input type="file" id="damage-image" accept="image/*" class="mb-4 text-sm">
                        <button onclick="submitDamageReport()" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded font-bold shadow-lg">Submit Report</button>
                    </div>
                </div>

                <!-- Pallets Management Subview -->
                <div id="subview-pallets" class="sub-view hidden h-full flex flex-col gap-6">
                    <div class="glass-card p-6 rounded-xl border-t-4 border-amber-500">
                        <div class="flex gap-4 mb-4 border-b border-dark-700">
                            <button onclick="switchPalletsTab('open')" id="pallets-tab-open" class="nav-tab active">Open POs</button>
                            <button onclick="switchPalletsTab('history')" id="pallets-tab-history" class="nav-tab">History</button>
                        </div>

                        <!-- Open POs Tab -->
                        <div id="pallets-view-open" class="pallets-view">
                            <h3 class="text-white font-bold text-lg mb-4 flex items-center gap-2"><i class="fas fa-boxes text-amber-400"></i> Pallets Inventory</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="text-xs text-slate-400 uppercase mb-1 block">PO Number</label>
                                    <input type="text" id="po-number" class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm" placeholder="PO#">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-400 uppercase mb-1 block">Type</label>
                                    <select id="po-type" class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm">
                                        <option value="euro">Euro</option>
                                        <option value="used">Used</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs text-slate-400 uppercase mb-1 block">Quantity</label>
                                    <input type="number" id="po-qty" class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm" placeholder="Qty">
                                </div>
                            </div>
                            <button onclick="addPO()" class="bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded font-bold shadow-lg mb-6">Add PO</button>
                            <div class="mb-4">
                                <input type="text" id="pallets-search-open" placeholder="Search PO..." class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm" oninput="renderPalletsTable();">
                            </div>
                            <div class="glass-card p-4 rounded-lg border border-dark-700 overflow-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-dark-800 text-slate-400">
                                        <tr>
                                            <th class="p-3">PO Number</th>
                                            <th class="p-3">Type</th>
                                            <th class="p-3 text-right">Qty</th>
                                            <th class="p-3 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pallets-table-body" class="text-slate-200"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- History Tab -->
                        <div id="pallets-view-history" class="pallets-view hidden">
                            <h3 class="text-white font-bold text-lg mb-4 flex items-center gap-2"><i class="fas fa-history text-amber-400"></i> Closed PO History</h3>
                            <div class="mb-4">
                                <input type="text" id="pallets-search-history" placeholder="Search Closed PO..." class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm" oninput="renderPalletsHistoryTable();">
                            </div>
                            <div class="glass-card p-4 rounded-lg border border-dark-700 overflow-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-dark-800 text-slate-400">
                                        <tr>
                                            <th class="p-3">PO Number</th>
                                            <th class="p-3">Type</th>
                                            <th class="p-3">Total Used</th>
                                            <th class="p-3 text-center">Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pallets-history-body" class="text-slate-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manager Report Subview -->
                <div id="subview-manager" class="sub-view hidden h-full flex flex-col gap-6">
                    <h3 class="text-white font-bold text-lg mb-4">Incident Reports</h3>
                    <div class="glass-card p-6 rounded-xl overflow-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-dark-800 text-slate-400">
                                <tr>
                                    <th class="p-3">Date</th>
                                    <th class="p-3">Product</th>
                                    <th class="p-3">Batch</th>
                                    <th class="p-3 text-right">Qty</th>
                                    <th class="p-3">Image</th>
                                    <th class="p-3 text-center">View Details</th>
                                </tr>
                            </thead>
                            <tbody id="incident-table-body" class="text-slate-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Shift Logs Subview (Admin Only) -->
                <div id="subview-shiftlogs" class="sub-view hidden h-full admin-only flex flex-col gap-6">
                    <div class="glass-card p-6 rounded-xl border-t-4 border-blue-500">
                        <h3 class="text-white font-bold text-lg mb-4 flex items-center gap-2"><i class="fas fa-calendar-day text-blue-400"></i> Shift Log Editor</h3>
                        <p class="text-xs text-slate-400 mb-4">Add or remove shift log records manually.</p>
                        <div class="flex flex-wrap gap-2 mb-4">
                            <input type="date" id="shiftlog-date" class="bg-dark-800 border border-dark-600 text-white rounded p-2 text-sm">
                            <select id="shiftlog-shift" class="bg-dark-800 border border-dark-600 text-white rounded p-2 text-sm">
                                <option value="morning">Morning</option>
                                <option value="evening">Evening</option>
                                <option value="night">Night</option>
                            </select>
                            <input type="number" id="shiftlog-pallets" placeholder="Rec" class="bg-dark-800 border border-dark-600 text-white rounded p-2 w-24 text-sm">
                            <input type="number" id="shiftlog-palletsDisp" placeholder="Disp" class="bg-dark-800 border border-dark-600 text-white rounded p-2 w-24 text-sm">
                            <input type="number" id="shiftlog-plan" placeholder="Plan" class="bg-dark-800 border border-dark-600 text-white rounded p-2 w-24 text-sm">
                            <input type="number" id="shiftlog-act" placeholder="Act" class="bg-dark-800 border border-dark-600 text-white rounded p-2 w-24 text-sm">
                            <button onclick="addShiftLogRecord()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded font-bold text-xs">Add</button>
                        </div>
                        <div class="overflow-x-auto">
                        <!-- Shift log table now includes Plan and Act columns -->
                        <table class="w-full text-left text-xs mb-4">
                            <thead class="bg-dark-800 text-slate-400">
                                <tr>
                                    <th class="p-2">Date</th>
                                    <th class="p-2">Shift</th>
                                    <th class="p-2">Rec</th>
                                    <th class="p-2">Disp</th>
                                    <th class="p-2">Plan</th>
                                    <th class="p-2">Act</th>
                                    <th class="p-2 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="shiftlog-table-body" class="text-slate-200"></tbody>
                        </table>
                        </div>
                    </div>
                </div>

                <!-- Permissions Management Subview (Admin Only) -->
                <div id="subview-permissions" class="sub-view hidden h-full admin-only flex flex-col gap-6">
                    <div class="glass-card p-6 rounded-xl border-t-4 border-teal-500">
                        <h3 class="text-white font-bold text-lg mb-4 flex items-center gap-2"><i class="fas fa-user-shield text-teal-400"></i> Permissions Management</h3>
                        <p class="text-xs text-slate-400 mb-4">Customize which tabs and features are visible for each user role. Unchecked items will be hidden for the selected role.</p>
                        <div id="permissions-form" class="overflow-auto mb-4"></div>
                        <button onclick="savePermissions()" class="bg-teal-600 hover:bg-teal-500 text-white px-4 py-2 rounded font-bold self-start">Save Permissions</button>
                    </div>
                </div>

                <!-- Presentation Config Subview (Admin Only) -->
                <div id="subview-presentation" class="sub-view hidden h-full admin-only flex flex-col gap-6">
                    <div class="glass-card p-6 rounded-xl border-t-4 border-purple-500">
                        <h3 class="text-white font-bold text-lg mb-4 flex items-center gap-2"><i class="fas fa-slideshare text-purple-400"></i> Presentation Configuration</h3>
                        <p class="text-xs text-slate-400 mb-4">Select which dashboard sections appear in presentation mode for each role.</p>
                        <div id="presentation-form" class="overflow-auto mb-4"></div>
                        <button onclick="savePresentationConfig()" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded font-bold self-start">Save Slides</button>
                    </div>
                </div>
            </div>

        </div>
    </main>
    
    <!-- MODAL for PO History Details -->
    <div id="poHistoryModal" class="fixed inset-0 bg-dark-900/90 z-[99999] hidden items-center justify-center p-4">
        <div class="glass-card rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b border-dark-600 pb-2">
                <h3 class="text-xl font-bold text-white" id="poHistoryModalTitle">PO History Details</h3>
                <button onclick="document.getElementById('poHistoryModal').style.display='none'" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="poHistoryModalContent"></div>
        </div>
    </div>

    <!-- MODAL for Incident Details -->
    <div id="incidentDetailModal" class="fixed inset-0 bg-dark-900/90 z-[99999] hidden items-center justify-center p-4">
        <div class="glass-card rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b border-dark-600 pb-2">
                <h3 class="text-xl font-bold text-white">Incident Details</h3>
                <button onclick="document.getElementById('incidentDetailModal').style.display='none'" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="incidentDetailModalContent"></div>
        </div>
    </div>


    <script>
        const WORKER_URL = "https://api.wf6638.workers.dev";
        // Warehouses list. Converted to a mutable array to support filtering.
        let WH_ORDER = ['SPIMACO', 'PROCEED', 'DSV'];
        const CHART_COLORS = { SPIMACO: '#60a5fa', PROCEED: '#34d399', DSV: '#fb923c' }; 
        const COLORS = { 'SPIMACO': 'blue', 'PROCEED': 'green', 'DSV': 'orange', 'default': 'brand' };

        let rawData = [];
        // Copy of CSV rows for editing
        let rawCSVData = [];
        let monthList = [];
        // Full chronological list of months for the dataset
        let fullMonthList = [];
        let chartInstances = {};
        let sparklineInstances = [];
        // Selected warehouses for filtering; defaults to all warehouses
        let selectedWarehouses = [...WH_ORDER];
        let sessionToken = null; 
        let currentUser = null; 
        let employees = []; 
        let shifts = {}; 
        let overtime = []; 
        let customCards = []; 
        let masterShiftLogs = {}; 
        let manualMetrics = {};
        // Arrays for damage reports and pallets inventory
        let damageReports = [];
        let pallets = [];
        let palletsClosed = [];
        // FIX: Added 'nowork' tool
        let currentTool = 'morning'; 
        let isPainting = false;

        // Permissions object for role-based UI control
        let permissions = {};

        // FIX: Added switchOvertimeTab to handle history log display
        function switchOvertimeTab(viewId) {
            document.querySelectorAll('.ot-content-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(`ot-content-${viewId}`)?.classList.remove('hidden');

            if (viewId === 'history-log') {
                renderOvertimeHistoryLog();
            } else if (viewId === 'current') {
                renderWeekendTable();
            }
        }

        // FIX: Renders the full overtime history log
        function renderOvertimeHistoryLog() {
            const container = document.getElementById('ot-history-log-table');
            if (!container) return;

            const otHistory = overtime.filter(o => o.type === 'overtime');
            
            // Group and calculate total OT hours per employee
            const totals = {};
            otHistory.forEach(o => {
                totals[o.name] = (totals[o.name] || 0) + o.hours;
            });

            const sortedTotals = Object.entries(totals).sort(([, a], [, b]) => b - a);

            let html = '<h4 class="text-white font-bold text-lg mb-4">Total Overtime Hours (Since Start)</h4>';
            html += '<div class="overflow-hidden rounded-lg border border-dark-700">';
            html += '<table class="w-full text-left text-sm">';
            html += '<thead class="bg-dark-800 text-slate-400"><tr><th class="p-3">Employee</th><th class="p-3 text-right">Total Hours</th></tr></thead>';
            html += '<tbody class="text-slate-200">';
            
            if (sortedTotals.length === 0) {
                html += '<tr><td colspan="2" class="p-3 text-center text-slate-500">No overtime records found.</td></tr>';
            } else {
                sortedTotals.forEach(([name, hours]) => {
                    html += `<tr><td class="p-3">${name}</td><td class="p-3 text-right font-mono">${hours.toFixed(1)}</td></tr>`;
                });
            }
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        async function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value.trim(); const p = document.getElementById('password').value.trim();
            const btn = document.getElementById('loginBtn'); btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
            try {
                const response = await fetch(`${WORKER_URL}/api/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: u, password: p }) });
                if (response.ok) {
                    const data = await response.json(); 
                    sessionToken = 'mock-token';
                    currentUser = { username: u, role: data.role || 'guest' };
                    document.getElementById('userNameDisplay').textContent = u;
                    document.getElementById('userAvatar').textContent = u.charAt(0).toUpperCase();
                    // Load permissions before applying role UI so restrictions take effect immediately
                    await loadPermissions();
                    applyRoleUI(currentUser.role);
                    // Show loading overlay while syncing data
                    document.getElementById('loadingOverlayData').style.display = 'flex';
                    // Sequentially load workforce and main data before hiding login overlay
                    await refreshData();
                    await backgroundRefresh();
                    // Hide loading and login overlays after data loaded
                    document.getElementById('loadingOverlayData').style.display = 'none';
                    document.getElementById('loginOverlay').style.display = 'none';
                    // FIX: Ensure correct default view/tab is loaded
                    if (permissions && permissions[currentUser.role]) {
                        const perms = permissions[currentUser.role];
                        const coreTabs = ['roster','planner','overtime','data','staff','incidents','pallets','manager','shiftlogs','permissions','presentation'];
                        
                        if (perms.dashboard !== false) {
                            // Dashboard is allowed, show dashboard view, run render()
                            showMainView('dashboard');
                        } else if (perms.workforce !== false) {
                            // Dashboard denied, Workforce allowed, navigate to first allowed Workforce tab
                            showMainView('workforce');
                            let firstTab = null;
                            coreTabs.forEach(t => {
                                if (!firstTab && perms[t] !== false) firstTab = t;
                            });
                            if (firstTab) {
                                // Delay switching tab slightly to allow view to render
                                setTimeout(() => { switchAdminTab(firstTab); }, 100);
                            }
                        }
                    } else {
                         // Default case if permissions object is not loaded or role is missing
                        showMainView('dashboard');
                    }
                    
                    // Start periodic background refresh every 5 minutes to keep data up to date without disrupting UI
                    setInterval(() => {
                        backgroundRefresh();
                    }, 300000);
                } else { 
                    document.getElementById('loginError').classList.remove('hidden');
                    btn.innerHTML = 'Access System';
                }
            } catch (error) { 
                console.error(error); 
                document.getElementById('loginError').classList.remove('hidden'); 
                btn.innerHTML = 'Access System';
            } 
        }

        function applyRoleUI(role) {
            // Hide or show elements based on built-in classes (admin-only/manager-access/ops-access)
            document.querySelectorAll('.admin-only').forEach(el => {
                if (role === 'admin') el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
            document.querySelectorAll('.manager-access').forEach(el => {
                if (role === 'admin' || role === 'manager') el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
            document.querySelectorAll('.ops-access').forEach(el => {
                if (role === 'admin' || role === 'manager') el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
            // If permissions are loaded, further restrict tab visibility
            if (permissions && permissions[role]) {
                const feats = ['roster','planner','overtime','data','staff','incidents','pallets','manager','shiftlogs','permissions','presentation']; 
                feats.forEach(f => {
                    const tab = document.getElementById('tab-' + f);
                    if (tab) {
                        if (permissions[role][f] === false) tab.classList.add('hidden');
                        else tab.classList.remove('hidden');
                    }
                });
                // Additionally hide or show specific dashboard sections/cards based on permissions.cards
                {
                    // master list of section IDs used on the dashboard
                    const allSections = [
                        'shift-log-display',
                        'overview',
                        'storage',
                        'quality',
                        'inbound',
                        'outbound',
                        'finance',
                        'pending',
                        'monthly-schedule',
                        'pallets-summary',
                        'custom-cards-grid',
                        'ot-leaderboard-section'
                    ];
                    const cardPerms = permissions[role].cards || {};
                    allSections.forEach(secId => {
                        const secEl = document.getElementById(secId);
                        if (!secEl) return;
                        // CHANGED: Logic updated to only hide if explicitly false. 
                        // If undefined, it remains visible (matching default permissive behavior).
                        if (cardPerms[secId] !== false) {
                            secEl.classList.remove('hidden');
                        } else {
                            secEl.classList.add('hidden');
                        }
                    });
                    // update sidebar quick nav links visibility
                    document.querySelectorAll('nav a[onclick^="scrollToId("]').forEach(link => {
                        const onclick = link.getAttribute('onclick');
                        const match = /scrollToId\(['"]([^'"]+)['"]\)/.exec(onclick);
                        if (match) {
                            const sectionId = match[1];
                            if (cardPerms[sectionId] !== false) {
                                link.classList.remove('hidden');
                            } else {
                                link.classList.add('hidden');
                            }
                        }
                    });
                }

                // Hide or show entire dashboard or workforce hub based on permissions (new feature)
                const dashboardPerm = permissions[role].dashboard;
                const workforcePerm = permissions[role].workforce;
                const dashView = document.getElementById('view-dashboard');
                const wfView = document.getElementById('view-workforce');
                const dashLink = document.querySelector('a[onclick*="showMainView(\'dashboard\')"]') || null;
                const wfLink = document.querySelector('a[onclick*="showMainView(\'workforce\')"]') || null;
                
                if (dashView) {
                    if (dashboardPerm === false) dashView.classList.add('hidden');
                    else dashView.classList.remove('hidden');
                }
                if (wfView) {
                    if (workforcePerm === false) wfView.classList.add('hidden');
                    else wfView.classList.remove('hidden');
                }
                // Also hide navigation links if present
                if (dashLink) {
                    if (dashboardPerm === false) dashLink.classList.add('hidden');
                    else dashLink.classList.remove('hidden');
                }
                if (wfLink) {
                    if (workforcePerm === false) wfLink.style.display = 'none'; // Workforce link is style="display:none !important;" by default in HTML
                    else wfLink.style.display = 'flex'; // Change to flex when allowed
                }

                // Hide or show the main navigation item for Dashboard on the sidebar
                const sidebarDashLink = document.querySelector('nav .nav-btn[onclick*="showMainView(\'dashboard\')"]');
                if (sidebarDashLink) {
                    if (dashboardPerm === false) sidebarDashLink.classList.add('hidden');
                    else sidebarDashLink.classList.remove('hidden');
                }
                // Hide or show the dashboard access group of section links if dashboard is hidden
                const dashboardAccessGroup = document.querySelector('nav .mt-5');
                if (dashboardAccessGroup) {
                    if (dashboardPerm === false) dashboardAccessGroup.classList.add('hidden');
                    else dashboardAccessGroup.classList.remove('hidden');
                }
            }
        }

        async function refreshData() {
            employees = await fetchGithub('employees.json');
            if (!Array.isArray(employees)) employees = [];
            shifts = await fetchGithub('shifts.json');
            if (!shifts || typeof shifts !== 'object' || Array.isArray(shifts)) shifts = {};
            overtime = await fetchGithub('overtime.json');
            if (!Array.isArray(overtime)) overtime = [];
            customCards = await fetchGithub('custom_cards.json');
            if (!Array.isArray(customCards)) customCards = [];
            masterShiftLogs = await fetchGithub('shift_logs_master.json');
            if (typeof masterShiftLogs !== 'object' || masterShiftLogs === null) masterShiftLogs = {};
            manualMetrics = await fetchGithub('manual_metrics.json');
            if (typeof manualMetrics !== 'object' || manualMetrics === null) manualMetrics = {};

            // Load damage reports, pallets and closed pallets if they exist; ensure arrays
            damageReports = await fetchGithub('damage_reports.json');
            if (!Array.isArray(damageReports)) damageReports = [];
            // Load pallets data from JSON files and ensure history array exists
            pallets = await fetchGithub('pallets.json');
            if (!Array.isArray(pallets)) {
                if (typeof pallets === 'string') {
                    try { pallets = JSON.parse(pallets); } catch (e) { pallets = []; }
                } else {
                    pallets = [];
                }
            }
            // Ensure each pallet has a history array
            pallets.forEach(p => { if (!Array.isArray(p.history)) p.history = []; });
            palletsClosed = await fetchGithub('pallets_closed.json');
            if (!Array.isArray(palletsClosed)) {
                if (typeof palletsClosed === 'string') {
                    try { palletsClosed = JSON.parse(palletsClosed); } catch (e) { palletsClosed = []; }
                } else {
                    palletsClosed = [];
                }
            }
            // Ensure each closed pallet has a history array
            palletsClosed.forEach(p => { if (!Array.isArray(p.history)) p.history = []; });
            
            const today = new Date();
            document.getElementById('plannerYear').value = today.getFullYear();
            document.getElementById('plannerMonth').value = today.getMonth() + 1;

            const sel = document.getElementById('otEmpSelect'); 
            if(sel) sel.innerHTML = '<option value="">Select...</option>' + employees.map(e => `<option value="${e.name}">${e.name}</option>`).join('');
            
            initPlannerMatrix(); renderWeekendTable(); renderEmpTable(); renderCustomCards(); renderManagerLeaderboard();
            
            const sortedDates = Object.keys(masterShiftLogs).sort((a,b)=>new Date(a)-new Date(b));
            if(sortedDates.length > 0) {
                const lastDate = sortedDates[sortedDates.length-1];
                updateDashboardShiftCards(lastDate, masterShiftLogs[lastDate]);
            }

            // Render pallets summary, history and manager reports after data refresh
            renderPalletsTable();
            renderPalletsHistoryTable();
            renderPalletsOverview();
            renderManagerReports();
        }

        // FIX: Reworked showMainView and switchAdminTab to fix display bug
        function showMainView(id) {
            document.querySelectorAll('.main-view').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('bg-dark-700', 'text-white'));
            const viewEl = document.getElementById(`view-${id}`);
            if (viewEl) viewEl.classList.remove('hidden');
            const qNav = document.getElementById('quickNav');
            if(id==='dashboard') { 
                render(); 
                qNav.classList.remove('hidden'); 
                document.getElementById('pageTitle').textContent = 'Dashboard Overview';
                // FIX: Ensure dashboard links are visible (for mobile/bug fix)
                // Removed the redundant dashboard-links div that caused the issue.
            } else { 
                qNav.classList.add('hidden'); 
                document.getElementById('pageTitle').textContent = 'Workforce Hub';
                // FIX: Ensure all subviews start hidden when switching to WF view
                document.querySelectorAll('.sub-view').forEach(el => el.classList.add('hidden'));
                // Force switch to the active/default tab (roster)
                switchAdminTab(document.querySelector('#view-workforce .nav-tab.active')?.id.replace('tab-','') || 'roster');
            }
        }

        function scrollToId(id) { const el = document.getElementById(id); if(el) { el.scrollIntoView({behavior: 'smooth', block: 'center'}); } }
        
        async function switchAdminTab(tabId) {
            // Hide all subviews and remove active status from tabs
            document.querySelectorAll('.sub-view').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            // Show selected subview and mark tab active
            const view = document.getElementById(`subview-${tabId}`);
            if (view) view.classList.remove('hidden');
            const btn = document.getElementById(`tab-${tabId}`);
            if (btn) btn.classList.add('active');
            // Additional loading for certain tabs
            if (tabId === 'shiftlogs') {
                loadShiftLogs();
            }
            if (tabId === 'permissions') {
                loadPermissions();
            }
            if (tabId === 'presentation') {
                // Render presentation form for configuring slides
                renderPresentationForm();
            }
            // FIX: Pallets tab requires special initialization
            if (tabId === 'pallets') {
                switchPalletsTab('open');
            }
            // FIX: Overtime tab requires initialization (default to current view)
            if (tabId === 'overtime') {
                switchOvertimeTab('current');
            }
        }
        // New function for Pallets sub-tab switching
        function switchPalletsTab(tabId) {
            document.querySelectorAll('.pallets-view').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('#subview-pallets .nav-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`pallets-view-${tabId}`)?.classList.remove('hidden');
            document.getElementById(`pallets-tab-${tabId}`)?.classList.add('active');
            if(tabId === 'open') {
                renderPalletsTable();
            } else if (tabId === 'history') {
                renderPalletsHistoryTable();
            }
        }


        function setTool(t) { currentTool = t; document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active')); document.querySelector(`button[onclick="setTool('${t}')"]`).classList.add('active'); }
        function initPlannerMatrix() {
            const year = document.getElementById('plannerYear').value; const month = document.getElementById('plannerMonth').value; const daysInMonth = new Date(year, month, 0).getDate(); const table = document.getElementById('planner-matrix');
            let html = `<thead><tr><th class="matrix-th" style="width:150px; left:0; z-index:20;">EMPLOYEE</th>`;
            for(let i=1; i<=daysInMonth; i++) { const d = new Date(year, month-1, i); const isWeekend = d.getDay()===5 || d.getDay()===6; html += `<th class="matrix-th ${isWeekend?'text-orange-400':''}">${i}<br><span class="text-[9px]">${d.toLocaleDateString('en-US',{weekday:'narrow'})}</span></th>`; }
            
            // Only add Actions column for Admin
            const actionHeader = (currentUser && currentUser.role === 'admin') ? `<th class="matrix-th" style="right:0; z-index:20; width:120px;">Actions</th>` : '';
            html += `${actionHeader}</tr></thead><tbody onmouseleave="isPainting=false">`;
            
            employees.forEach(emp => { 
                html += `<tr><td class="matrix-td-name">${emp.name}</td>`; 
                for(let i=1; i<=daysInMonth; i++) { 
                    const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(i).padStart(2,'0')}`; const dObj = new Date(year, month-1, i); const isWeekend = dObj.getDay()===5 || dObj.getDay()===6; let cls = isWeekend ? 'cell-weekend' : ''; let char = ''; 
                    if(shifts[dateStr]) {
                        if(shifts[dateStr].morning && shifts[dateStr].morning.includes(emp.name)) {
                            cls = 'cell-m';
                            char = '1st';
                        } else if(shifts[dateStr].evening && shifts[dateStr].evening.includes(emp.name)) {
                            cls = 'cell-e';
                            char = '2nd';
                        } else if(shifts[dateStr].night && shifts[dateStr].night.includes(emp.name)) {
                            cls = 'cell-n';
                            char = '3rd';
                        } else if(shifts[dateStr].nowork && shifts[dateStr].nowork.includes(emp.name)) {
                            // FIX: Added nowork class/char
                            cls = 'cell-nowork';
                            char = 'NW';
                        }
                    }
                    // Interaction only for Admin
                    const interactions = (currentUser && currentUser.role === 'admin') ? `onmousedown="startPaint(this)" onmouseover="paint(this)" onmouseup="stopPaint()"` : '';
                    html += `<td class="matrix-cell ${cls}" data-date="${dateStr}" data-emp="${emp.name}" data-weekend="${isWeekend}" ${interactions}>${char}</td>`; 
                } 
                if(currentUser && currentUser.role === 'admin') {
                    html += `<td class="matrix-td-action"><div class="flex gap-1 justify-center">
                        <button onclick="fillMonth('${emp.name}', 'morning')" class="text-[10px] bg-yellow-400 text-black w-5 h-5 rounded font-bold hover:scale-110" title="Fill Morning">1st</button>
                        <button onclick="fillMonth('${emp.name}', 'evening')" class="text-[10px] bg-blue-400 text-black w-5 h-5 rounded font-bold hover:scale-110" title="Fill Evening">2nd</button>
                        <button onclick="fillMonth('${emp.name}', 'night')" class="text-[10px] bg-red-400 text-black w-5 h-5 rounded font-bold hover:scale-110" title="Fill Night">3rd</button>
                        <button onclick="fillMonth('${emp.name}', 'nowork')" class="text-[10px] bg-slate-500 text-white w-5 h-5 rounded font-bold hover:scale-110" title="Fill No Work">NW</button>
                        <button onclick="fillMonth('${emp.name}', 'clear')" class="text-[10px] bg-slate-600 text-white w-5 h-5 rounded font-bold hover:scale-110" title="Clear Month"><i class="fas fa-times"></i></button>
                    </div></td>`;
                }
                html += `</tr>`; 
            });
            table.innerHTML = html + `</tbody>`;
        }
        function startPaint(cell) { if(currentUser.role !== 'admin') return; isPainting = true; applyShift(cell); } function stopPaint() { isPainting = false; } function paint(cell) { if(isPainting) applyShift(cell); }
        function applyShift(cell) {
            // FIX: Allow drawing 'nowork' on weekends for scheduling
            if(cell.dataset.weekend === 'true' && currentTool !== 'nowork' && currentTool !== 'clear' || currentUser.role !== 'admin') return;
            const date = cell.dataset.date;
            const emp = cell.dataset.emp;
            updateShiftData(date, emp, currentTool);
            // Reset cell styles and text
            cell.className = 'matrix-cell';
            cell.innerText = '';
            if(currentTool !== 'clear') {
                // Apply class based on shift type
                if (currentTool === 'morning') cell.classList.add('cell-m');
                else if (currentTool === 'evening') cell.classList.add('cell-e');
                else if (currentTool === 'night') cell.classList.add('cell-n');
                else if (currentTool === 'nowork') cell.classList.add('cell-nowork'); // FIX: Added nowork class
                // Display user-friendly label
                let disp = '';
                if (currentTool === 'morning') disp = '1st';
                else if (currentTool === 'evening') disp = '2nd';
                else if (currentTool === 'night') disp = '3rd';
                else if (currentTool === 'nowork') disp = 'NW';
                cell.innerText = disp;
            }
        }
        // FIX: Added 'nowork' array to shifts object and updated filter logic
        function updateShiftData(date, emp, shiftType) { 
            if(!shifts[date]) shifts[date] = { morning:[], evening:[], night:[], nowork:[] }; 
            shifts[date].morning = shifts[date].morning.filter(n => n !== emp); 
            shifts[date].evening = shifts[date].evening.filter(n => n !== emp); 
            shifts[date].night = shifts[date].night.filter(n => n !== emp); 
            shifts[date].nowork = shifts[date].nowork.filter(n => n !== emp); 
            if(shiftType !== 'clear') shifts[date][shiftType].push(emp); 
        }
        function fillMonth(empName, shiftType) { 
            const year = document.getElementById('plannerYear').value; 
            const month = document.getElementById('plannerMonth').value; 
            const daysInMonth = new Date(year, month, 0).getDate(); 
            for(let i=1; i<=daysInMonth; i++) { 
                const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(i).padStart(2,'0')}`; 
                const dObj = new Date(year, month-1, i); 
                // Only skip weekends for shifts, not for nowork/clear. Weekends must still be marked visually as weekend in initPlannerMatrix.
                if(shiftType !== 'nowork' && shiftType !== 'clear' && (dObj.getDay() === 5 || dObj.getDay() === 6)) continue; 
                updateShiftData(dateStr, empName, shiftType); 
            } 
            initPlannerMatrix(); 
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: `Updated ${empName} to ${shiftType}`, showConfirmButton: false, timer: 1500 }); 
        }
        // FIX: Changed savePlanner to only save if admin
        async function savePlanner() { 
            if (currentUser.role !== 'admin') return Swal.fire('Permission Denied', 'Only Admins can save the schedule.', 'error');
            const ok = await saveGithub('shifts.json', shifts); 
            if (ok) {
                Swal.fire('Saved', 'Monthly roster updated successfully.', 'success');
            } 
        }
        // Copy an HTML table to clipboard as an image using html2canvas. This makes the table
        // ready for pasting into email clients that accept images. Falls back to text copy if
        // html2canvas or clipboard API is unavailable.
        function copyTableToClipboard(elementId) {
            const el = document.getElementById(elementId);
            if (!el) return;
            // FIX: Check if element is a table and if it's the planner matrix to use a different copy method
            const isPlannerMatrix = elementId === 'planner-matrix';
            if (isPlannerMatrix) {
                // FIX: Better planner matrix copy logic (CSV style, but formatted)
                let textContent = "Monthly Shift Schedule\n";
                const table = document.getElementById('planner-matrix');
                if (table) {
                    const rows = table.querySelectorAll('tr');
                    rows.forEach((row, rIdx) => {
                        let line = [];
                        row.querySelectorAll('th, td').forEach((cell, cIdx) => {
                            // Skip actions column
                            if (cIdx === row.querySelectorAll('th, td').length - 1 && row.querySelector('.matrix-td-action')) {
                                return;
                            }
                            line.push(cell.innerText.replace(/\n/g, ' ').trim());
                        });
                        if (line.length > 0) {
                            textContent += line.join('\t') + '\n';
                        }
                    });
                }
                
                try {
                    // Use text clipboard for better cross-client compatibility for tables like this
                    navigator.clipboard.writeText(textContent).then(() => {
                        Swal.fire('Copied', 'Schedule table copied to clipboard as text.', 'success');
                    }).catch(() => {
                        // Fallback to execCommand for older browsers or restricted environments
                        const tempTextarea = document.createElement('textarea');
                        tempTextarea.value = textContent;
                        document.body.appendChild(tempTextarea);
                        tempTextarea.select();
						const temp = el.cloneNode(true);
                        temp.querySelectorAll('.no-email').forEach(n => n.remove());
                        document.body.appendChild(temp);
                        range.selectNodeContents(temp);
                        document.execCommand('copy');
						temp.remove();
                        document.body.removeChild(tempTextarea);
                        Swal.fire('Copied', 'Schedule table copied to clipboard as text.', 'success');
                    });
                    return;
                } catch(e) {}
            }
            // Original HTML2Canvas/Image logic for other elements
            if (typeof html2canvas === 'function' && navigator.clipboard && window.ClipboardItem) {
                // Use html2canvas to capture the table into a canvas
                html2canvas(el).then(canvas => {
                    canvas.toBlob(async (blob) => {
                        try {
                            await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                            Swal.fire('Copied', 'Table image copied to clipboard', 'success');
                        } catch (err) {
                            Swal.fire('Error', 'Failed to copy image', 'error');
                        }
                    });
                });
            } else {
                // Fallback: copy plain text
                const range = document.createRange();
                range.selectNode(el);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                try {
                    const success = document.execCommand('copy');
                    Swal.fire(success ? 'Copied' : 'Error', success ? 'Table copied to clipboard' : 'Copy failed', success ? 'success' : 'error');
                } catch (e) {
                    Swal.fire('Error', 'Copy failed', 'error');
                }
                window.getSelection().removeAllRanges();
            }
        }
        let weekendSessionIds = []; // IDs ÙÙÙØ¯Ø®ÙØ§Øª Ø§ÙØ­Ø§ÙÙØ© (ÙÙÙÙØ¯ ÙØ§Ø­Ø¯)

function renderWeekendTable() {
  const preview = document.getElementById('weekend-table-preview');
  if (!preview) return;

  // ÙÙØ· Ø¹ÙØ§ØµØ± Ø§ÙØ¬ÙØ³Ø© Ø§ÙØ­Ø§ÙÙØ©
  const sessionEntries = overtime
    .filter(o => weekendSessionIds.includes(o.id))
    .sort((a,b) => new Date(a.date) - new Date(b.date));

  if (sessionEntries.length === 0) {
    preview.innerHTML = '';
    renderWeekendLog();
    return;
  }

  const byDate = {};
  sessionEntries.forEach(o => {
    if (!byDate[o.date]) byDate[o.date] = { overtime: [], nowork: [] };
    if (o.type === 'overtime') byDate[o.date].overtime.push(o);
    if (o.type === 'nowork')  byDate[o.date].nowork.push(o);
  });

  let html = `<table class="email-table-out" border="1" style="width:100%">`;

  Object.keys(byDate).forEach(d => {
    const dayName = new Date(d).toLocaleDateString('en-US', { weekday:'long' });
    const dateFmt = new Date(d).toLocaleDateString('en-GB');

    html += `<tr><td colspan="5" class="email-th" style="background:#9dc3e6; text-align:center; font-weight:700;">
              ${dayName} ${dateFmt}
            </td></tr>`;

    // No Work ÙÙØ·
    if (byDate[d].overtime.length === 0 && byDate[d].nowork.length > 0) {
      html += `<tr><td colspan="5" class="email-th" style="background:#f4b084; text-align:center; font-weight:700;">
                No Work
              </td></tr>`;
      return;
    }

    if (byDate[d].overtime.length > 0) {
      html += `<tr style="background:#e7e6e6">
                <td class="email-td"><b>Name</b></td>
                <td class="email-td"><b>From</b></td>
                <td class="email-td"><b>To</b></td>
                <td class="email-td"><b>Task</b></td>
                <td class="email-td no-email"><b>Del</b></td>
              </tr>`;

      byDate[d].overtime.forEach(i => {
        html += `<tr>
                  <td class="email-td">${i.name}</td>
                  <td class="email-td">${i.from}</td>
                  <td class="email-td">${i.to}</td>
                  <td class="email-td">${(i.task && i.task.trim()) ? i.task : 'N/A'}</td>
                  <td class="email-td no-email" style="text-align:center;">
                    <button onclick="deleteWeekendEntry(${i.id})" style="color:#e11d48;font-weight:900;">Ã</button>
                  </td>
                </tr>`;
      });
    }
  });

  html += `</table>`;
  preview.innerHTML = html;

  // Ø§ÙÙÙÙ ØªØ­Øª
  renderWeekendLog();
}


        
        // FIX: Added addNoWork function
async function addNoWork() {
  const name = document.getElementById('otEmpSelect').value;
  const date = document.getElementById('otDate').value;
  if(!name || !date) return Swal.fire('Error', 'Select employee and date.', 'warning');

  const newId = Date.now();

  overtime.push({ 
    id: newId, 
    name, 
    date, 
    type: 'nowork', 
    hours: 0, 
    from: 'N/A', 
    to: 'N/A', 
    task: 'N/A' 
  });

  weekendSessionIds.push(newId);

  await saveGithub('overtime.json', overtime); 
  renderWeekendTable();

  Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: `No Work logged for ${name}`, showConfirmButton: false, timer: 1500 });
}


        async function addOvertime() { 
const name = document.getElementById('otEmpSelect').value; 
  const date = document.getElementById('otDate').value; 
  const from = document.getElementById('otTimeFrom').value; 
  const to = document.getElementById('otTimeTo').value; 
  const task = (document.getElementById('otTask')?.value || '').trim();

  if(!name || !date || !from || !to) return Swal.fire('Error', 'Fill all fields', 'warning'); 

  const d1 = new Date(`2000-01-01T${from}`); 
  const d2 = new Date(`2000-01-01T${to}`); 
  let hours = (d2 - d1) / 36e5; 
  if(hours < 0) hours += 24; 

  const newId = Date.now();
  overtime.push({
    id: newId,
    name,
    date,
    from,
    to,
    hours: parseFloat(hours.toFixed(1)),
    task: task || 'N/A',
    type: 'overtime'
  });

  weekendSessionIds.push(newId);
  await saveGithub('overtime.json', overtime); 
  renderWeekendTable();
}
function finalizeWeekendSession() {
  // ÙØ§ ÙØ­Ø°Ù ÙÙØ§ ÙØ¹Ø¯Ù overtime.json
  weekendSessionIds = [];

  // ÙÙØ±ÙØº Ø§ÙÙÙØ±Ù ÙØ§ÙÙØ¹Ø§ÙÙØ©
  resetWeekendEntryForm();
  const preview = document.getElementById('weekend-table-preview');
  if (preview) preview.innerHTML = '';

  Swal.fire({ toast:true, position:'top-end', icon:'success', title:'Weekend saved. Ready for new entry.', showConfirmButton:false, timer:1500 });

  // ØªØ­Ø¯ÙØ« Ø§ÙÙÙÙ ÙÙØ·
  renderWeekendLog();
}

async function finalizeWeekendOT() {
  // ÙØ§ ÙØ­ØªØ§Ø¬ ÙØ­ÙØ¸ ÙÙØ§ ÙØ£Ù ÙÙ Ø¥Ø¯Ø®Ø§Ù ÙØ­ÙÙØ¸ ÙØ­Ø§ÙÙ
  // Ø¨Ø³ ÙØ®ÙÙÙØ§ âÙÙØ§ÙØ© Ø§ÙØ¬ÙØ³Ø©â + ØªØµÙÙØ± Ø§ÙØ´Ø§Ø´Ø©

  const ok = await Swal.fire({
    title: 'Finalize Weekend?',
    text: 'This will close the current weekend session and clear the output view.',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Save & New'
  });
  if (!ok.isConfirmed) return;

  // â Ø§Ø¨Ø¯Ø£ Ø¬ÙØ³Ø© Ø¬Ø¯ÙØ¯Ø© (Ø¨Ø¯ÙÙ ÙÙØ³ Ø§ÙÙlog Ø§ÙØªØ§Ø±ÙØ®Ù)
  weekendSessionIds = [];

  // â ØµÙÙØ± Ø§ÙØ¥Ø¯Ø®Ø§ÙØ§Øª ÙØ§ÙØ§Ø®Ø±Ø§Ø¬
  const emp = document.getElementById('otEmpSelect');
  const date = document.getElementById('otDate');
  const from = document.getElementById('otTimeFrom');
  const to = document.getElementById('otTimeTo');
  const task = document.getElementById('otTask');
  const preview = document.getElementById('weekend-table-preview');

  if (emp) emp.value = '';
  if (date) date.value = '';
  if (from) from.value = '';
  if (to) to.value = '';
  if (task) task.value = '';
  if (preview) preview.innerHTML = '';

  // Ø§ÙÙÙÙ ÙØ¨ÙÙ ØªØ§Ø±ÙØ®Ù
  renderWeekendLog();

  Swal.fire({ toast:true, position:'top-end', icon:'success', title:'Weekend saved. Ready for a new one.', showConfirmButton:false, timer:1500 });
}
async function deleteWeekendEntry(id) {
  const ok = await Swal.fire({
    title: 'Delete?',
    text: 'This will remove the entry permanently.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Delete'
  });
  if (!ok.isConfirmed) return;

  overtime = overtime.filter(o => o.id !== id);

  // â ÙÙØ§ ÙÙØ§Ù Ø³Ø·Ø± Ø§ÙØ³Ø´Ù (ÙÙ Ø¯Ø§Ø®Ù Ø§ÙØ¬Ø¯ÙÙ)
  weekendSessionIds = weekendSessionIds.filter(x => x !== id);

  await saveGithub('overtime.json', overtime);

  renderWeekendTable();
  renderWeekendLog();
}
function resetWeekendEntryForm() {
  const emp = document.getElementById('otEmpSelect');
  const date = document.getElementById('otDate');
  const from = document.getElementById('otTimeFrom');
  const to = document.getElementById('otTimeTo');
  const task = document.getElementById('otTask');
  const preview = document.getElementById('weekend-table-preview');

  if (emp) emp.value = '';
  if (date) date.value = '';
  if (from) from.value = '';
  if (to) to.value = '';
  if (task) task.value = '';

  weekendSessionIds = [];     // â Ø£ÙÙ Ø³Ø·Ø±
  if (preview) preview.innerHTML = '';  // â ÙØµÙÙØ± Ø§ÙØ¥Ø®Ø±Ø§Ø¬

  renderWeekendLog(); // Ø§ÙÙÙÙ ÙØ¨ÙÙ ØªØ§Ø±ÙØ®Ù
}


        function handleShiftLogUpload(input) { const file = input.files[0]; if(!file) return; Papa.parse(file, { complete: async function(results) { const data = results.data; let newEntriesCount = 0; data.forEach((row, i) => { if(i === 0 || row.length < 8) return; const dateRaw = row[0]; if(!dateRaw) return; const parts = dateRaw.split('/'); const isoDate = `${parts[2]}-${parts[1]}-${parts[0]}`; if(!masterShiftLogs[isoDate]) masterShiftLogs[isoDate] = { morning:null, evening:null, night:null, nowork: null, displayDate: dateRaw }; const shiftRaw = row[1].toLowerCase().replace(/\s/g, ''); let key = 'morning'; if(shiftRaw.includes('second') || shiftRaw.includes('even')) key = 'evening'; if(shiftRaw.includes('third') || shiftRaw.includes('night')) key = 'night'; masterShiftLogs[isoDate][key] = { rec: row[2], disp: row[3], std: row[4], trucksPlan: row[5], trucksRec: row[6], trucksDisp: row[7] }; newEntriesCount++; }); await saveGithub('shift_logs_master.json', masterShiftLogs); const dates = Object.keys(masterShiftLogs).sort((a,b)=>new Date(a)-new Date(b)); if(dates.length > 0) { const lastDate = dates[dates.length-1]; updateDashboardShiftCards(lastDate, masterShiftLogs[lastDate]); } renderShiftTrendChart(); Swal.fire('Success', `Imported ${newEntriesCount} log entries.`, 'success'); input.value = ''; } }); }
        function updateDashboardShiftCards(isoDate, data) {
            const displayDate = data.displayDate || isoDate;
            document.getElementById('shift-log-display').classList.remove('hidden');
            document.getElementById('shift-log-date').textContent = displayDate;
            const roster = shifts[isoDate] || { morning: [], evening: [], night: [], nowork: [] };
            const renderStats = (d, staffList) => {
                if (!d) return '<p class="italic opacity-50">No Data</p>';
                // Filter out 'No Work' staff from staff count display if present in shift data
                const staffStr = staffList && staffList.length > 0 ? staffList.join(', ') : 'No staff assigned';
                return `
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <span class="block text-xs opacity-60 font-bold">PALLETS</span>
                            <div class="flex justify-between text-xs"><span>Rec:</span><span class="font-bold">${d.rec}</span></div>
                            <div class="flex justify-between text-xs"><span>Disp:</span><span class="font-bold">${d.disp}</span></div>
                        </div>
                        <div>
                            <span class="block text-xs opacity-60 font-bold">TRUCKS</span>
                            <div class="flex justify-between text-xs"><span>Plan:</span><span class="font-bold">${d.trucksPlan}</span></div>
                            <div class="flex justify-between text-xs"><span>Act:</span><span class="font-bold">${d.trucksRec}</span></div>
                        </div>
                    </div>
                    <div class="mt-2 text-[10px] text-slate-400"><span class="font-bold text-slate-300">Staff:</span> ${staffStr}</div>
                `;
            };
            document.getElementById('card-stats-morning').innerHTML = renderStats(data.morning, roster.morning);
            document.getElementById('card-staff-morning').innerHTML = roster.morning.map(n => `<div>${n}</div>`).join('') || 'No staff assigned';
            document.getElementById('card-stats-evening').innerHTML = renderStats(data.evening, roster.evening);
            document.getElementById('card-staff-evening').innerHTML = roster.evening.map(n => `<div>${n}</div>`).join('') || 'No staff assigned';
            document.getElementById('card-stats-night').innerHTML = renderStats(data.night, roster.night);
            document.getElementById('card-staff-night').innerHTML = roster.night.map(n => `<div>${n}</div>`).join('') || 'No staff assigned';
        }
        
        // NEW FUNCTION: Render Trend Chart
        function renderShiftTrendChart() {
            const ctx = document.getElementById('chart-shift-trend');
            if(!ctx) return;
            
            const dates = Object.keys(masterShiftLogs).sort((a,b) => new Date(a) - new Date(b)).slice(-7); // Last 7 days
            const labels = dates.map(d => new Date(d).toLocaleDateString('en-GB', {day:'numeric', month:'short'}));
            
            const dataRec = dates.map(d => {
                const log = masterShiftLogs[d];
                return (parseInt(log.morning?.rec)||0) + (parseInt(log.evening?.rec)||0) + (parseInt(log.night?.rec)||0);
            });
            
            const dataDisp = dates.map(d => {
                const log = masterShiftLogs[d];
                return (parseInt(log.morning?.disp)||0) + (parseInt(log.evening?.disp)||0) + (parseInt(log.night?.disp)||0);
            });

            if(window.shiftTrendChart) window.shiftTrendChart.destroy();

            window.shiftTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Received', data: dataRec, borderColor: '#10b981', backgroundColor: '#10b98120', fill: true, tension: 0.4 },
                        { label: 'Dispatched', data: dataDisp, borderColor: '#3b82f6', backgroundColor: '#3b82f620', fill: true, tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#334155' } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { labels: { color: '#94a3b8' } } }
                }
            });
        }

        // --- Shift Logs Management ---
        async function loadShiftLogs() {
            try {
                const data = await fetchGithub('shift_logs_master.json');
                if (data && typeof data === 'object') {
                    masterShiftLogs = data;
                    // Normalize entries: ensure plan and act fields exist
                    Object.keys(masterShiftLogs).forEach(date => {
                        const logs = masterShiftLogs[date];
                        ['morning','evening','night'].forEach(shift => {
                            const entry = logs[shift];
                            if(entry){
                                if(entry.plan === undefined && entry.trucksPlan !== undefined) entry.plan = entry.trucksPlan;
                                if(entry.act === undefined && entry.trucksRec !== undefined) entry.act = entry.trucksRec;
                            }
                        });
                    });
                } else {
                    masterShiftLogs = {};
                }
            } catch (e) {
                masterShiftLogs = {};
            }
            renderShiftLogTable();
            renderShiftTrendChart();
        }

        function renderShiftLogTable() {
            const body = document.getElementById('shiftlog-table-body');
            if (!body) return;
            let html = '';
            const dates = Object.keys(masterShiftLogs).sort((a, b) => new Date(a) - new Date(b));
            dates.forEach(date => {
                const logs = masterShiftLogs[date];
                const displayDate = logs.displayDate || new Date(date).toLocaleDateString('en-GB');
                ['morning','evening','night'].forEach(shift => {
                    const entry = logs[shift];
                    if (entry) {
                        const rec = entry.rec || '';
                        const disp = entry.disp || '';
                        // plan and act may be stored under plan/act or trucksPlan/trucksRec for compatibility
                        const plan = entry.plan ?? entry.trucksPlan ?? '';
                        const act  = entry.act  ?? entry.trucksRec ?? '';
                        html += `<tr>
                            <td class="p-2">${displayDate}</td>
                            <td class="p-2 capitalize">${shift}</td>
                            <td class="p-2">${rec}</td>
                            <td class="p-2">${disp}</td>
                            <td class="p-2">${plan}</td>
                            <td class="p-2">${act}</td>
                            <td class="p-2 text-center"><button onclick="deleteShiftLogRecord('${date}','${shift}')" class="text-red-500 hover:text-red-400"><i class="fas fa-trash"></i></button></td>
                        </tr>`;
                    }
                });
            });
            if (!html) html = '<tr><td colspan="7" class="p-2 text-center text-slate-500">No entries</td></tr>';
            body.innerHTML = html;
        }

        async function addShiftLogRecord() {
            const date = document.getElementById('shiftlog-date').value;
            const shift = document.getElementById('shiftlog-shift').value;
            const rec = document.getElementById('shiftlog-pallets').value;
            const disp = document.getElementById('shiftlog-palletsDisp').value;
            const plan = document.getElementById('shiftlog-plan').value;
            const act  = document.getElementById('shiftlog-act').value;
            if (!date || !shift) {
                Swal.fire('Error', 'Date and shift are required.', 'warning');
                return;
            }
            // Ensure object structure
            if (!masterShiftLogs[date]) {
                masterShiftLogs[date] = { morning: null, evening: null, night: null, nowork: null, displayDate: new Date(date).toLocaleDateString('en-GB') };
            }
            // store both plan/act and trucksPlan/trucksRec for compatibility with dashboards
            masterShiftLogs[date][shift] = {
                rec: rec,
                disp: disp,
                plan: plan,
                act: act,
                trucksPlan: plan,
                trucksRec: act
            };
            await saveGithub('shift_logs_master.json', masterShiftLogs);
            renderShiftLogTable();
            renderShiftTrendChart();
            // Clear input fields
            document.getElementById('shiftlog-pallets').value = '';
            document.getElementById('shiftlog-palletsDisp').value = '';
            document.getElementById('shiftlog-plan').value = '';
            document.getElementById('shiftlog-act').value = '';
            Swal.fire({ toast: true, icon: 'success', title: 'Entry added', timer: 1500, position: 'top-end', showConfirmButton: false });
        }

        async function deleteShiftLogRecord(date, shift) {
            if (!masterShiftLogs[date]) return;
            masterShiftLogs[date][shift] = null;
            // Remove date if all shifts are null
            const logs = masterShiftLogs[date];
            if (!logs.morning && !logs.evening && !logs.night && !logs.nowork) {
                delete masterShiftLogs[date];
            }
            await saveGithub('shift_logs_master.json', masterShiftLogs);
            renderShiftLogTable();
            renderShiftTrendChart();
            Swal.fire({ toast: true, icon: 'success', title: 'Entry deleted', timer: 1500, position: 'top-end', showConfirmButton: false });
        }

        // --- Permissions Management ---
        async function loadPermissions() {
            try {
                const data = await fetchGithub('permissions.json');
                if (data && typeof data === 'object') {
                    permissions = data;
                }
            } catch (e) {
                // ignore
            }
            if (!permissions || Object.keys(permissions).length === 0) {
                // Helper function to create default card permissions
                const defaultCardPerms = (shiftLog, customCards, otLeaderboard, monthlySchedule, palletsSummary) => ({
                    'shift-log-display': shiftLog,
                    'overview': true, 
                    'storage': true, 
                    'quality': true, 
                    'inbound': true, 
                    'outbound': true, 
                    'finance': true, 
                    'pending': true,
                    'monthly-schedule': monthlySchedule, 
                    'pallets-summary': palletsSummary, 
                    'custom-cards-grid': customCards, 
                    'ot-leaderboard-section': otLeaderboard
                });

                // Set default permissions, including five additional roles for customization
                permissions = {
                    admin: { 
                        dashboard:true, workforce:true, 
                        roster:true, planner:true, overtime:true, data:true, staff:true, incidents:true, pallets:true, manager:true, shiftlogs:true, permissions:true, presentation:true, 
                        cards: defaultCardPerms(true, true, true, true, true),
                        slides: { overview:true, storage:true, quality:true, inbound:true, outbound:true, finance:true, pending:true } 
                    },
                    manager: { 
                        dashboard:true, workforce:true,
                        roster:true, planner:true, overtime:true, data:false, staff:true, incidents:true, pallets:true, manager:true, shiftlogs:false, permissions:false, presentation:false, 
                        cards: defaultCardPerms(true, false, true, true, true),
                        slides: { overview:true, storage:true, quality:true, inbound:true, outbound:true, finance:true, pending:true } 
                    },
                    guest: { 
                        dashboard:true, workforce:true,
                        roster:true, planner:false, overtime:false, data:false, staff:false, incidents:false, pallets:false, manager:false, shiftlogs:false, permissions:false, presentation:false, 
                        cards: defaultCardPerms(false, false, false, false, true),
                        slides: { overview:true, storage:true, quality:true, inbound:true, outbound:false, finance:false, pending:false } 
                    },
                    role1: { 
                        dashboard:true, workforce:true,
                        roster:true, planner:false, overtime:false, data:false, staff:false, incidents:false, pallets:false, manager:false, shiftlogs:false, permissions:false, presentation:false, 
                        cards: defaultCardPerms(false, false, false, false, false),
                        slides: { overview:true, storage:true, quality:true, inbound:false, outbound:false, finance:false, pending:false } 
                    },
                    role2: { 
                        dashboard:true, workforce:true,
                        roster:true, planner:false, overtime:false, data:false, staff:false, incidents:false, pallets:false, manager:false, shiftlogs:false, permissions:false, presentation:false, 
                        cards: defaultCardPerms(false, false, false, false, false),
                        slides: { overview:true, storage:false, quality:false, inbound:false, outbound:false, finance:false, pending:false } 
                    },
                    role3: { 
                        dashboard:true, workforce:true,
                        roster:true, planner:false, overtime:false, data:false, staff:false, incidents:false, pallets:false, manager:false, shiftlogs:false, permissions:false, presentation:false, 
                        cards: defaultCardPerms(false, false, false, false, false),
                        slides: { overview:true, storage:false, quality:false, inbound:false, outbound:false, finance:false, pending:false } 
                    },
                    role4: { 
                        dashboard:true, workforce:true,
                        roster:true, planner:false, overtime:false, data:false, staff:false, incidents:false, pallets:false, manager:false, shiftlogs:false, permissions:false, presentation:false, 
                        cards: defaultCardPerms(false, false, false, false, false),
                        slides: { overview:true, storage:false, quality:false, inbound:false, outbound:false, finance:false, pending:false } 
                    },
                    role5: { 
                        dashboard:true, workforce:true,
                        roster:true, planner:false, overtime:false, data:false, staff:false, incidents:false, pallets:false, manager:false, shiftlogs:false, permissions:false, presentation:false, 
                        cards: defaultCardPerms(false, false, false, false, false),
                        slides: { overview:true, storage:false, quality:false, inbound:false, outbound:false, finance:false, pending:false } 
                    }
                };
            }
            renderPermissionsForm();
        }

        function renderPermissionsForm() {
            const container = document.getElementById('permissions-form');
            if (!container) return;
            const roles = Object.keys(permissions);
            // FIX: Added 'presentation' to the features list
            const features = ['dashboard','workforce','roster','planner','overtime','data','staff','incidents','pallets','manager','shiftlogs','permissions','presentation'];
            let html = '';
            // Build table for core features (tabs/views)
            html += '<table class="w-full text-left text-sm">';
            html += '<thead><tr><th class="p-2">Role</th>' + features.map(f => `<th class="p-2 capitalize">${f}</th>`).join('') + '</tr></thead>';
            html += '<tbody>';
            roles.forEach(role => {
                html += `<tr>`;
                html += `<td class="p-2 font-bold">${role}</td>`;
                features.forEach(feat => {
                    const checked = permissions[role][feat] !== false ? 'checked' : '';
                    html += `<td class="p-2 text-center"><input type="checkbox" id="perm-${role}-${feat}" ${checked}></td>`;
                });
                html += `</tr>`;
            });
            html += '</tbody></table>';

            // FIX: Added all missing dashboard sections to the cards array
            const cards = [
                { id: 'shift-log-display', label: 'Shift Log' },
                { id: 'overview', label: 'Overview' },
                { id: 'storage', label: 'Storage' },
                { id: 'quality', label: 'Quality' },
                { id: 'inbound', label: 'Inbound' },
                { id: 'outbound', label: 'Outbound' },
                { id: 'finance', label: 'RSD & Finance' },
                { id: 'pending', label: 'Pending' },
                { id: 'monthly-schedule', label: 'Monthly Schedule' },
                { id: 'pallets-summary', label: 'Pallets Inventory' },
                { id: 'custom-cards-grid', label: 'Custom Cards' },
                { id: 'ot-leaderboard-section', label: 'OT Leaderboard' }
            ];
            html += '<h4 class="mt-6 mb-2 text-sm font-bold">Dashboard Sections</h4>';
            html += '<table class="w-full text-left text-sm">';
            html += '<thead><tr><th class="p-2">Role</th>' + cards.map(c => `<th class="p-2 text-xs">${c.label}</th>`).join('') + '</tr></thead>';
            html += '<tbody>';
            roles.forEach(role => {
                html += `<tr>`;
                html += `<td class="p-2 font-bold">${role}</td>`;
                cards.forEach(card => {
                    // Ensure card permissions exist
                    if (!permissions[role].cards) permissions[role].cards = {};
                    const checkedCard = permissions[role].cards[card.id] !== false ? 'checked' : '';
                    html += `<td class="p-2 text-center"><input type="checkbox" id="perm-card-${role}-${card.id}" ${checkedCard}></td>`;
                });
                html += `</tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Render the presentation configuration form for admin. Allows toggling which slides
        // appear in presentation mode per role. Only roles defined in permissions object are shown.
        function renderPresentationForm() {
            const container = document.getElementById('presentation-form');
            if (!container) return;
            const roles = Object.keys(permissions);
            // Slides correspond to dashboard section IDs used in presentation
            const slides = ['overview','storage','quality','inbound','outbound','finance','pending'];
            let html = '';
            html += '<table class="w-full text-left text-sm">';
            html += '<thead><tr><th class="p-2">Role</th>' + slides.map(s => `<th class="p-2 capitalize">${s}</th>`).join('') + '</tr></thead>';
            html += '<tbody>';
            roles.forEach(role => {
                html += '<tr>';
                html += `<td class="p-2 font-bold">${role}</td>`;
                slides.forEach(slide => {
                    // Ensure slides object exists for role
                    if (!permissions[role].slides) permissions[role].slides = {};
                    const checked = permissions[role].slides[slide] !== false ? 'checked' : '';
                    html += `<td class="p-2 text-center"><input type="checkbox" id="slide-${role}-${slide}" ${checked}></td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function savePresentationConfig() {
            const roles = Object.keys(permissions);
            const slides = ['overview','storage','quality','inbound','outbound','finance','pending'];
            roles.forEach(role => {
                if (!permissions[role].slides) permissions[role].slides = {};
                slides.forEach(slide => {
                    const cb = document.getElementById(`slide-${role}-${slide}`);
                    permissions[role].slides[slide] = cb && cb.checked;
                });
            });
            await saveGithub('permissions.json', permissions);
            Swal.fire({ toast:true, icon:'success', title:'Presentation settings saved', timer:1500, position:'top-end', showConfirmButton:false });
        }

        async function savePermissions() {
            const roles = Object.keys(permissions);
            // FIX: Added 'presentation' to the features list
            const features = ['dashboard','workforce','roster','planner','overtime','data','staff','incidents','pallets','manager','shiftlogs','permissions','presentation'];
            // FIX: Added all missing dashboard sections to the cards array
            const cards = ['shift-log-display','overview','storage','quality','inbound','outbound','finance','pending','monthly-schedule','pallets-summary','custom-cards-grid','ot-leaderboard-section'];
            roles.forEach(role => {
                // Update view/tab permissions
                features.forEach(feat => {
                    const cb = document.getElementById(`perm-${role}-${feat}`);
                    permissions[role][feat] = cb && cb.checked;
                });
                // Initialize cards object if not present
                if (!permissions[role].cards) permissions[role].cards = {};
                // Update dashboard section visibility
                cards.forEach(cardId => {
                    const cbCard = document.getElementById(`perm-card-${role}-${cardId}`);
                    // Save false when unchecked and true when checked
                    if (cbCard) permissions[role].cards[cardId] = cbCard.checked;
                });
            });
            await saveGithub('permissions.json', permissions);
            applyRoleUI(currentUser.role);
            Swal.fire({ toast:true, icon:'success', title:'Permissions saved', timer:1500, position:'top-end', showConfirmButton:false });
        }

        // --- Export Planner to CSV ---
        function exportPlannerExcel() {
            const table = document.getElementById('planner-matrix');
            if (!table) return;
            let csvLines = [];
            // FIX: Export better structured CSV with dates as headers and shifts as codes
            let headerCells = ['EMPLOYEE'];
            const dateHeaders = table.querySelector('thead tr').querySelectorAll('th:not(:first-child, :last-child)');
            dateHeaders.forEach(th => {
                const dayNum = th.textContent.trim().split('\n')[0];
                headerCells.push(dayNum);
            });
            csvLines.push(headerCells.join(','));

            // Map cell content to single code (1st/2nd/3rd/NW/"" )
            const shiftMap = { '1st': 'M', '2nd': 'E', '3rd': 'N', 'NW': 'NW', '': '' };

            for (let r = 1; r < table.rows.length; r++) { // Start at 1 to skip THEAD
                const row = table.rows[r];
                const rowCells = [];
                // First cell is employee name
                rowCells.push(row.cells[0].innerText.replace(/,/g, ';').trim());
                // Data cells (skip last action column)
                for (let c = 1; c < row.cells.length - 1; c++) {
                    const cellText = row.cells[c].innerText.trim();
                    rowCells.push(shiftMap[cellText] || '');
                }
                csvLines.push(rowCells.join(','));
            }
            const blob = new Blob([csvLines.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const year = document.getElementById('plannerYear').value;
            const month = document.getElementById('plannerMonth').value;
            link.download = `shift_schedule_${year}_${month}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // --- Weekend / OT Improvements ---
        function renderWeekendLog() {
            // Display past OT entries with delete option
            const logDiv = document.getElementById('weekend-log-container');
            if (!logDiv) return;
            // FIX: Filter all logged overtime/nowork entries
            const allEntries = overtime.sort((a,b)=>new Date(b.date) - new Date(a.date));
            if (allEntries.length === 0) {
                logDiv.innerHTML = '<p class="text-slate-500 text-sm mt-4">No weekend/OT logs yet.</p>';
                return;
            }
            let html = '<h4 class="text-white font-bold text-sm mb-2 mt-4">Full OT/No Work Log (Admin Delete Only)</h4>';
            html += '<div class="overflow-x-auto"><table class="w-full text-left text-xs border-t border-dark-700">';
            html += '<thead class="bg-dark-800 text-slate-400"><tr><th class="p-2">Date</th><th class="p-2">Type</th><th class="p-2">Name</th><th class="p-2">Time/Hours</th><th class="p-2 text-center">Actions</th></tr></thead><tbody>';
            
            allEntries.forEach(item => {
                const dFmt = new Date(item.date).toLocaleDateString('en-GB');
                const timeOrHours = item.type === 'overtime' ? `${item.from}-${item.to} (${item.hours}h)` : 'N/A';
                const typeLabel = item.type === 'overtime' ? 'OT' : 'No Work';
                const isDeleteAllowed = currentUser.role === 'admin' ? '' : 'disabled'; // Only admin can delete
                const deleteBtn = currentUser.role === 'admin' ? `<button onclick="deleteOvertime(${item.id})" class="text-red-500 hover:text-red-400"><i class="fas fa-trash"></i></button>` : `<i class="fas fa-lock text-slate-600"></i>`;
                
                html += `<tr><td class="p-2">${dFmt}</td><td class="p-2 font-bold ${item.type === 'overtime' ? 'text-orange-400' : 'text-slate-400'}">${typeLabel}</td><td class="p-2">${item.name}</td><td class="p-2">${timeOrHours}</td><td class="p-2 text-center">${deleteBtn}</td></tr>`;
            });
            html += '</tbody></table></div>';
            logDiv.innerHTML = html;
        }

        async function deleteOvertime(id) {
            if (currentUser.role !== 'admin') {
                Swal.fire('Permission Denied', 'Only Admins can delete overtime records.', 'error');
                return;
            }
            const idx = overtime.findIndex(o => o.id === id);
            if (idx >= 0) {
                overtime.splice(idx, 1);
                await saveGithub('overtime.json', overtime);
                renderWeekendTable();
                Swal.fire({ toast:true, icon:'success', title:'Deleted', timer:1500, position:'top-end', showConfirmButton:false });
            }
        }

        function renderMonthlySchedule(monthStr) {
            if(!monthStr || monthStr === "ALL_TOTAL") return;
            const container = document.getElementById('dashboard-monthly-preview');
            // FIX: Added logic to hide/show element based on permissions before rendering content
            if (permissions[currentUser.role]?.cards?.['monthly-schedule'] === false) {
                 container.parentElement.classList.add('hidden');
                 return;
            } else {
                 container.parentElement.classList.remove('hidden');
            }

            container.className = 'grid grid-cols-1 lg:grid-cols-3 gap-6'; 

            const parts = monthStr.split('-'); 
            if(parts.length < 2) return;
            const year = 2000 + parseInt(parts[0]);
            const monthIdx = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"].indexOf(parts[1]);
            
            if(monthIdx === -1) return;
            const daysInMonth = new Date(year, monthIdx + 1, 0).getDate();
            
            // Collect Unique Names
            const staffSets = { morning: new Set(), evening: new Set(), night: new Set() };

            for(let i=1; i<=daysInMonth; i++) {
                const dateStr = `${year}-${String(monthIdx+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const dayData = shifts[dateStr];
                if(dayData) {
                    if(dayData.morning) dayData.morning.forEach(n => staffSets.morning.add(n));
                    if(dayData.evening) dayData.evening.forEach(n => staffSets.evening.add(n));
                    if(dayData.night) dayData.night.forEach(n => staffSets.night.add(n));
                }
            }

            const shiftsMap = {
                morning: { title: '1st Shift (Morning)', color: 'yellow', icon: 'fas fa-sun' },
                evening: { title: '2nd Shift (Evening)', color: 'blue', icon: 'fas fa-moon' },
                night: { title: '3rd Shift (Night)', color: 'red', icon: 'fas fa-star' }
            };

            let html = '';
            Object.keys(shiftsMap).forEach(key => {
                const conf = shiftsMap[key];
                const names = Array.from(staffSets[key]).sort();
                const count = names.length;
                
                const listHtml = names.length > 0 
                    ? `<ul class="space-y-2 p-4">${names.map(n => `<li class="flex items-center text-sm text-slate-300 border-b border-white/5 pb-2 last:border-0"><div class="w-2 h-2 rounded-full bg-${conf.color}-500 mr-3"></div>${n}</li>`).join('')}</ul>`
                    : `<div class="p-6 text-center text-slate-500 italic text-sm">No staff assigned</div>`;

                html += `
                    <div class="glass-card rounded-xl overflow-hidden border-t-4 border-${conf.color}-500 flex flex-col h-full">
                        <div class="p-4 bg-dark-800/80 border-b border-dark-600 flex items-center justify-between shrink-0">
                            <h4 class="font-bold text-white text-sm flex items-center"><i class="${conf.icon} text-${conf.color}-500 mr-2"></i>${conf.title}</h4>
                            <span class="bg-${conf.color}-500/20 text-${conf.color}-400 text-xs px-2 py-1 rounded-full font-bold">${count} Staff</span>
                        </div>
                        <div class="bg-dark-900/40 flex-1 overflow-y-auto custom-scrollbar">
                            ${listHtml}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderManagerLeaderboard() { 
            // FIX: Added logic to hide/show element based on permissions
            const otSection = document.getElementById('ot-leaderboard-section');
            if (permissions[currentUser.role]?.cards?.['ot-leaderboard-section'] === false) {
                 if(otSection) otSection.classList.add('hidden');
                 return;
            } else {
                 if(otSection) otSection.classList.remove('hidden');
            }
const month = document.getElementById('otLeaderboardMonth')?.value || '';
const filteredOT = month
  ? overtime.filter(x => x.type === 'overtime' && x.date && x.date.startsWith(month))
  : overtime.filter(x => x.type === 'overtime');

            // FIX: Only calculate OT totals for entries with type 'overtime'
            const totals = {}; 
            overtime.filter(o => o.type === 'overtime').forEach(o => { 
                totals[o.name] = (totals[o.name]||0) + o.hours; 
            }); 
            
            const sorted = Object.entries(totals).sort(([,a],[,b]) => b-a).slice(0, 10); 
            const tbody = document.getElementById('mgr-leaderboard'); 
            if(tbody) tbody.innerHTML = sorted.map(([n,h], i) => `<tr><td class="p-3 text-brand-400 font-bold">#${i+1}</td><td class="p-3 text-white">${n}</td><td class="p-3 text-right font-mono">${h.toFixed(1)}</td></tr>`).join(''); 
        }
        
        async function openAddCardModal() { 
            const icons = ['box', 'truck', 'users', 'warehouse', 'clipboard-list', 'chart-line', 'dollar-sign', 'calendar-check', 'shipping-fast', 'boxes', 'pallet', 'dolly'];
            const iconHtml = `<div class="icon-grid">${icons.map(i => `<div class="icon-option" onclick="selectIcon('${i}')" id="icon-${i}"><i class="fas fa-${i}"></i></div>`).join('')}</div>`;
            window.selectedIcon = 'chart-bar';
            window.selectIcon = (i) => { window.selectedIcon = i; document.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected')); document.getElementById(`icon-${i}`).classList.add('selected'); };

            const { value: form } = await Swal.fire({ 
                title: 'Add Metric Card', 
                html: `
                    <input id="swal-c-title" class="swal2-input" placeholder="Title">
                    <input id="swal-c-val" class="swal2-input" placeholder="Main Value">
                    <div class="my-2 border-t border-slate-600"></div>
                    <p class="text-xs text-slate-400 mb-2">Additional Details (Optional)</p>
                    <input id="swal-c-lbl" class="swal2-input" placeholder="Label 1">
                    <input id="swal-c-val-2" class="swal2-input" placeholder="Value 1">
                    <input id="swal-c-lbl-2" class="swal2-input" placeholder="Label 2">
                    <input id="swal-c-val-3" class="swal2-input" placeholder="Value 2">
                    <p class="text-xs text-slate-400 mt-2">Select Icon:</p>
                    ${iconHtml}`, 
                background: '#1e293b', color: '#fff', 
                preConfirm: () => [
                    document.getElementById('swal-c-title')?.value, 
                    document.getElementById('swal-c-val')?.value, 
                    window.selectedIcon,
                    document.getElementById('swal-c-lbl')?.value,
                    document.getElementById('swal-c-val-2')?.value,
                    document.getElementById('swal-c-lbl-2')?.value,
                    document.getElementById('swal-c-val-3')?.value
                ] 
            }); 
            
            if(form && form[0]) { 
                const newCard = { 
                    title: form[0], 
                    value: form[1], 
                    icon: form[2] || 'chart-bar',
                    details: []
                };
                if(form[3] && form[4]) newCard.details.push({ label: form[3], value: form[4] });
                if(form[5] && form[6]) newCard.details.push({ label: form[5], value: form[6] });
                
                customCards.push(newCard); 
                await saveGithub('custom_cards.json', customCards); 
                renderCustomCards(); 
            } 
        }

        function renderCustomCards() { 
            const con = document.getElementById('custom-cards-grid'); 
            const list = document.getElementById('custom-metric-list'); 
            // FIX: Added logic to hide/show element based on permissions
            if (permissions[currentUser.role]?.cards?.['custom-cards-grid'] === false) {
                 if(con) con.classList.add('hidden');
                 return;
            }
            if(customCards.length > 0 && con) con.classList.remove('hidden'); 
            const html = customCards.map((c, i) => {
                const detailsHtml = c.details ? c.details.map(d => `<div class="flex justify-between text-xs mt-1 pt-1 border-t border-white/5"><span class="text-slate-400">${d.label}</span><span class="text-white font-bold">${d.value}</span></div>`).join('') : '';
                return `<div class="glass-card rounded-2xl p-6 border-l-4 border-brand-500 relative group">
                    <button onclick="delCard(${i})" class="absolute top-2 right-2 text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-trash"></i></button>
                    <div class="flex justify-between items-start mb-2">
                        <div><h4 class="text-slate-400 text-xs font-bold uppercase">${c.title}</h4><p class="text-2xl font-bold text-white mt-1 num-font">${c.value}</p></div>
                        <div class="h-10 w-10 rounded-full bg-dark-800/50 flex items-center justify-center"><i class="fas fa-${c.icon} text-brand-500"></i></div>
                    </div>
                    ${detailsHtml}
                </div>`;
            }).join(''); 
            if(con) con.innerHTML = html; 
            if(list) list.innerHTML = html; 
        }
        async function delCard(i) { 
            if (currentUser.role !== 'admin') return Swal.fire('Permission Denied', 'Only Admins can delete custom cards.', 'error');
            customCards.splice(i,1); await saveGithub('custom_cards.json', customCards); renderCustomCards(); 
        }

        /**
         * Fetch CSV data through the worker. The worker will return the contents
         * of WHSdata.csv or create it if it doesn't exist. We parse it using
         * PapaParse and store into rawData (for metrics) and rawCSVData (for editing).
         */
        async function fetchData() {
            // Load warehouse dataset from WHSdata.json. If file is missing or invalid, use empty array.
            document.getElementById('loadingOverlayData').style.display = 'flex';
            try {
                let jsonData = await fetchGithub('WHSdata.json');
                if (!Array.isArray(jsonData)) {
                    jsonData = [];
                }
                // Normalize dataset to ensure all required fields exist
                normalizeWHSData(jsonData);
                rawData = jsonData;
                // Clone dataset for editing
                rawCSVData = jsonData.map(r => ({ ...r }));
                document.getElementById('lastUpdateTxt').innerText = 'Synced';
                document.getElementById('loadingOverlayData').style.display = 'none';
                init();
            } catch (error) {
                console.error('Data load error', error);
                rawData = [];
                rawCSVData = [];
                document.getElementById('loadingOverlayData').style.display = 'none';
                init();
            }
        }
        function init() {
            // Build full list of unique months from dataset and sort chronologically (assuming format YY-MMM)
            // Normalize month format: ensure XX-MMM (e.g., 24-Jan) even if saved without hyphen (e.g., 24Jan)
            fullMonthList = [];
            rawData.forEach(d => {
                let m = d.Report_Month || '';
                if (typeof m === 'string') {
                    if (!m.includes('-') && m.length >= 5) {
                        // Insert hyphen before last 3 characters
                        m = m.slice(0, 2) + '-' + m.slice(2);
                    }
                }
                if (m && !fullMonthList.includes(m)) fullMonthList.push(m);
            });
            // Sort by year and month
            fullMonthList.sort((a, b) => {
                const [ay, am] = a.split('-');
                const [by, bm] = b.split('-');
                const monthOrder = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                const ayNum = parseInt(ay);
                const byNum = parseInt(by);
                if (ayNum !== byNum) return ayNum - byNum;
                return monthOrder.indexOf(am) - monthOrder.indexOf(bm);
            });
            const sel = document.getElementById('monthSelect');
            // FIX: Ensure month dropdown is updated only if necessary and set correctly
            const currentSelection = sel.value;
            sel.innerHTML = '';
            fullMonthList.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
            if (fullMonthList.includes(currentSelection)) {
                sel.value = currentSelection;
            } else {
                sel.value = fullMonthList[fullMonthList.length - 1];
            }
            sel.onchange = render;
            populateManualFormMonth();
            // Reset warehouse selection to include all warehouses when data loads
            selectedWarehouses = [...WH_ORDER];
            // Compute current month list (last 12 months) and render dashboard
            render();
            // After rendering, rename some card titles for clarity
            try {
                // Orders Trend card becomes Orders/Month
                const orderTrendTitle = document.querySelector('#chart-orders-trend')?.closest('.glass-card')?.querySelector('h4');
                if (orderTrendTitle) orderTrendTitle.textContent = 'Orders/Month';
                // Market Share (distribution) card becomes Orders/Month as well
                const distTitle = document.querySelector('#chart-orders-dist')?.closest('.glass-card')?.querySelector('h4');
                if (distTitle) distTitle.textContent = 'Orders/Month';
            } catch (e) {}
            // Render CSV editor and add-row form
            renderCSVEditor();
            renderCSVForm();
            // Render warehouse filter checkboxes
            renderWarehouseFilters();

            // Ensure SPIMACO-exclusive sections are visible by default
            updateSectionVisibility();
        }
        
        function populateManualFormMonth() {
            const sel = document.getElementById('mm-month');
            if(sel) sel.innerHTML = monthList.map(m => `<option value="${m}">${m}</option>`).join('');
        }
        
        function loadManualForm() {
            const m = document.getElementById('mm-month').value;
            const w = document.getElementById('mm-wh').value;
            const data = manualMetrics[m]?.[w] || {};
            document.getElementById('mm-cap').value = data.capacity || '';
            document.getElementById('mm-used').value = data.used || '';
            document.getElementById('mm-sap').value = data.sap || '';
            document.getElementById('mm-rsd').value = data.rsd || '';
            document.getElementById('mm-pod').value = data.pod || '';
            document.getElementById('mm-ret').value = data.ret || '';
        }
        
        async function saveManualMetrics() {
            const m = document.getElementById('mm-month').value;
            const w = document.getElementById('mm-wh').value;
            if(!manualMetrics[m]) manualMetrics[m] = {};
            manualMetrics[m][w] = {
                capacity: parseFloat(document.getElementById('mm-cap').value) || 0,
                used: parseFloat(document.getElementById('mm-used').value) || 0,
                sap: parseFloat(document.getElementById('mm-sap').value) || 0,
                rsd: parseFloat(document.getElementById('mm-rsd').value) || 0,
                pod: parseFloat(document.getElementById('mm-pod').value) || 0,
                ret: parseFloat(document.getElementById('mm-ret').value) || 0
            };
            await saveGithub('manual_metrics.json', manualMetrics);
            renderDashboard(); // Refresh UI
            Swal.fire({ toast: true, icon: 'success', title: 'Metrics Saved', timer: 1500 });
        }

        function render() {
            const cur = document.getElementById('monthSelect').value;
            // Compute monthList for charts: last 12 months relative to selected month
            const curIndex = fullMonthList.indexOf(cur);
            const startIndex = Math.max(0, curIndex - 11);
            monthList = fullMonthList.slice(startIndex, curIndex + 1);
            // Determine previous month (using fullMonthList)
            let prev = null;
            if (cur !== 'ALL_TOTAL') {
                const idx = fullMonthList.indexOf(cur);
                prev = (idx > 0) ? fullMonthList[idx - 1] : null;
            }
            clearGrids();
            renderOverview(cur, prev);
            renderStorage(cur, prev);
            renderQuality(cur, prev);
            renderInbound(cur, prev);
            renderOutbound(cur, prev);
            renderRSD(cur, prev);
            renderPending(cur, prev);
            renderMonthlySchedule(cur);
            updateAllCharts();
            renderShiftTrendChart();
        }

        // Get Metric Wrapper to support Manual Overrides
        function getMetric(m, wh, col) { 
            // Check manual first for specific columns
            if(manualMetrics[m] && manualMetrics[m][wh]) {
                const man = manualMetrics[m][wh];
                if(col === 'Capacity') return man.capacity;
                if(col === 'Utalized' || col === 'Average storage in the warehouse') return man.used;
                if(col === 'SAP') return man.sap;
                if(col === 'RSD') return man.rsd;
                if(col === 'POD pending') return man.pod;
                if(col === 'Return pending') return man.ret;
            }
            
            // Fallback to CSV
            if(!m)return 0; if(m.startsWith('ALL')) { const rows=rawData.filter(d=>d.Warehouse_Name.toUpperCase().includes(wh)); if(!rows.length) return 0; let s=0,c=0; rows.forEach(r=>{const v=parseNum(r[col]);if(r[col]&&!['NA','-',''].includes(r[col].toString().trim())){s+=v;c++;}}); return 0; /* Avg logic complex for strings */ } 
            // Find record by matching normalized month and warehouse
            const rec = rawData.find(d => {
                let monthVal = d.Report_Month;
                if (typeof monthVal === 'string' && !monthVal.includes('-') && monthVal.length >= 5) {
                    monthVal = monthVal.slice(0, 2) + '-' + monthVal.slice(2);
                }
                return monthVal === m && d.Warehouse_Name.toUpperCase().includes(wh);
            });
            if (!rec) return 0;
            return parseNum(rec[col]);
        }

        async function fetchGithub(file) { try { return await (await fetch(`${WORKER_URL}/api/github-get`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({filename:file})})).json(); } catch(e){return null;} }
        // Save a file to GitHub with automatic JSON stringification.
async function saveGithub(file, content) {
            try {
                let prepared = content;
                // If content is an object or array, stringify with indentation to preserve formatting
                if (content && typeof content === 'object') {
                    try {
                        prepared = JSON.stringify(content, null, 2);
                    } catch (e) {
                        // fallback: attempt stringify without formatting
                        prepared = JSON.stringify(content);
                    }
                }
                const res = await fetch(`${WORKER_URL}/api/github-save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: file, content: prepared, message: 'Update' })
                });

                if (res.ok) {
                    const indicator = document.getElementById('save-indicator');
                    if (indicator) {
                        indicator.classList.remove('hidden');
                        setTimeout(() => indicator.classList.add('hidden'), 2000);
                    }
                    return true;
                } else {
                    let msg = '';
                    try { msg = await res.text(); } catch(e) {}
                    Swal.fire('Save Failed', `GitHub/Worker error (${res.status}): ${msg || 'No details'}`, 'error');
                    return false;
                }
            } catch (e) {
                Swal.fire('Error', 'Token Issue', 'error');
                return false;
            }
        }
        // FIX: Silent refresh function modified to only update rawData and call init
        async function backgroundRefresh() {
            const updElem = document.getElementById('lastUpdateTxt');
            if (updElem) updElem.innerText = 'Auditingâ¦';
            try {
                // Use Promise.all to fetch data concurrently
                const [jsonData, empData, shiftsData, otData, customCardsData, masterShiftLogsData, manualMetricsData] = await Promise.all([
                    fetchGithub('WHSdata.json'),
                    fetchGithub('employees.json'),
                    fetchGithub('shifts.json'),
                    fetchGithub('overtime.json'),
                    fetchGithub('custom_cards.json'),
                    fetchGithub('shift_logs_master.json'),
                    fetchGithub('manual_metrics.json')
                ]);

                // Update global data structures without full UI refresh
                rawData = Array.isArray(jsonData) ? jsonData : [];
                normalizeWHSData(rawData);
                rawCSVData = rawData.map(r => ({ ...r }));
                
                employees = Array.isArray(empData) ? empData : [];
                shifts = (shiftsData && typeof shiftsData === 'object' && !Array.isArray(shiftsData)) ? shiftsData : {};
                overtime = Array.isArray(otData) ? otData : [];
                customCards = Array.isArray(customCardsData) ? customCardsData : [];
                masterShiftLogs = (typeof masterShiftLogsData === 'object' && masterShiftLogsData !== null) ? masterShiftLogsData : {};
                manualMetrics = (typeof manualMetricsData === 'object' && manualMetricsData !== null) ? manualMetricsData : {};

                // Re-initialize and re-render dashboard components based on new data
                init(); // Re-runs data processing and render
                renderWeekendTable(); // Also renders Log
                renderEmpTable();
                renderCustomCards();
                renderManagerLeaderboard();
                renderPalletsTable();
                renderPalletsHistoryTable();
                renderPalletsOverview();
                renderManagerReports();

                if (updElem) {
                    const now = new Date();
                    const h = String(now.getHours()).padStart(2,'0');
                    const m = String(now.getMinutes()).padStart(2,'0');
                    const s = String(now.getSeconds()).padStart(2,'0');
                    updElem.innerText = `Synced â¢ ${h}:${m}:${s}`;
                }
            } catch (e) {
                console.error('Background refresh error', e);
                if (updElem) updElem.innerText = 'Sync Error';
            }
        }

        function clearGrids() {
            sparklineInstances.forEach(c => c.destroy());
            sparklineInstances = [];
            ['row-orders','row-returns','storage-grid','quality-grid','inbound-cases-grid','inbound-pallets-grid','inbound-trucks-grid','outbound-cases-grid','outbound-pallets-grid','outbound-trucks-grid','outbound-10ton-grid','outbound-20ton-grid','rsd-grid','pod-pending-grid','return-pending-grid'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '';
            });
        }

        // Manual refresh: reload data from GitHub then refresh dashboard
        /**
         * Manually refresh all data from GitHub. Displays the loading overlay while running.
         */
        async function refreshAllData() {
             document.getElementById('loadingOverlayData').style.display = 'flex';
             await backgroundRefresh();
             document.getElementById('loadingOverlayData').style.display = 'none';
        }
        
        function createCard(id, t, v, u, diff, trendData, c, historyData) { 
            const clr={blue:'#3b82f6',green:'#10b981',orange:'#f97316',red:'#ef4444',brand:'#6366f1'}[c]||'#6366f1'; 
            const cid=`c-${Math.random().toString(36).substr(2,9)}`; 
            const target = document.getElementById(id);
            let historyHtml = '';
            if(historyData && historyData.length > 0) { historyData.forEach(h => { historyHtml += `<div class="flex justify-between text-xs text-white border-b border-white/10 pb-1 mb-1 last:border-0 last:mb-0"><span>${h.month}</span><span>${h.value.toLocaleString()}</span></div>`; }); } else { historyHtml = '<div class="text-xs text-slate-400 italic">No history available</div>'; }
            if (target) target.insertAdjacentHTML('beforeend', `<div class="glass-card rounded-2xl p-6 border-l-4 group relative" style="border-left-color:${clr}"><div class="flex justify-between mb-3"><div><h4 class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">${t}</h4><div class="flex items-baseline gap-2"><span class="text-3xl font-bold text-white num-font">${v}</span><span class="text-xs text-slate-500">${u}</span></div></div><div class="text-right"><div class="h-10 w-10 rounded-full bg-dark-800/50 flex items-center justify-center ml-auto mb-1"><i class="fas fa-chart-bar text-lg" style="color:${clr}"></i></div><span class="text-xs font-bold ${diff.cls} flex items-center justify-end gap-1"><i class="fas fa-${diff.icon}"></i> ${diff.val}</span></div></div><div class="sparkline-container"><canvas id="${cid}"></canvas></div><div class="absolute inset-0 bg-dark-900/95 backdrop-blur-sm z-20 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 p-4 rounded-2xl pointer-events-none"><h5 class="text-brand-400 text-xs font-bold uppercase mb-3 border-b border-brand-500/30 pb-1 w-full text-center">Last 3 Months</h5><div class="w-full space-y-1">${historyHtml}</div></div></div>`); 
            setTimeout(()=>{
                const ctx = document.getElementById(cid);
                if (ctx) {
                    // Use the last six months of the current monthList for labels
                    const labels = monthList.slice(Math.max(0, monthList.length - 6));
                    sparklineInstances.push(new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: trendData,
                                borderColor: clr,
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: { target: 'origin', above: clr + '15' }
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    display: true,
                                    ticks: {
                                        color: '#94a3b8',
                                        font: { size: 8 },
                                        autoSkip: true,
                                        maxRotation: 90,
                                        minRotation: 90
                                    },
                                    grid: { display: false }
                                },
                                y: {
                                    display: false
                                }
                            },
                            plugins: { legend: { display: false } }
                        }
                    }));
                }
            }, 50);
        }

        function parseNum(v) {
            if (v === null || v === undefined) return 'N/A';
            let s = v.toString().trim();
            if (!s || s === 'NA' || s === '-' || s.includes('<')) return 'N/A';
            const num = parseFloat(s.replace(/%/g, '').replace(/,/g, ''));
            return isNaN(num) ? 'N/A' : num;
        }

        // Normalize WHS data rows to ensure all expected fields exist.
        // This function augments each row with any missing keys required by the dashboard.
        function normalizeWHSData(arr) {
            if (!Array.isArray(arr)) return;
            const required = [
                'Report_Month','Warehouse_Name','Orders/Month','Returns','Capacity','Utalized',
                'Average storage in the warehouse','Shipment completed','Outbound Pallets','inbound Case',
                'Outbound Case','Inbound Pallets','On-Time Delivery','Order Fill Rate','Order Accuracy',
                'Correct Documentation','Customer Claims','Shipping utilization','Inbound Trucks 45 ft',
                'Outbound Trucks 45 ft','SAP','RSD','Difference','Percentage',
                'DEDICATED TRUCK 10 TON','DEDICATED TRUCK 45\'FT','TOTAL DESTINATIONS','TOTAL TRIPS',
                'POD pending','Return pending','Outbound_5_TON','Outbound_10_TON','Outbound_20_TON',
                'PROCEED_TOTAL_TRIPS','PROCEED_TOTAL_DESTINATIONS','DSV_TOTAL_TRIPS','DSV_TOTAL_DESTINATIONS'
            ];
            arr.forEach(row => {
                required.forEach(key => {
                    if (!Object.prototype.hasOwnProperty.call(row, key)) {
                        row[key] = '';
                    }
                });
            });
        }
        function formatNum(n) { return (n === null || n === undefined || !isFinite(n)) ? 'N/A' : n.toLocaleString('en-US'); } function calcDiff(c,p) { 
            if(p === 0) return { val: c > 0 ? '+100%' : '0%', icon: 'minus', cls: 'text-slate-500' };
            const val = ((c-p)/p*100); 
            return { val: Math.abs(val).toFixed(1)+'%', icon: val>=0?'arrow-up':'arrow-down', cls: val>=0?'text-green-400':'text-red-400' }; 
        }
        function getTrend(wh,col) { return monthList.slice(Math.max(0,monthList.length-6)).map(m=>getMetric(m,wh,col)); }
        function getLast3Months(wh, col) { const currentMonth = document.getElementById('monthSelect').value; const idx = monthList.indexOf(currentMonth); if(idx === -1) return []; const indices = []; for(let i = Math.max(0, idx-2); i <= idx; i++) { indices.push(i); } return indices.map(i => { const m = monthList[i]; return { month: m, value: getMetric(m, wh, col) }; }); }

        function renderOverview(c,p){
            selectedWarehouses.forEach(wh => {
                createCard('row-orders', wh, formatNum(getMetric(c,wh,'Orders/Month')), 'Orders', calcDiff(getMetric(c,wh,'Orders/Month'), getMetric(p,wh,'Orders/Month')), getTrend(wh,'Orders/Month'), 'blue', getLast3Months(wh, 'Orders/Month'));
                createCard('row-returns', wh, formatNum(getMetric(c,wh,'Returns')), 'Returns', calcDiff(getMetric(c,wh,'Returns'), getMetric(p,wh,'Returns')), getTrend(wh,'Returns'), 'red', getLast3Months(wh, 'Returns'));
            });
        }

        function renderStorage(c, p) {
            selectedWarehouses.forEach(wh => {
                const cap = getMetric(c, wh, 'Capacity');
                const used = getMetric(c, wh, 'Utalized'); 
                
                // Fixed Percentage Calculation
                let pct = 0;
                if (cap > 0 && used >= 0) {
                    pct = ((used / cap) * 100).toFixed(1);
                } else if (used > 0 && cap === 0) {
                    pct = 100; // Fallback
                }
                
                const prevCap = getMetric(p, wh, 'Capacity');
                const prevUsed = getMetric(p, wh, 'Utalized');
                let prevPct = 0;
                if(prevCap > 0 && prevUsed >= 0) {
                    prevPct = ((prevUsed / prevCap) * 100).toFixed(1);
                }

                const cid = `chart-storage-${wh.replace(/\s/g,'')}-${Math.random().toString(36).substr(2,5)}`;

                const html = `
                    <div class="glass-card rounded-2xl p-6 border-l-4 border-orange-500">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">${wh}</h4>
                                <div class="flex items-baseline gap-2 mt-1">
                                    <span class="text-3xl font-bold text-white num-font">${pct}%</span>
                                    <span class="text-xs text-slate-500">Utilized</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-slate-400 flex justify-between gap-4"><span>Capacity:</span> <span class="text-white font-mono font-bold">${formatNum(cap)}</span></p>
                                <p class="text-xs text-slate-400 flex justify-between gap-4"><span>Used:</span> <span class="text-white font-mono font-bold">${formatNum(used)}</span></p>
                            </div>
                        </div>
                        
                        <div class="w-full bg-dark-800 h-2 rounded-full overflow-hidden mb-4 relative">
                            <div class="bg-orange-500 h-full transition-all duration-500" style="width: ${Math.min(pct, 100)}%"></div>
                        </div>

                        <div class="h-24 w-full mt-2">
                            <canvas id="${cid}"></canvas>
                        </div>
                    </div>
                `;
                document.getElementById('storage-grid').insertAdjacentHTML('beforeend', html);

                setTimeout(() => {
                    const ctx = document.getElementById(cid);
                    if(ctx) {
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['Previous', 'Current'],
                                datasets: [{
                                    label: 'Utilization %',
                                    data: [prevPct, pct],
                                    backgroundColor: ['#334155', '#f97316'],
                                    borderRadius: 4,
                                    barThickness: 30
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    y: { beginAtZero: true, max: 100, grid: { color: '#1e293b' }, ticks: { display: false } },
                                    x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 10 } } }
                                }
                            }
                        });
                    }
                }, 50);
            });
        }

        function renderQuality(c, p) {
            selectedWarehouses.forEach(wh => {
                const el = document.getElementById('quality-grid');
                if (!el) return;
                const metrics = [
                    { name: 'On-Time Delivery', col: 'On-Time Delivery' },
                    { name: 'Order Fill Rate', col: 'Order Fill Rate' },
                    { name: 'Order Accuracy', col: 'Order Accuracy' },
                    { name: 'Correct Documentation', col: 'Correct Documentation' },
                    { name: 'Customer Claims', col: 'Customer Claims' },
                    { name: 'Shipping utilization', col: 'Shipping utilization' }
                ];
                let rowsHtml = '';
                metrics.forEach(m => {
                    const val = getMetric(c, wh, m.col, true);
                    const pct = val || 0;
                    rowsHtml += `
                        <div class="mb-2">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-slate-300">${m.name}</span>
                                <span class="font-bold text-white">${pct.toFixed(1)}%</span>
                            </div>
                            <div class="w-full bg-dark-700 h-1.5">
                                <div class="bg-green-500 h-1.5" style="width:${pct}%"></div>
                            </div>
                        </div>`;
                });
                el.insertAdjacentHTML('beforeend', `<div class="glass-card rounded-2xl p-6 border-l-4 border-green-500"><h4 class="text-slate-400 text-xs font-bold uppercase mb-4">${wh}</h4>${rowsHtml}</div>`);
            });
        }
        function renderInbound(c,p){ renderMetricGroup('inbound-cases-grid',c,p,'inbound Case','Box'); renderMetricGroup('inbound-pallets-grid',c,p,'Inbound Pallets','Plt'); renderMetricGroup('inbound-trucks-grid',c,p,'Inbound Trucks 45 ft','Trk'); }
        function renderOutbound(c,p){
            // Render metrics for outbound by warehouse
            renderMetricGroup('outbound-cases-grid', c, p, 'Outbound Case', 'Box');
            renderMetricGroup('outbound-pallets-grid', c, p, 'Outbound Pallets', 'Plt');
            renderMetricGroup('outbound-trucks-grid', c, p, 'Outbound Trucks 45 ft', '45ft');
            // Additional dedicated truck metrics (10 ton and 20 ton)
            renderMetricGroup('outbound-10ton-grid', c, p, 'DEDICATED TRUCK 10 TON', '10T');
            // For 20 ton we map to dedicated 45'FT column from dataset
            renderMetricGroup('outbound-20ton-grid', c, p, "DEDICATED TRUCK 45'FT", '20T');
        }
        function renderMetricGroup(id,c,p,col,u){
            selectedWarehouses.forEach(wh => {
                createCard(id, wh, formatNum(getMetric(c,wh,col)), u, calcDiff(getMetric(c,wh,col), getMetric(p,wh,col)), getTrend(wh,col), 'blue', getLast3Months(wh, col));
            });
        }
        function renderRSD(c,p){
            selectedWarehouses.forEach(wh => {
                const sap = getMetric(c, wh, 'SAP');
                const rsd = getMetric(c, wh, 'RSD');
                const diff = Math.abs(sap - rsd);
                const match = sap > 0 ? (100 - (diff/sap)*100) : 0;
                createCard('rsd-grid', wh, match.toFixed(1), '% Match', {val:'-', icon:'minus', cls:'text-slate-500'}, getTrend(wh,'SAP'), 'green', getLast3Months(wh, 'SAP'));
            });
        }
        function renderPending(c,p){
            selectedWarehouses.forEach(wh => {
                createCard('pod-pending-grid',wh,getMetric(c,wh,'POD pending'),'POD pending', calcDiff(getMetric(c,wh,'POD pending'), getMetric(p,wh,'POD pending')), getTrend(wh,'POD pending'), 'red', getLast3Months(wh, 'POD pending'));
                createCard('return-pending-grid',wh,getMetric(c,wh,'Return pending'),'Return pending', calcDiff(getMetric(c,wh,'Return pending'), getMetric(p,wh,'Return pending')), getTrend(wh,'Return pending'), 'red', getLast3Months(wh, 'Return pending'));
            });
        }
        function updateAllCharts() {
            // Destroy existing charts then render only the necessary charts (excluding SAP vs RSD)
            Object.keys(chartInstances).forEach(k => {
                if (chartInstances[k]) chartInstances[k].destroy();
                delete chartInstances[k];
            });
            const chartsToRender = [
                'chart-orders-trend',
                'chart-orders-dist',
                'chart-quality-comp',
                'chart-inbound-vol',
                'chart-inbound-trucks',
                'chart-outbound-vol',
                'chart-outbound-trucks',
                'chart-outbound-trips-comp',
                'chart-outbound-dest-comp'
            ];
            chartsToRender.forEach(id => renderSpecificChart(id, id));
        }
        function renderSpecificChart(type, targetId) {
            const ctx = document.getElementById(targetId);
            if (!ctx) return;
            let config = null;
            if (type === 'chart-inbound-vol') config = getBarConfig('Inbound Pallets');
            else if (type === 'chart-inbound-trucks') config = getBarConfig('Inbound Trucks 45 ft');
            else if (type === 'chart-outbound-vol') config = getBarConfig('Outbound Pallets');
            else if (type === 'chart-outbound-trucks') config = getBarConfig('Outbound Trucks 45 ft');
            else if (type === 'chart-orders-trend') config = getLineConfig('Orders/Month');
            else if (type === 'chart-orders-dist') config = getDoughnutConfig('Orders/Month');
            else if (type === 'chart-quality-comp') config = getGroupedBarConfig(['Order Accuracy', 'Order Fill Rate']);
            else if (type === 'chart-outbound-trips-comp') {
                // Comparative line chart for total trips (PROCEED vs DSV)
                config = {
                    type: 'line',
                    data: {
                        labels: monthList,
                        datasets: [
                            {
                                label: 'PROCEED Trips',
                                data: monthList.map(m => getMetric(m, 'PROCEED', 'PROCEED_TOTAL_TRIPS')),
                                borderColor: CHART_COLORS['PROCEED'] || '#10b981',
                                backgroundColor: (CHART_COLORS['PROCEED'] || '#10b981') + '30',
                                fill: false
                            },
                            {
                                label: 'DSV Trips',
                                data: monthList.map(m => getMetric(m, 'DSV', 'DSV_TOTAL_TRIPS')),
                                borderColor: CHART_COLORS['DSV'] || '#3b82f6',
                                backgroundColor: (CHART_COLORS['DSV'] || '#3b82f6') + '30',
                                fill: false
                            }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: '' } } }
                };
            } else if (type === 'chart-outbound-dest-comp') {
                // Comparative line chart for total destinations (PROCEED vs DSV)
                config = {
                    type: 'line',
                    data: {
                        labels: monthList,
                        datasets: [
                            {
                                label: 'PROCEED Destinations',
                                data: monthList.map(m => getMetric(m, 'PROCEED', 'PROCEED_TOTAL_DESTINATIONS')),
                                borderColor: CHART_COLORS['PROCEED'] || '#10b981',
                                backgroundColor: (CHART_COLORS['PROCEED'] || '#10b981') + '30',
                                fill: false
                            },
                            {
                                label: 'DSV Destinations',
                                data: monthList.map(m => getMetric(m, 'DSV', 'DSV_TOTAL_DESTINATIONS')),
                                borderColor: CHART_COLORS['DSV'] || '#3b82f6',
                                backgroundColor: (CHART_COLORS['DSV'] || '#3b82f6') + '30',
                                fill: false
                            }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: '' } } }
                };
            }
            // Exclude SAP vs RSD chart intentionally
            if (config) chartInstances[targetId] = new Chart(ctx, config);
        }
        function getBarConfig(col) {
            // Use selectedWarehouses for datasets to respect warehouse filter
            return {
                type: 'bar',
                data: {
                    labels: monthList,
                    datasets: selectedWarehouses.map(wh => ({
                        label: wh,
                        data: monthList.map(m => getMetric(m, wh, col)),
                        backgroundColor: CHART_COLORS[wh]
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true } }
                    ,
                    plugins: {
                        title: {
                            display: true,
                            text: col
                        }
                    }
                }
            };
        }
        function getLineConfig(col) {
            return {
                type: 'line',
                data: {
                    labels: monthList,
                    datasets: selectedWarehouses.map(wh => ({
                        label: wh,
                        data: monthList.map(m => getMetric(m, wh, col)),
                        borderColor: CHART_COLORS[wh]
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                    ,
                    plugins: {
                        title: {
                            display: true,
                            text: col
                        }
                    }
                }
            };
        }
        function getDoughnutConfig(col) {
            // Use selectedWarehouses for market share display
            const cur = document.getElementById('monthSelect').value;
            const labels = selectedWarehouses;
            const totals = labels.map(w => getMetric(cur, w, col));
            const bgColors = labels.map(w => CHART_COLORS[w]);
            return {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: totals,
                        backgroundColor: bgColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right',
                            labels: {
                                // FIX: Set legend label colors to white/slate for dark mode consistency
                                color: '#e2e8f0',
                                // FIX: Customize label text to remove the second line break issue on "Orders/Month"
                                generateLabels: function(chart) {
                                    const data = chart.data.datasets[0].data;
                                    return chart.data.labels.map((label, i) => {
                                        const value = data[i];
                                        return {
                                              text: `${label}: ${value.toLocaleString()}`,
  fillStyle: chart.data.datasets[0].backgroundColor[i],
  strokeStyle: chart.data.datasets[0].backgroundColor[i],
  index: i,
  fontColor: '#94a3b8',  
  color: '#94a3b8'       
                                            
                                        };
                                    });
                                }
                            }
                        }
                        ,
                        title: {
display: false
                        }
                    }
                }
            };
        }
        function getGroupedBarConfig(cols) {
            const cur = document.getElementById('monthSelect').value;
            // Build datasets for each metric column; use selectedWarehouses for labels/data
            const datasets = cols.map((col, idx) => ({
                label: col,
                data: selectedWarehouses.map(w => getMetric(cur, w, col, true)),
                backgroundColor: idx === 0 ? '#60a5fa' : '#34d399'
            }));
            return {
                type: 'bar',
                data: {
                    labels: selectedWarehouses,
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                    ,
                    plugins: {
                        title: {
                            display: true,
                            text: cols.join(' vs ')
                        }
                    }
                }
            };
        }
        async function addNewEmployee() { const { value: name } = await Swal.fire({ title: 'New Staff', input: 'text', background: '#1e293b', color: '#fff' }); if(name) { employees.push({name, id: Date.now()}); renderEmpTable(); saveGithub('employees.json', employees); } }
        function renderEmpTable() {
            // Build table rows for employees. The delete button triggers a confirmation dialog before removal
            const rows = employees.map((e, i) => {
                return `<tr class="border-b border-white/5 hover:bg-white/5">
                    <td class="p-4 text-white font-medium">${e.name}</td>
                    <td class="p-4 text-center">
                        <button onclick="confirmDelEmployee(${i})" class="text-red-400 hover:text-red-300 admin-only">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
            const body = document.getElementById('emp-table-body');
            if (body) body.innerHTML = rows;
        }
        function renderCSVEditor() {
            if (!rawCSVData || !rawCSVData.length) return;
            const headers = Object.keys(rawCSVData[0]);
            // Add an extra header for actions
            let html = `<thead><tr>` + headers.map(h => `<th class="p-3 bg-dark-800 text-slate-400 sticky top-0 border-b border-dark-600 font-bold whitespace-nowrap">${h}</th>`).join('') + `<th class="p-3 bg-dark-800 text-slate-400 sticky top-0 border-b border-dark-600 font-bold whitespace-nowrap">Actions</th></tr></thead><tbody>`;
            rawCSVData.forEach((row, i) => {
                html += `<tr class="hover:bg-dark-800/50 transition-colors">`;
                headers.forEach(key => {
                    html += `<td class="border-b border-dark-700 p-0"><input type="text" class="w-full bg-transparent p-2 outline-none num-font text-xs text-slate-300 focus:text-white focus:bg-brand-600/10" value="${row[key]}" onchange="updateCSVCell(${i}, '${key}', this.value)"></td>`;
                });
                // Delete button
                html += `<td class="border-b border-dark-700 p-0 text-center"><button onclick="deleteCSVRow(${i})" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button></td>`;
                html += `</tr>`;
            });
            html += '</tbody>';
            const tableEl = document.getElementById('csv-editor-table');
            if (tableEl) tableEl.innerHTML = html;
        }
        function updateCSVCell(idx, key, val) { rawCSVData[idx][key] = val; }
        async function saveCSV() {
            try {
                if (!rawCSVData || rawCSVData.length === 0) {
                    // Save empty JSON array
                    await saveGithub('WHSdata.json', []);
                } else {
                    await saveGithub('WHSdata.json', rawCSVData);
                }
                // FIX: Refresh local and remote data after save (only update raw data without full UI refresh)
                const updElem = document.getElementById('lastUpdateTxt');
                if (updElem) updElem.innerText = 'Auditingâ¦';
                await backgroundRefresh(); // Use silent background refresh to update data
                Swal.fire({ toast: true, icon: 'success', title: 'Data Saved', timer: 1500, position: 'top-end', showConfirmButton: false });
            } catch (err) {
                console.error('Save error', err);
                Swal.fire('Error', 'Failed to save data.', 'error');
            }
        }

        // Helper: Save pallets and closed pallets as JSON with history
        async function savePalletsJSON() {
            await saveGithub('pallets.json', pallets);
        }
        async function savePalletsClosedJSON() {
            await saveGithub('pallets_closed.json', palletsClosed);
        }

        // Import dataset via CSV file input. Parses the CSV and merges
        // rows into rawData/rawCSVData, adding any missing columns with
        // empty strings. After import, saves to WHSdata.json and reloads.
        async function importDatasetCSV(input) {
            const file = input.files && input.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: async function(results) {
                    try {
                        const rows = results.data;
                        let added = 0;
                        rows.forEach(row => {
                            // Normalize keys to match dataset keys (trim whitespace)
                            const obj = {};
                            Object.keys(row).forEach(k => {
                                const key = k.trim();
                                obj[key] = row[k];
                            });
                            // Normalize to ensure all required fields exist
                            normalizeWHSData([obj]);
                            rawData.push(obj);
                            added++;
                        });
                        rawCSVData = rawData.map(r => ({ ...r }));
                        await saveGithub('WHSdata.json', rawData);
                        // FIX: Use silent background refresh to update data
                        await backgroundRefresh();
                        Swal.fire({ toast:true, icon:'success', title:`Imported ${added} records from CSV`, timer:2000, position:'top-end', showConfirmButton:false });
                    } catch (err) {
                        console.error('CSV import error', err);
                        Swal.fire('Error','Failed to import CSV data','error');
                    }
                    input.value = '';
                }
            });
        }

        // Render the dynamic form used to add a new CSV row. It creates tab buttons
        // for each logical group of fields and builds input elements for every column.
        function renderCSVForm() {
            const tabsContainer = document.getElementById('csv-form-tabs');
            const contentsContainer = document.getElementById('csv-form-contents');
            if (!rawCSVData || !tabsContainer || !contentsContainer) return;
            // If dataset is empty, create a placeholder row with required fields so form can render
            if (rawCSVData.length === 0) {
                rawCSVData = [{}];
                // Normalize to ensure all keys exist
                normalizeWHSData(rawCSVData);
            }

            // Add additional outbound truck and destination fields if missing
            const additionalFields = [
                'Outbound_5_TON', 'Outbound_10_TON', 'Outbound_20_TON',
                'PROCEED_TOTAL_TRIPS', 'PROCEED_TOTAL_DESTINATIONS',
                'DSV_TOTAL_TRIPS', 'DSV_TOTAL_DESTINATIONS'
            ];
            if (rawCSVData && rawCSVData.length > 0) {
                additionalFields.forEach(f => {
                    if (!rawCSVData[0].hasOwnProperty(f)) {
                        rawCSVData.forEach(row => { row[f] = ''; });
                    }
                });
            }
            // Determine categories by grouping column names
            const allColumns = Object.keys(rawCSVData[0]);
            const categories = {
                General: [],
                Inbound: [],
                Outbound: [],
                Quality: [],
                Finance: [],
                Pending: []
            };
            allColumns.forEach(col => {
                const lower = col.toLowerCase();
                if (lower.includes('inbound')) categories.Inbound.push(col);
                else if (lower.includes('outbound') || lower.includes('_ton') || lower.includes('_trips') || lower.includes('_destinations')) categories.Outbound.push(col);
                else if (['order accuracy','order fill rate','on-time delivery','correct documentation','customer claims'].some(s => lower.includes(s))) categories.Quality.push(col);
                else if (['sap','rsd','difference','percentage'].some(s => lower.includes(s))) categories.Finance.push(col);
                else if (lower.includes('pending')) categories.Pending.push(col);
                else categories.General.push(col);
            });

            // Build tab buttons
            tabsContainer.innerHTML = '';
            Object.keys(categories).forEach((cat, idx) => {
                const btn = document.createElement('button');
                btn.textContent = cat;
                btn.className = 'bg-dark-800 text-slate-400 px-3 py-1 rounded text-xs font-bold';
                if (idx === 0) btn.classList.add('csv-tab-active');
                btn.onclick = () => selectCSVFormTab(cat);
                tabsContainer.appendChild(btn);
            });

            // Build content for each category
            contentsContainer.innerHTML = '';
            Object.keys(categories).forEach((cat, idx) => {
                const section = document.createElement('div');
                section.id = `csv-form-section-${cat}`;
                section.style.display = idx === 0 ? 'grid' : 'none';
                section.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';

                categories[cat].forEach(col => {
                    const wrapper = document.createElement('div');
                    const label = document.createElement('label');
                    label.className = 'text-[10px] text-slate-500 uppercase block mb-1';
                    label.textContent = col.replace(/_/g, ' ');
                    // Input type: month for Report_Month, select for Warehouse_Name
                    let input;
                    if (col === 'Report_Month') {
                        input = document.createElement('input');
                        input.type = 'month';
                        input.id = `csv-form-${col}`;
                        input.className = 'w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm';
                    } else if (col === 'Warehouse_Name') {
                        input = document.createElement('select');
                        input.id = `csv-form-${col}`;
                        input.className = 'w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm';
                        // Populate with unique warehouse list
                        WH_ORDER.forEach(w => {
                            const opt = document.createElement('option');
                            opt.value = w;
                            opt.textContent = w;
                            input.appendChild(opt);
                        });
                    } else {
                        input = document.createElement('input');
                        input.type = 'text';
                        input.id = `csv-form-${col}`;
                        input.className = 'w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm';
                    }
                    wrapper.appendChild(label);
                    wrapper.appendChild(input);
                    section.appendChild(wrapper);
                });
                contentsContainer.appendChild(section);
            });

            // Attach warehouse change handler to toggle TOT fields visibility
            const whSel = document.getElementById('csv-form-Warehouse_Name');
            if (whSel) {
                whSel.onchange = toggleTotFields;
                // Initial call to set visibility based on default selection
                setTimeout(() => toggleTotFields(), 0);
            }
        }

        // Toggle visibility of Total Trips/Destinations fields based on selected warehouse
        function toggleTotFields() {
            const whSelect = document.getElementById('csv-form-Warehouse_Name');
            if (!whSelect) return;
            const wh = whSelect.value;
            // Get wrappers for PROCEED and DSV total fields
            const pTrip = document.getElementById('csv-form-PROCEED_TOTAL_TRIPS');
            const pDest = document.getElementById('csv-form-PROCEED_TOTAL_DESTINATIONS');
            const dTrip = document.getElementById('csv-form-DSV_TOTAL_TRIPS');
            const dDest = document.getElementById('csv-form-DSV_TOTAL_DESTINATIONS');
            const pTripWrap = pTrip ? pTrip.parentElement : null;
            const pDestWrap = pDest ? pDest.parentElement : null;
            const dTripWrap = dTrip ? dTrip.parentElement : null;
            const dDestWrap = dDest ? dDest.parentElement : null;
            // Show/hide based on warehouse selection
            // For SPIMACO, hide all total trips/destination fields since they apply only to PROCEED and DSV
            if (wh === 'SPIMACO') {
                if (pTripWrap) pTripWrap.style.display = 'none';
                if (pDestWrap) pDestWrap.style.display = 'none';
                if (dTripWrap) dTripWrap.style.display = 'none';
                if (dDestWrap) dDestWrap.style.display = 'none';
            } else if (wh === 'PROCEED') {
                if (pTripWrap) pTripWrap.style.display = '';
                if (pDestWrap) pDestWrap.style.display = '';
                if (dTripWrap) dTripWrap.style.display = 'none';
                if (dDestWrap) dDestWrap.style.display = 'none';
            } else if (wh === 'DSV') {
                if (dTripWrap) dTripWrap.style.display = '';
                if (dDestWrap) dDestWrap.style.display = '';
                if (pTripWrap) pTripWrap.style.display = 'none';
                if (pDestWrap) pDestWrap.style.display = 'none';
            } else {
                // default: hide everything
                if (pTripWrap) pTripWrap.style.display = 'none';
                if (pDestWrap) pDestWrap.style.display = 'none';
                if (dTripWrap) dTripWrap.style.display = 'none';
                if (dDestWrap) dDestWrap.style.display = 'none';
            }

            // Update visibility of certain dashboard sections based on selected warehouse
            updateSectionVisibility();
        }

        // Show or hide sections that are exclusive to SPIMACO when other warehouses are selected
        function updateSectionVisibility() {
            const showExtra = !(selectedWarehouses.length === 1 && selectedWarehouses[0] !== 'SPIMACO');
            const ids = ['shift-log-display', 'pallets-summary', 'monthly-schedule'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    // Check if role permissions allow this element to be shown regardless of warehouse filter
                    const isAllowedByRole = permissions[currentUser.role]?.cards?.[id] !== false;

                    if (showExtra && isAllowedByRole) {
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                }
            });
        }

        // Switch to a different tab in the record form
        function selectCSVFormTab(cat) {
            const tabs = document.querySelectorAll('#csv-form-tabs button');
            tabs.forEach(btn => {
                if (btn.textContent === cat) {
                    btn.classList.add('csv-tab-active');
                } else {
                    btn.classList.remove('csv-tab-active');
                }
            });
            const sections = document.querySelectorAll('#csv-form-contents > div');
            sections.forEach(sec => {
                if (sec.id === `csv-form-section-${cat}`) {
                    sec.style.display = 'grid';
                } else {
                    sec.style.display = 'none';
                }
            });
        }

        // Format input month (YYYY-MM) to dataset style (YY-MMM e.g. 2024-01 -> 24-Jan)
        function formatMonthInput(val) {
            if (!val) return '';
            const [y, m] = val.split('-');
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            return `${y.slice(2)}-${months[parseInt(m,10)-1]}`;
        }

        // Add a new row to the CSV data based on the form inputs
        async function addCSVRow() {
            if (!rawCSVData || rawCSVData.length === 0) return;
            const newRow = {};
            Object.keys(rawCSVData[0]).forEach(col => {
                const input = document.getElementById(`csv-form-${col}`);
                if (!input) return;
                let val = input.value;
                if (col === 'Report_Month') val = formatMonthInput(val);
                newRow[col] = val;
            });
            // Replace placeholder row if dataset only contains an empty template
            if (rawCSVData.length === 1 && Object.values(rawCSVData[0]).every(v => v === '')) {
                rawCSVData[0] = newRow;
            } else {
                rawCSVData.push(newRow);
            }
            await saveCSV();
            renderCSVEditor();
            // Clear form fields
            Object.keys(rawCSVData[0]).forEach(col => {
                const input = document.getElementById(`csv-form-${col}`);
                if (input) input.value = '';
            });
            Swal.fire({ toast:true, icon:'success', title:'Row Added', timer:1500, position:'top-end', showConfirmButton:false });
        }

        // Delete a row from the CSV editor with confirmation
        async function deleteCSVRow(idx) {
            const res = await Swal.fire({
                title: 'Are you sure?',
                text: 'This will remove the row permanently.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it',
                cancelButtonText: 'No, keep it',
                background: '#1e293b',
                color: '#fff'
            });
            if (res.isConfirmed) {
                rawCSVData.splice(idx, 1);
                await saveCSV();
                renderCSVEditor();
                Swal.fire({ toast:true, icon:'success', title:'Row deleted', timer:1500, position:'top-end', showConfirmButton:false });
            }
        }

        // Render warehouse filter checkboxes near month dropdown
        function renderWarehouseFilters() {
            const container = document.getElementById('warehouse-filter');
            if (!container) return;
            container.innerHTML = '';
            WH_ORDER.forEach(wh => {
                const label = document.createElement('label');
                label.className = 'flex items-center gap-1';
                const chk = document.createElement('input');
                chk.type = 'checkbox';
                chk.checked = selectedWarehouses.includes(wh);
                chk.onchange = () => toggleWarehouseFilter(wh);
                const span = document.createElement('span');
                span.textContent = wh;
                span.className = 'text-xs';
                label.appendChild(chk);
                label.appendChild(span);
                container.appendChild(label);
            });
        }

        function toggleWarehouseFilter(wh) {
            if (selectedWarehouses.includes(wh)) {
                selectedWarehouses = selectedWarehouses.filter(w => w !== wh);
            } else {
                selectedWarehouses.push(wh);
            }
            // Ensure at least one warehouse is selected; if none selected, reset to all
            if (selectedWarehouses.length === 0) {
                selectedWarehouses = [...WH_ORDER];
            }
            render();
        }

        // The doughnut chart legend is configured in the base function definition below.

        // Modify shift scheduler labels (tool palette) to use 1st, 2nd, 3rd instead of M, E, N
        // We'll adjust CSS classes accordingly; also adjust legend colors
        document.addEventListener('DOMContentLoaded', () => {
            // Update matrix legend labels if they exist
            const legend = document.getElementById('tool-legend');
            if (legend) {
                legend.querySelectorAll('span').forEach(span => {
                    if (span.textContent.includes('M')) span.textContent = span.textContent.replace('M', '1st');
                    if (span.textContent.includes('E')) span.textContent = span.textContent.replace('E', '2nd');
                    if (span.textContent.includes('N')) span.textContent = span.textContent.replace('N', '3rd');
                });
            }
        });

        // Confirm deletion of employees from directory
        async function confirmDelEmployee(index) {
            const res = await Swal.fire({
                title: 'Delete employee?',
                text: 'This action cannot be undone.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete',
                cancelButtonText: 'Cancel',
                background: '#1e293b',
                color: '#fff'
            });
            if (res.isConfirmed) {
                employees.splice(index, 1);
                await saveGithub('employees.json', employees);
                renderEmpTable();
                Swal.fire({ toast:true, icon:'success', title:'Deleted', timer:1500, position:'top-end', showConfirmButton:false });
            }
        }

        // =============== Damage Reports & Pallets Functions ===============

        // Submit a new damaged product report
        async function submitDamageReport() {
            const product = document.getElementById('damage-product').value.trim();
            const batch = document.getElementById('damage-batch').value.trim();
            const qty = parseInt(document.getElementById('damage-qty').value);
            const notes = document.getElementById('damage-notes').value.trim();
            const imgInput = document.getElementById('damage-image');
            if (!product || !batch || !qty) {
                Swal.fire('Missing Data', 'Please enter product, batch and quantity.', 'warning');
                return;
            }
            let imageData = null;
            if (imgInput && imgInput.files && imgInput.files[0]) {
                // Read image as base64
                imageData = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(imgInput.files[0]);
                });
            }
            const report = {
                date: new Date().toISOString(),
                product,
                batch,
                qty,
                notes,
                image: imageData,
                reporter: currentUser.username // FIX: Added reporter username
            };
            damageReports.push(report);
            await saveGithub('damage_reports.json', damageReports);
            renderManagerReports();
            // Reset form
            document.getElementById('damage-product').value = '';
            document.getElementById('damage-batch').value = '';
            document.getElementById('damage-qty').value = '';
            document.getElementById('damage-notes').value = '';
            if (imgInput) imgInput.value = '';
            Swal.fire({ toast:true, icon:'success', title:'Report Submitted', timer:1500, position:'top-end', showConfirmButton:false });
        }

        // Render manager reports table
        async function renderManagerReports() {
            const body = document.getElementById('incident-table-body');
            if (!body) return;
            // If no damage reports loaded, attempt to load from GitHub again
            if (!damageReports || damageReports.length === 0) {
                try {
                    const dr = await fetchGithub('damage_reports.json');
                    if (Array.isArray(dr)) damageReports = dr;
                } catch(e) {
                    // ignore
                }
            }
            body.innerHTML = '';
            damageReports.forEach((r, i) => {
                const date = new Date(r.date);
                const dateStr = date.toLocaleDateString('en-GB');
                const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const imgPreview = r.image ? `<img src="${r.image}" alt="img" class="h-10 w-10 object-cover rounded"/>` : '<i class="fas fa-image text-slate-500 text-lg"></i>';
                // FIX: Changed button to open modal for details instead of downloading doc
                body.insertAdjacentHTML('beforeend', `
                    <tr class="border-b border-dark-700 hover:bg-dark-800/50">
                        <td class="p-3">${dateStr} ${timeStr}</td>
                        <td class="p-3">${r.product}</td>
                        <td class="p-3">${r.batch}</td>
                        <td class="p-3 text-right">${r.qty}</td>
                        <td class="p-3 text-center">${imgPreview}</td>
                        <td class="p-3 text-center"><button onclick="openIncidentDetailsModal(${i})" class="bg-indigo-600 hover:bg-indigo-500 text-white px-2 py-1 rounded text-xs font-bold">Details</button></td>
                    </tr>
                `);
            });
        }
        
        // FIX: New function to open incident details modal
        function openIncidentDetailsModal(idx) {
            const report = damageReports[idx];
            if (!report) return;
            const modal = document.getElementById('incidentDetailModal');
            const content = document.getElementById('incidentDetailModalContent');
            const date = new Date(report.date);

            let html = `
                <div class="space-y-3">
                    <p class="text-xs text-slate-400 uppercase">Reported by: <span class="font-bold text-white">${report.reporter || 'N/A'}</span></p>
                    <p class="text-xs text-slate-400 uppercase">Date/Time: <span class="font-bold text-white">${date.toLocaleDateString('en-GB')} @ ${date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</span></p>
                    <hr class="border-dark-700">
                    <p class="text-sm font-bold text-white">Product: <span class="font-normal text-slate-300">${report.product}</span></p>
                    <p class="text-sm font-bold text-white">Batch: <span class="font-normal text-slate-300">${report.batch}</span></p>
                    <p class="text-sm font-bold text-white">Quantity: <span class="font-normal text-slate-300">${report.qty}</span></p>
                    <hr class="border-dark-700">
                    <p class="text-sm font-bold text-white mb-2">Notes:</p>
                    <div class="bg-dark-800 p-3 rounded-lg text-slate-300 whitespace-pre-wrap">${report.notes || 'No notes provided.'}</div>
            `;
            if (report.image) {
                html += `
                    <p class="text-sm font-bold text-white pt-2">Image:</p>
                    <div class="flex justify-center"><img src="${report.image}" alt="Damage Image" class="w-full max-w-sm rounded-lg border border-dark-700"></div>
                `;
            }
            html += `</div>`;

            content.innerHTML = html;
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        // Download a Word document for a given report
        async function downloadReportDoc(idx) {
            const { Document, Packer, Paragraph, TextRun, ImageRun } = docx;
            const report = damageReports[idx];
            if (!report) return;
            const sections = [];
            const children = [];
            // Title
            children.push(new Paragraph({
                children: [new TextRun({ text: 'Damaged Product Report', bold: true, size: 32 })],
                alignment: 'center'
            }));
            children.push(new Paragraph({ text: '' }));
            // Details
            children.push(new Paragraph({ children: [new TextRun({ text: `Date: ${new Date(report.date).toLocaleString()}`, size: 24 })] }));
            children.push(new Paragraph({ children: [new TextRun({ text: `Product: ${report.product}`, size: 24 })] }));
            children.push(new Paragraph({ children: [new TextRun({ text: `Batch: ${report.batch}`, size: 24 })] }));
            children.push(new Paragraph({ children: [new TextRun({ text: `Quantity: ${report.qty}`, size: 24 })] }));
            children.push(new Paragraph({ children: [new TextRun({ text: `Notes: ${report.notes || 'N/A'}`, size: 24 })] }));
            // Image if exists
            if (report.image) {
                children.push(new Paragraph({ text: '' }));
                children.push(new Paragraph({
                    children: [
                        new ImageRun({ data: report.image, transformation: { width: 500, height: 300 } })
                    ]
                }));
            }
            sections.push({ children });
            const doc = new Document({ sections });
            const blob = await Packer.toBlob(doc);
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `damage-report-${idx + 1}.docx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Render pallets table (Open POs)
        function renderPalletsTable() {
            const body = document.getElementById('pallets-table-body');
            if (!body) return;
            body.innerHTML = '';
            // Filter by search term if provided
            const searchVal = document.getElementById('pallets-search-open') ? document.getElementById('pallets-search-open').value.toLowerCase() : '';
            pallets.forEach((p, i) => {
                if (searchVal && !p.po.toLowerCase().includes(searchVal)) return;
                // Main row for PO
                body.insertAdjacentHTML('beforeend', `
                <tr class="border-b border-dark-700 hover:bg-dark-800/50">
                        <td class="p-3">${p.po}</td>
                        <td class="p-3 capitalize">${p.type}</td>
                        <td class="p-3 text-right">${p.qty}</td>
                        <td class="p-3 text-center"><button onclick="usePO(${i})" class="bg-red-600 hover:bg-red-500 text-white px-2 py-1 rounded text-xs font-bold">Use</button></td>
                    </tr>
                `);
            });
        }

        // Render closed pallets history table
        function renderPalletsHistoryTable() {
            const body = document.getElementById('pallets-history-body');
            if (!body) return;
            body.innerHTML = '';
            const searchVal = document.getElementById('pallets-search-history') ? document.getElementById('pallets-search-history').value.toLowerCase() : '';

            palletsClosed.forEach(po => {
                if (searchVal && !po.po.toLowerCase().includes(searchVal)) return;
                // Calculate total used
                const totalUsed = Array.isArray(po.history) ? po.history.reduce((sum, h) => sum + h.used, 0) : 0;
                
                body.insertAdjacentHTML('beforeend', `
                    <tr class="border-b border-dark-700 hover:bg-dark-800/50">
                        <td class="p-3">${po.po}</td>
                        <td class="p-3 capitalize">${po.type}</td>
                        <td class="p-3">${totalUsed}</td>
                        <td class="p-3 text-center"><button onclick="openPOHistoryModal('${po.po}')" class="bg-brand-600 hover:bg-brand-500 text-white px-2 py-1 rounded text-xs font-bold">View</button></td>
                    </tr>
                `);
            });
        }

        // FIX: New function to open PO history details modal
        function openPOHistoryModal(poNumber) {
            const po = palletsClosed.find(p => p.po === poNumber);
            if (!po) return;

            const modal = document.getElementById('poHistoryModal');
            const title = document.getElementById('poHistoryModalTitle');
            const content = document.getElementById('poHistoryModalContent');

            title.textContent = `PO: ${po.po} (${po.type.toUpperCase()})`;

            let historyHtml = '<div class="space-y-4">';
            if (Array.isArray(po.history) && po.history.length > 0) {
                historyHtml += `<h4 class="text-lg font-bold text-white">Transaction Log</h4>`;
                po.history.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(h => {
                    const date = new Date(h.date);
                    historyHtml += `
                        <div class="bg-dark-800 p-4 rounded-lg border border-dark-700">
                            <p class="text-xs text-slate-400">Date/Time: <span class="font-mono text-white">${date.toLocaleString('en-GB')}</span></p>
                            <p class="text-sm font-bold text-red-400">Used: <span class="font-mono text-red-200">${h.used}</span></p>
                            <p class="text-xs text-slate-400">Remaining: <span class="font-mono text-white">${h.remaining}</span></p>
                            <p class="text-xs text-slate-400">Action By: <span class="font-bold text-white">${h.user || 'N/A'}</span></p>
                        </div>
                    `;
                });
            } else {
                historyHtml += `<p class="text-slate-400 italic">No history recorded for this PO.</p>`;
            }
            historyHtml += '</div>';

            content.innerHTML = historyHtml;
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        // Add a new PO for pallets
        async function addPO() {
            const po = document.getElementById('po-number').value.trim();
            const type = document.getElementById('po-type').value;
            const qty = parseInt(document.getElementById('po-qty').value);
            if (!po || !qty || qty <= 0) {
                Swal.fire('Missing Data', 'Please enter PO number and positive quantity.', 'warning');
                return;
            }
            // Add to pallets array and include history array for JSON storage
            pallets.push({ po, type, qty, history: [] });
            await savePalletsJSON();
            renderPalletsTable();
            renderPalletsOverview();
            // Reset form
            document.getElementById('po-number').value = '';
            document.getElementById('po-qty').value = '';
            Swal.fire({ toast:true, icon:'success', title:'PO Added', timer:1500, position:'top-end', showConfirmButton:false });
        }

        // Deduct quantity from a PO
        async function usePO(index) {
            const po = pallets[index];
            if (!po) return;
            const { value: qtyStr } = await Swal.fire({
                title: `Use pallets from PO ${po.po}`,
                input: 'number',
                inputLabel: 'Quantity to use',
                inputAttributes: { min: 1, max: po.qty, step: 1 },
                showCancelButton: true,
                confirmButtonText: 'Confirm',
                background: '#1e293b',
                color: '#fff'
            });
            if (!qtyStr) return;
            const qty = parseInt(qtyStr);
            if (qty <= 0 || qty > po.qty) {
                Swal.fire('Invalid', 'Quantity not valid.', 'warning');
                return;
            }
            // Deduct quantity and record history
            po.qty -= qty;
            // Append history entry
            if (!Array.isArray(po.history)) po.history = [];
            po.history.push({ date: new Date().toISOString(), user: currentUser.username || '', used: qty, remaining: po.qty });
                if (po.qty === 0) {
                    // Move to closed list with history and remove from pallets
                    palletsClosed.push({ po: po.po, type: po.type, qty: 0, history: po.history });
                    pallets.splice(index, 1);
                    // Save both open and closed lists
                    await savePalletsJSON();
                    await savePalletsClosedJSON();
                } else {
                    // Save updated pallets history for this PO and open list
                    await savePalletsJSON();
                }
                renderPalletsTable();
                renderPalletsHistoryTable();
                renderPalletsOverview();
                Swal.fire({ toast:true, icon:'success', title:'Pallets deducted', timer:1500, position:'top-end', showConfirmButton:false });
        }

        // Render pallets overview summary on dashboard
        function renderPalletsOverview() {
            let euroTotal = 0;
            let usedTotal = 0;
            pallets.forEach(p => {
                if (p.type === 'euro') euroTotal += p.qty;
                else usedTotal += p.qty;
            });
            const euroEl = document.getElementById('pallets-euro-count');
            const usedEl = document.getElementById('pallets-used-count');
            if (euroEl) euroEl.textContent = euroTotal;
            if (usedEl) usedEl.textContent = usedTotal;
        }

        // Presentation Mode Functions (LIVE DECK - no html2canvas)
        let presentationActive = false;
        let presentationIndex = 0;
        let presentationInterval = null;
        let presentationOrder = [];
        let presentationOverlay = null;

        // ÙØ®Ø²Ù ÙÙØ§Ù ÙÙ Ø³ÙØ´Ù Ø¹Ø´Ø§Ù ÙØ±Ø¬Ø¹Ù Ø¨Ø¹Ø¯ Ø§ÙØ®Ø±ÙØ¬
        const presentationRestore = new Map();

        function getPresentationSections() {
            // ÙÙØ³ ÙÙØ·ÙÙ Ø§ÙÙØ¯ÙÙ (Ø¨Ø³ Ø¨Ø¯ÙÙ permissions Ø§ÙÙÙØ³ÙØ±Ø© Ø¨Ù "...")
            const defaultSlides = ['overview','storage','quality','inbound','outbound','finance','pending'];

            // ÙÙ Ø¹ÙØ¯Ù permissions Ø´ØºØ§Ù ÙØ¹ÙØ§ÙØ ÙØ·Ø¨ÙÙÙØ ÙØ¥ÙØ§ Ø¨ÙÙØ´Ù Ø¹ÙÙ defaultSlides
            let sectionIds = [];
            try {
                const slideConfig =
                    (typeof permissions !== 'undefined' && permissions && currentUser && currentUser.role
                     && permissions[currentUser.role] && permissions[currentUser.role].slides)
                    ? permissions[currentUser.role].slides
                    : null;

                defaultSlides.forEach(id => {
                    if (!slideConfig || slideConfig[id] !== false) sectionIds.push(id);
                });
            } catch (e) {
                sectionIds = defaultSlides.slice();
            }

            // ÙÙØªØ±Ø©: ÙÙØ· Ø§ÙÙÙ ÙÙØ¬ÙØ¯ ÙØ¹ÙØ§Ù ÙÙ Ø§ÙØµÙØ­Ø©
            sectionIds = sectionIds.filter(id => document.getElementById(id));

            return sectionIds;
        }

        function setupPresentationOverlay() {
            presentationOverlay = document.createElement('div');
            presentationOverlay.id = 'presentation-overlay';
            presentationOverlay.style.cssText = `
                position:fixed; inset:0; z-index:99999;
                background:#020617; padding:16px 20px;
                overflow:hidden;
            `;

            presentationOverlay.innerHTML = `
                <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;">
                    <div id="pres-title" style="color:white; font-weight:700; font-size:14px; opacity:.9;">Presentation</div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button id="pres-prev" style="background:#111827;color:white;padding:8px 12px;border-radius:10px;border:1px solid #334155;">Prev</button>
                        <button id="pres-next" style="background:#111827;color:white;padding:8px 12px;border-radius:10px;border:1px solid #334155;">Next</button>
                        <button id="pres-auto" style="background:#0f172a;color:white;padding:8px 12px;border-radius:10px;border:1px solid #334155;">Auto</button>
                        <button id="pres-exit" style="background:#b91c1c;color:white;padding:8px 12px;border-radius:10px;border:1px solid #7f1d1d;">Exit</button>
                    </div>
                </div>

                <div id="presentation-stage" style="
                    position:relative;
                    width:100%;
                    height:calc(100vh - 70px);
                    overflow:auto;
                    background:#0b1220;
                    border:1px solid #1f2a44;
                    border-radius:14px;
                    padding:12px;
                "></div>
            `;

            document.body.appendChild(presentationOverlay);
        }

        function fitSlideToScreen(el) {
            el.style.transformOrigin = 'top left';
            el.style.transform = 'none';

            const vw = window.innerWidth - 40;
            const vh = window.innerHeight - 120;

            const rect = el.getBoundingClientRect();
            const scaleX = vw / rect.width;
            const scaleY = vh / rect.height;
            const scale = Math.min(scaleX, scaleY, 1);

            el.style.transform = `scale(${scale})`;
        }

        function showLiveSlide(i) {
            const id = presentationOrder[i];
            const target = document.getElementById(id);
            if (!target) return;

            // Ø£Ø®ÙÙ Ø§ÙÙÙ ÙØ§Ø¸ÙØ± Ø§ÙØ­Ø§ÙÙ
            presentationOrder.forEach(sid => {
                const el = document.getElementById(sid);
                if (el) el.style.display = 'none';
            });

            target.style.display = 'block';
            fitSlideToScreen(target);

            const title = presentationOverlay.querySelector('#pres-title');
            if (title) title.textContent = `Slide ${i + 1} / ${presentationOrder.length} â ${id}`;
        }

        function presentationKeyHandler(e) {
            if (!presentationOverlay) return;

            if (e.key === 'Escape') stopPresentation();
            if (e.key === 'ArrowRight') {
                presentationIndex = (presentationIndex + 1) % presentationOrder.length;
                showLiveSlide(presentationIndex);
            }
            if (e.key === 'ArrowLeft') {
                presentationIndex = (presentationIndex - 1 + presentationOrder.length) % presentationOrder.length;
                showLiveSlide(presentationIndex);
            }
        }

        function presentationResizeHandler() {
            if (!presentationOverlay) return;
            showLiveSlide(presentationIndex);
        }

        function bindPresentationControls() {
            const prevBtn = presentationOverlay.querySelector('#pres-prev');
            const nextBtn = presentationOverlay.querySelector('#pres-next');
            const autoBtn = presentationOverlay.querySelector('#pres-auto');
            const exitBtn = presentationOverlay.querySelector('#pres-exit');

            prevBtn.onclick = () => {
                presentationIndex = (presentationIndex - 1 + presentationOrder.length) % presentationOrder.length;
                showLiveSlide(presentationIndex);
            };

            nextBtn.onclick = () => {
                presentationIndex = (presentationIndex + 1) % presentationOrder.length;
                showLiveSlide(presentationIndex);
            };

            autoBtn.onclick = () => {
                if (presentationInterval) {
                    clearInterval(presentationInterval);
                    presentationInterval = null;
                    autoBtn.textContent = 'Auto';
                } else {
                    presentationInterval = setInterval(() => {
                        presentationIndex = (presentationIndex + 1) % presentationOrder.length;
                        showLiveSlide(presentationIndex);
                    }, 6000);
                    autoBtn.textContent = 'Stop';
                }
            };

            exitBtn.onclick = stopPresentation;

            window.addEventListener('keydown', presentationKeyHandler);
            window.addEventListener('resize', presentationResizeHandler);
        }

        async function startPresentation() {
            if (presentationActive) return;
            presentationActive = true;

            // Ø­Ø¯Ø« Ø§ÙØ¨ÙØ§ÙØ§Øª ÙØ§ÙØ±Ø³ÙÙ ÙØ¨Ù Ø§ÙØ¯Ø®ÙÙ
            try {
                if (typeof backgroundRefresh === 'function') await backgroundRefresh();
                if (typeof updateAllCharts === 'function') updateAllCharts();
            } catch (e) {}

            presentationOrder = getPresentationSections();

            if (!presentationOrder.length) {
                presentationActive = false;
                return Swal.fire('Error', 'No sections are configured for presentation mode.', 'warning');
            }

            setupPresentationOverlay();
            bindPresentationControls();

            const stage = presentationOverlay.querySelector('#presentation-stage');

            // ÙÙÙÙ Ø§ÙØ³ÙØ§Ø´Ù Ø§ÙØ­ÙÙÙÙØ© ÙÙÙ stage (ÙØ§ÙÙ) ÙÙØ­ÙØ¸ Ø£ÙØ§ÙÙÙØ§ Ø§ÙØ£ØµÙÙØ©
            presentationOrder.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;

                const placeholder = document.createComment(`restore:${id}`);
                el.parentNode.insertBefore(placeholder, el);

                presentationRestore.set(id, { placeholder, originalParent: placeholder.parentNode });

                stage.appendChild(el);
                el.style.margin = '0';
                el.style.display = 'none';
            });

            // Ø¹Ø±Ø¶ Ø£ÙÙ Ø´Ø±ÙØ­Ø©
            presentationIndex = 0;
            showLiveSlide(presentationIndex);

            // ØªØ­Ø¯ÙØ« Ø¯ÙØ±Ù (Ø¨Ø¯ÙÙ ØªØµÙÙØ±)
            window.presentationUpdateInterval = setInterval(async () => {
                try {
                    if (typeof backgroundRefresh === 'function') await backgroundRefresh();
                    if (typeof updateAllCharts === 'function') updateAllCharts();
                    showLiveSlide(presentationIndex);
                } catch (e) {}
            }, 300000);
        }

        function stopPresentation() {
            if (!presentationActive) return;
            presentationActive = false;

            if (presentationInterval) {
                clearInterval(presentationInterval);
                presentationInterval = null;
            }
            clearInterval(window.presentationUpdateInterval);

            // Ø±Ø¬ÙØ¹ Ø§ÙØ³ÙØ§Ø´Ù ÙÙÙØ§ÙÙØ§
            presentationOrder.forEach(id => {
                const el = document.getElementById(id);
                const info = presentationRestore.get(id);
                if (!el || !info) return;

                info.originalParent.insertBefore(el, info.placeholder);
                info.placeholder.remove();

                el.style.transform = '';
                el.style.transformOrigin = '';
                el.style.display = '';
            });

            presentationRestore.clear();
            presentationOrder = [];

            window.removeEventListener('keydown', presentationKeyHandler);
            window.removeEventListener('resize', presentationResizeHandler);

            if (presentationOverlay) {
                presentationOverlay.remove();
                presentationOverlay = null;
            }
        }

    </script>
</body>
</html>
