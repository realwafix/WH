<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Logistics Manager | V1.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/NPM/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.1.3/docx.umd.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#020617', 800: '#0f172a', 700: '#1e293b', 600: '#334155' },
                        brand: { 500: '#6366f1', 400: '#818cf8', 600: '#4f46e5' },
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } }
                }
            }
        }
        Chart.defaults.color = '#94a3b8'; Chart.defaults.borderColor = '#1e293b';
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; overflow-x: hidden; scroll-behavior: smooth; }
        .num-font { font-family: 'JetBrains Mono', monospace; }
        .glass-card { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); transition: all 0.3s ease; position: relative; overflow: hidden; }
        .glass-card:hover { transform: translateY(-3px); border-color: rgba(99, 102, 241, 0.4); }
        
        .shift-card-container { position: relative; }
        .d-shift-card { min-height: 260px; }

        .shift-staff-overlay { position: absolute; inset: 0; background: rgba(2, 6, 23, 0.95); opacity: 0; transition: opacity 0.25s ease; z-index: 20; padding: 1rem; text-align: center; backdrop-filter: blur(6px); pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
        .shift-card-container:hover .shift-staff-overlay { opacity: 1; pointer-events: auto; }
        .shift-staff-overlay .staff-wrap { width: 100%; margin-top: .5rem; max-height: calc(100% - 40px); overflow: auto; display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 6px; align-content: start; }
        .shift-staff-overlay .staff-pill { font-size: 12px; padding: 4px 6px; border-radius: 8px; background: rgba(148, 163, 184, 0.12); border: 1px solid rgba(148, 163, 184, 0.18); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .sparkline-container { height: 50px; width: 100%; margin-top: 10px; opacity: 0.8; }
        .chart-box { position: relative; height: 320px; width: 100%; }
        
        #loginOverlay { position: fixed; inset: 0; background: #020617; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        #loadingOverlayData { position: fixed; inset: 0; background: rgba(2,6,23,0.9); z-index: 9000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        
        .matrix-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid #334155; user-select: none; }
        .matrix-table { width: 100%; border-collapse: separate; border-spacing: 1px; min-width: 1000px; background: #0f172a; }
        .matrix-th { background: #1e293b; color: #94a3b8; padding: 8px; text-align: center; font-size: 0.7rem; width: 30px; }
        .matrix-td-name { background: #1e293b; color: white; padding: 6px 12px; font-weight: 600; min-width: 150px; position: sticky; left: 0; z-index: 10; border-right: 2px solid #334155; }
        .matrix-cell { background: #0f172a; cursor: pointer; height: 36px; text-align: center; transition: background 0.1s; border: 1px solid #1e293b; font-size: 0.75rem; color: #fff; }
        .matrix-cell:hover { border-color: white; }
        .matrix-td-action { background: #1e293b; padding: 4px; border-left: 2px solid #334155; position: sticky; right: 0; z-index: 10; width: 120px; text-align: center; }

        .cell-m { background-color: #facc15 !important; color: black !important; }
        .cell-e { background-color: #60a5fa !important; color: black !important; }
        .cell-n { background-color: #f87171 !important; color: black !important; }
        .cell-weekend { background-color: #334155; opacity: 0.4; pointer-events: none; }
        .cell-nowork { background-color: #475569 !important; color: white !important; }
        .cell-vacation { background-color: #a855f7 !important; color: white !important; font-weight: bold; cursor: not-allowed; border: 1px solid #7e22ce !important; }

        .tool-btn { transition: all 0.2s; border: 2px solid transparent; }
        .tool-btn.active { transform: scale(1.1); border-color: white; box-shadow: 0 0 10px rgba(255,255,255,0.3); }

        .email-table-out { width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; font-size: 12px; text-align: center; color: black; background: white; }
        .email-th { background-color: #f4b084; color: black; font-weight: bold; padding: 6px; border: 1px solid #000; }
        .email-td { border: 1px solid #000; padding: 4px; height: 20px; }
        .email-td-name { border: 1px solid #000; padding: 4px; text-align: left; font-weight: bold; background: #eee; width: 120px; }

        .d-shift-card { padding: 1.5rem; border-radius: 1rem; display: flex; flex-direction: column; height: 100%; border: 1px solid rgba(255,255,255,0.1); }
        .d-morning { background: linear-gradient(135deg, rgba(234, 179, 8, 0.2), rgba(234, 179, 8, 0.05)); border-color: rgba(234, 179, 8, 0.5); }
        .d-evening { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.05)); border-color: rgba(59, 130, 246, 0.5); }
        .d-night { background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.05)); border-color: rgba(239, 68, 68, 0.5); }

        .admin-hidden, .manager-hidden, .supervisor-hidden { display: none !important; }
        .manager-access { display: block; } 
        
        .nav-tab { cursor: pointer; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.85rem; font-weight: 600; transition: all 0.2s; color: #94a3b8; }
        .nav-tab:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-tab.active { background: #4f46e5; color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3); }

        .quick-nav { display: none; }
        .quick-nav-dot { display: none; }

        #dashboard-links a { display: block; padding: 6px 12px; border-radius: 8px; background: #0f172a; color: #94a3b8; font-weight: 600; transition: background 0.2s, color 0.2s; }
        #dashboard-links a:hover { background: #4f46e5; color: #ffffff; }
        
        .section-title { font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; border-left: 3px solid; padding-left: 0.75rem; }
        .title-container { margin-bottom: 1.5rem; display: flex; align-items: center; }

        .icon-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; max-height: 150px; overflow-y: auto; margin-top: 10px; border: 1px solid #334155; padding: 8px; border-radius: 8px; }
        .icon-option { background: #334155; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; height: 36px; transition: all 0.2s; color: #94a3b8; }
        .icon-option:hover, .icon-option.selected { background: #6366f1; color: white; transform: scale(1.1); border: 1px solid white; }

        #custom-cards-grid .fa-trash { display: none; }
        #csv-form-tabs button.csv-tab-active { background-color: #6366f1; color: white; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; border: 1px solid #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6366f1; } 
        
        .scrollable-table-container {
            max-height: 400px; 
            overflow-y: auto;  
            border-radius: 0.5rem;
            border: 1px solid #334155;
        }
        
        .sticky-header th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #1e293b; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }	
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator,
        input[type="month"]::-webkit-calendar-picker-indicator {
            filter: invert(1); 
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator:hover,
        input[type="time"]::-webkit-calendar-picker-indicator:hover,
        input[type="month"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <div id="loginOverlay">
        <div class="glass-card p-8 rounded-2xl w-96 text-center border border-dark-600">
            <div class="mb-6 flex justify-center"><div class="h-14 w-14 bg-brand-600 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-shield-alt text-2xl text-white"></i></div></div>
            <h2 class="text-xl font-bold text-white mb-2">Logistics Manager</h2>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="text" id="username" placeholder="Username" class="w-full bg-dark-900 border border-dark-600 text-white rounded-lg py-2.5 px-4 outline-none focus:border-brand-500" required>
                <input type="password" id="password" placeholder="Password" class="w-full bg-dark-900 border border-dark-600 text-white rounded-lg py-2.5 px-4 outline-none focus:border-brand-500" required>
                <button type="submit" id="loginBtn" class="w-full bg-brand-600 hover:bg-brand-500 text-white font-bold py-2.5 rounded-lg shadow-lg">Access System</button>
            </form>
            <p id="loginError" class="text-red-500 text-xs mt-4 hidden">Invalid Credentials</p>
        </div>
    </div>

    <div id="loadingOverlayData"><div class="w-16 h-16 border-4 border-dark-700 border-t-brand-500 rounded-full animate-spin mb-4"></div><p class="text-slate-400 font-mono text-sm">Syncing Data...</p></div>

    <aside class="w-20 md:w-72 bg-dark-800 border-r border-dark-700 flex flex-col z-20 hidden md:flex">
        <div class="h-20 flex items-center px-6 border-b border-dark-700 bg-dark-900/50">
            <div class="h-10 w-10 bg-brand-600 rounded-lg flex items-center justify-center mr-3"><i class="fas fa-cubes text-white"></i></div>
            <div class="hidden md:block"><h1 class="text-lg font-bold text-white">Logistics Manager</h1><p class="text-[10px] text-brand-400 tracking-[0.2em] font-bold"></p></div>
        </div>
        <nav class="flex-1 overflow-y-auto py-6 space-y-1 px-3">
            <a href="#" onclick="showMainView('dashboard')" class="nav-btn bg-dark-700 text-white flex items-center px-4 py-3 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-chart-pie w-5"></i><span class="ml-3 text-sm font-bold hidden md:block">Dashboard</span></a>

            <div class="mt-5">
                <p class="px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 hidden md:block">Dashboard Access</p>
                <a href="#" onclick="scrollToId('shift-log-display')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-calendar-alt w-4 text-green-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Daily Shift Performance</span></a>
                <a href="#" onclick="scrollToId('overview')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-globe w-4 text-indigo-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Overview</span></a>
                <a href="#" onclick="scrollToId('storage')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-boxes w-4 text-orange-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Storage</span></a>
                <a href="#" onclick="scrollToId('quality')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-thumbs-up w-4 text-emerald-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Quality</span></a>
                <a href="#" onclick="scrollToId('inbound')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-arrow-down w-4 text-blue-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Inbound</span></a>
                <a href="#" onclick="scrollToId('outbound')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-arrow-up w-4 text-indigo-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Outbound</span></a>
                <a href="#" onclick="scrollToId('finance')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-money-bill-wave w-4 text-yellow-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Stock Reconciliation</span></a>
                <a href="#" onclick="scrollToId('pending')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-exclamation-circle w-4 text-red-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Pending Actions</span></a>
                <a href="#" onclick="scrollToId('monthly-schedule')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-calendar w-4 text-slate-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Monthly Schedule</span></a>
                <a href="#" onclick="scrollToId('vacations-section')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-plane w-4 text-purple-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Staff Vacations</span></a>
                <a href="#" onclick="scrollToId('pallets-summary')" class="nav-btn flex items-center px-4 py-2 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all"><i class="fas fa-pallet w-4 text-amber-400"></i><span class="ml-3 text-sm font-bold hidden md:block">PO Pallet Tracking</span></a>
            </div>
            
            <div class="mt-6 border-t border-dark-700 pt-4">
                <a href="#" onclick="showMainView('workforce')" class="nav-btn flex items-center px-4 py-3 rounded-xl text-slate-400 hover:bg-dark-700 hover:text-white transition-all" style="display:none !important;"><i class="fas fa-users-cog w-5 text-blue-400"></i><span class="ml-3 text-sm font-bold hidden md:block">Control Panel</span></a>
            </div>
        </nav>
        <div class="p-6 border-t border-dark-700 bg-dark-900/30 hidden md:block footer-info">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs text-white font-bold" id="userAvatar">U</div>
                <div><p class="text-xs text-white font-bold" id="userNameDisplay">User</p><button onclick="logout()" class="text-[10px] text-red-400 hover:text-red-300">Logout</button></div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full bg-dark-900 relative overflow-hidden">
        <header class="h-16 bg-dark-800/80 backdrop-blur-md border-b border-dark-700 flex items-center justify-between px-8 z-30">
            <div><h2 class="text-xl font-bold text-white" id="pageTitle">Dashboard Overview</h2><p class="text-xs text-slate-400" id="lastUpdateTxt">Syncing...</p></div>
            <div class="flex items-center gap-4">
                <div id="save-indicator" class="hidden flex items-center text-green-400 text-xs font-bold mr-4"><i class="fas fa-check-circle mr-2"></i> Saved</div>
                <div class="h-6 w-px bg-dark-600 mx-2"></div>
                <select id="monthSelect" class="bg-dark-900 border border-dark-600 text-white text-xs rounded pl-3 pr-8 py-1.5 outline-none focus:border-brand-500"></select>
                <button id="refresh-btn" onclick="refreshAllData()" class="bg-green-600 hover:bg-green-500 text-white px-2 py-1 rounded text-xs font-bold flex items-center gap-1 ml-2"><i class="fas fa-sync-alt"></i></button>
                <div id="warehouse-filter" class="flex items-center gap-3 ml-4 text-xs"></div>
				<button onclick="getDailySummary()" class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white px-3 py-1 rounded text-xs font-bold flex items-center gap-2 ml-2 shadow-lg border border-white/10 transition-all hover:scale-105"><i class="fas fa-robot"></i> <span class="hidden md:inline">AI Insight</span></button>
                <button id="presentation-btn" onclick="startPresentation()" class="bg-brand-600 hover:bg-brand-500 text-white px-3 py-1 rounded text-xs font-bold flex items-center gap-1 ml-2"><i class="fas fa-film"></i> Present</button>
            </div>
        </header>

        <div id="contentArea" class="flex-1 overflow-y-auto p-6 md:p-10 scroll-smooth relative">
            <div id="quickNav" class="quick-nav hidden">
                <div class="quick-nav-dot" data-label="Shift Log" onclick="scrollToId('shift-log-display')"></div>
                <div class="quick-nav-dot" data-label="Overview" onclick="scrollToId('overview')"></div>
                <div class="quick-nav-dot" data-label="Storage" onclick="scrollToId('storage')"></div>
                <div class="quick-nav-dot" data-label="Quality" onclick="scrollToId('quality')"></div>
                <div class="quick-nav-dot" data-label="Inbound" onclick="scrollToId('inbound')"></div>
                <div class="quick-nav-dot" data-label="Outbound" onclick="scrollToId('outbound')"></div>
                <div class="quick-nav-dot" data-label="RSD/Finance" onclick="scrollToId('finance')"></div>
                <div class="quick-nav-dot" data-label="Monthly Schedule" onclick="scrollToId('monthly-schedule')"></div>
            </div>
<div id="view-dashboard" class="main-view space-y-12 pb-20">
    <div id="shift-log-display" class="hidden animate-fade-in mb-10 manager-access">
        <div class="flex justify-between items-center mb-6">
            <div class="title-container border-green-500 m-0"><h3 class="section-title text-green-400">Daily Shift Performance</h3></div>
            <span class="bg-green-900/30 text-green-400 px-3 py-1 rounded text-xs font-mono font-bold" id="shift-log-date">--/--/----</span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="shift-card-container group">
                <div class="d-shift-card d-morning">
                    <div class="flex justify-between items-center mb-4 border-b border-yellow-500/30 pb-2">
                        <h4 class="text-xl font-bold text-yellow-100 flex items-center gap-2"><i class="fas fa-sun text-yellow-400"></i> Morning Shift</h4>
                    </div>
                    <div class="space-y-3 text-sm text-yellow-50/80 flex-1" id="card-stats-morning">
                        <p class="italic opacity-50">No data loaded via Shift Log CSV</p>
                    </div>
                </div>
                <div class="shift-staff-overlay rounded-xl">
                    <h5 class="text-yellow-400 font-bold mb-2 uppercase text-sm tracking-wider">Staff on Duty</h5>
                    <div id="card-staff-morning" class="staff-wrap"></div>
                </div>
            </div>
            <div class="shift-card-container group">
                <div class="d-shift-card d-evening">
                    <div class="flex justify-between items-center mb-4 border-b border-blue-500/30 pb-2">
                        <h4 class="text-xl font-bold text-blue-100 flex items-center gap-2"><i class="fas fa-moon text-blue-400"></i> Evening Shift</h4>
                    </div>
                    <div class="space-y-3 text-sm text-blue-50/80 flex-1" id="card-stats-evening">
                        <p class="italic opacity-50">No data loaded via Shift Log CSV</p>
                    </div>
                </div>
                <div class="shift-staff-overlay rounded-xl">
                    <h5 class="text-blue-400 font-bold mb-2 uppercase text-sm tracking-wider">Staff on Duty</h5>
                    <div id="card-staff-evening" class="staff-wrap"></div>
                </div>
            </div>
            <div class="shift-card-container group">
                <div class="d-shift-card d-night">
                    <div class="flex justify-between items-center mb-4 border-b border-red-500/30 pb-2">
                        <h4 class="text-xl font-bold text-red-100 flex items-center gap-2"><i class="fas fa-star text-red-400"></i> Night Shift</h4>
                    </div>
                    <div class="space-y-3 text-sm text-red-50/80 flex-1" id="card-stats-night">
                        <p class="italic opacity-50">No data loaded via Shift Log CSV</p>
                    </div>
                </div>
                <div class="shift-staff-overlay rounded-xl">
                    <h5 class="text-red-400 font-bold mb-2 uppercase text-sm tracking-wider">Staff on Duty</h5>
                    <div id="card-staff-night" class="staff-wrap"></div>
                </div>
            </div>
        </div>

        <div class="glass-card rounded-2xl p-6 mt-6 border border-dark-700">
            <h4 class="text-white font-bold text-sm mb-4"><i class="fas fa-chart-line text-brand-400 mr-2"></i>Shift Performance Trends (Last 30 Days)</h4>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="h-64 w-full bg-dark-800/30 rounded-xl p-2 border border-dark-600/50">
                    <h5 class="text-[10px] text-slate-400 font-bold mb-2 text-center uppercase">Dispatch Comparison (By Shift)</h5>
                    <canvas id="chart-shift-dispatch"></canvas>
                </div>
                <div class="h-64 w-full bg-dark-800/30 rounded-xl p-2 border border-dark-600/50">
                    <h5 class="text-[10px] text-slate-400 font-bold mb-2 text-center uppercase">Trucks Comparison (By Shift)</h5>
                    <canvas id="chart-shift-trucks"></canvas>
                </div>
            </div>
            <div id="shift-stats-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6 pt-6 border-t border-dark-700/50"></div>
        </div>
    </div> 

    <div id="custom-cards-grid" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 hidden"></div>

    <section id="overview" class="animate-fade-in">
        <div class="title-container border-brand-500"><h3 class="section-title text-brand-400">Overview</h3></div>
        <div class="grid grid-cols-3 gap-6 mb-8" id="row-orders"></div>
        <div class="grid grid-cols-3 gap-6 mb-8" id="row-returns"></div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-10">
            <div class="glass-card rounded-2xl p-8">
                <div class="flex justify-between items-center mb-6"><h4 class="text-white font-bold text-lg">Orders Trend</h4></div>
                <div class="chart-box"><canvas id="chart-orders-trend"></canvas></div>
            </div>
            <div class="glass-card rounded-2xl p-8">
                <div class="flex justify-between items-center mb-6"><h4 class="text-white font-bold text-lg">Market Share</h4></div>
                <div class="chart-box"><canvas id="chart-orders-dist"></canvas></div>
            </div>
        </div>
    </section>

    <section id="storage" class="animate-fade-in mt-12">
        <div class="title-container border-orange-500"><h3 class="section-title text-orange-400">Storage Capacity & Utilization</h3></div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="storage-grid"></div>
    </section>

    <section id="quality" class="animate-fade-in">
        <div class="title-container border-emerald-500"><h3 class="section-title text-emerald-400">Quality</h3></div>
        <div class="grid grid-cols-3 gap-6 mb-8" id="quality-grid"></div>
        <div class="glass-card rounded-2xl p-8 mt-10">
            <h4 class="text-white font-bold text-lg mb-6">Comparative Quality</h4>
            <div class="chart-box"><canvas id="chart-quality-comp"></canvas></div>
        </div>
    </section>

    <section id="inbound" class="animate-fade-in mt-12">
        <div class="title-container border-blue-500"><h3 class="section-title text-blue-400">Inbound</h3></div>
        <div class="grid grid-cols-3 gap-5 mb-6" id="inbound-cases-grid"></div>
        <div class="grid grid-cols-3 gap-5 mb-6" id="inbound-pallets-grid"></div>
        <div class="grid grid-cols-3 gap-5 mb-6" id="inbound-trucks-grid"></div>
        <div class="grid grid-cols-2 gap-6 mt-8">
            <div class="glass-card rounded-2xl p-8 chart-box"><canvas id="chart-inbound-vol"></canvas></div>
            <div class="glass-card rounded-2xl p-8 chart-box"><canvas id="chart-inbound-trucks"></canvas></div>
        </div>
    </section>

    <section id="outbound" class="animate-fade-in">
        <div class="title-container border-indigo-500"><h3 class="section-title text-indigo-400">Outbound</h3></div>
        <div id="outbound-cards-slide">
            <div class="grid grid-cols-3 gap-5 mb-6" id="outbound-cases-grid"></div>
            <div class="grid grid-cols-3 gap-5 mb-6" id="outbound-pallets-grid"></div>
            <div class="grid grid-cols-3 gap-5 mb-6" id="outbound-total-trucks-grid"></div>
            <div class="grid grid-cols-3 gap-5 mb-6" id="outbound-destinations-grid"></div>
            <div class="grid grid-cols-3 gap-5 mb-6" id="outbound-trips-grid"></div>
        </div>
        <div id="outbound-charts-slide">
            <div class="grid grid-cols-2 gap-6 mt-8">
                <div class="glass-card rounded-2xl p-8 chart-box"><canvas id="chart-outbound-vol"></canvas></div>
                <div class="glass-card rounded-2xl p-8 chart-box"><canvas id="chart-outbound-trucks"></canvas></div>
            </div>
            <div class="grid grid-cols-2 gap-6 mt-8">
                <div class="glass-card rounded-2xl p-8 chart-box">
                    <h5 class="text-slate-300 text-sm font-bold mb-2">Total Trips Comparison</h5>
                    <canvas id="chart-outbound-trips-comp"></canvas>
                </div>
                <div class="glass-card rounded-2xl p-8 chart-box">
                    <h5 class="text-slate-300 text-sm font-bold mb-2">Total Destinations Comparison</h5>
                    <canvas id="chart-outbound-dest-comp"></canvas>
                </div>
            </div>
        </div>
    </section>

    <section id="finance" class="animate-fade-in mt-12">
        <div class="title-container border-yellow-500"><h3 class="section-title text-yellow-400">Stock Reconciliation</h3></div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="rsd-grid"></div>
    </section>

    <section id="pending" class="animate-fade-in mt-16 mb-8">
        <div class="title-container border-red-600"><h3 class="section-title text-red-500">Pending Actions</h3></div>
        <div class="grid grid-cols-3 gap-6 mb-8" id="pod-pending-grid"></div>
        <div class="grid grid-cols-3 gap-6 mb-8" id="return-pending-grid"></div>
    </section>

    <section id="monthly-schedule" class="animate-fade-in mt-12 mb-8 manager-access hidden">
        <div class="title-container border-slate-500 flex justify-between items-center pr-2">
            <h3 class="section-title text-slate-400"><i class="far fa-calendar-alt mr-2"></i> Monthly Schedule Snapshot</h3>
            <button onclick="jumpToCurrentMonth()" class="bg-slate-700 hover:bg-brand-600 text-white px-3 py-1 rounded-lg text-[10px] font-bold border border-slate-600 transition-all flex items-center gap-2 shadow-lg group">
                <i class="fas fa-clock text-slate-400 group-hover:text-white"></i> 
                Show Current Month
            </button>
        </div>
        <div id="dashboard-monthly-preview" class="w-full"></div>
    </section>

    <section id="vacations-section" class="animate-fade-in mt-8 mb-8 manager-access hidden">
        <div class="title-container border-purple-500"><h3 class="section-title text-purple-400"><i class="fas fa-plane-departure mr-2"></i> Upcoming Staff Vacations</h3></div>
        <div id="dashboard-vacations-list" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>
    </section>

    <section id="pallets-summary" class="animate-fade-in mb-8">
        <div class="title-container border-amber-500"><h3 class="section-title text-amber-400">PO Pallet Tracking</h3></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass-card rounded-2xl p-6 border-l-4 border-amber-500 flex justify-between items-center">
                <div>
                    <h4 class="text-slate-400 text-xs font-bold uppercase mb-1">Euro Pallets</h4>
                    <span id="pallets-euro-count" class="text-3xl font-bold text-white num-font">0</span>
                </div>
            </div>
            <div class="glass-card rounded-2xl p-6 border-l-4 border-amber-500 flex justify-between items-center">
                <div>
                    <h4 class="text-slate-400 text-xs font-bold uppercase mb-1">Used Pallets</h4>
                    <span id="pallets-used-count" class="text-3xl font-bold text-white num-font">0</span>
                </div>
            </div>
        </div>
    </section>
</div>

            <div id="view-workforce" class="main-view hidden animate-fade-in h-full flex flex-col">
                <div class="flex justify-between items-center border-b border-dark-700 pb-2 mb-6">
                    <div class="flex gap-2 overflow-x-auto">
                        <button onclick="switchAdminTab('roster')" class="nav-tab active" id="tab-roster">Operational Overtime Log</button>
                        <button onclick="switchAdminTab('planner')" class="nav-tab ops-access" id="tab-planner">Shift Planner</button>
                        <button onclick="switchAdminTab('overtime')" class="nav-tab ops-access" id="tab-overtime">Weekend & OT</button>
                        <button onclick="switchAdminTab('data')" class="nav-tab admin-only" id="tab-data">Data Management</button>
                        <button onclick="switchAdminTab('staff')" class="nav-tab ops-access" id="tab-staff">Staff Directory</button>
                        <button onclick="switchAdminTab('incidents')" class="nav-tab" id="tab-incidents">Damaged Reports</button>
                        <button onclick="switchAdminTab('vacations')" class="nav-tab ops-access" id="tab-vacations">Vacation Manager</button>
                        <button onclick="switchAdminTab('pallets')" class="nav-tab ops-access" id="tab-pallets">PO Pallet Management</button>
                        <button onclick="switchAdminTab('manager')" class="nav-tab manager-access" id="tab-manager">Incident Reports</button>
                        <button onclick="switchAdminTab('shiftlogs')" class="nav-tab admin-only" id="tab-shiftlogs">Shift Logs</button>
                        <button onclick="switchAdminTab('permissions')" class="nav-tab admin-only" id="tab-permissions">Permissions</button>
                        <button onclick="switchAdminTab('presentation')" class="nav-tab admin-only" id="tab-presentation">Presentation Settings</button>
                    </div>
                </div>

                <div id="subview-roster" class="sub-view flex-1 flex flex-col space-y-8">
                      <div id="ot-leaderboard-section" class="glass-card p-6 rounded-xl border-t-4 border-purple-500 manager-access">
                        <h4 class="text-white font-bold mb-4 flex items-center gap-2"><i class="fas fa-trophy text-purple-400"></i> Operational Overtime Log</h4>
						<div class="flex items-center gap-2">
  <input type="month" id="otLeaderboardMonth" class="bg-dark-800 border border-dark-600 text-white rounded px-3 py-2 text-sm" onchange="renderManagerLeaderboard()">
</div>
                        <div class="overflow-hidden rounded-lg border border-dark-700">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-dark-800 text-slate-400"><tr><th class="p-3">Rank</th><th class="p-3">Name</th><th class="p-3 text-right">Hours</th></tr></thead>
                                <tbody id="mgr-leaderboard" class="text-slate-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="subview-planner" class="sub-view hidden h-full flex flex-col">
                    <div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-4 mb-4">
                        <div class="flex items-center gap-3">
                            <div><label class="block text-xs text-slate-400 mb-1">Year</label><input type="number" id="plannerYear" class="bg-dark-800 border border-dark-600 rounded px-2 py-1 text-white w-20" onchange="initPlannerMatrix()"></div>
                            <div><label class="block text-xs text-slate-400 mb-1">Month</label><select id="plannerMonth" class="bg-dark-800 border border-dark-600 rounded px-2 py-1 text-white w-32" onchange="initPlannerMatrix()"><option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option><option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option><option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option></select></div>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="copyTableToClipboard('planner-matrix')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded text-xs font-bold shadow-lg flex items-center gap-2"><i class="fas fa-envelope"></i> Copy for Email</button>
                             <button onclick="exportPlannerExcel()" class="bg-green-700 hover:bg-green-600 text-white px-4 py-2 rounded text-xs font-bold shadow-lg flex items-center gap-2"><i class="fas fa-file-csv"></i> Export CSV</button>
                             <button onclick="savePlanner()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded text-xs font-bold shadow-lg flex items-center gap-2 admin-only"><i class="fas fa-save"></i> Save Schedule</button>
                        </div>
                    </div>
                    <div class="flex gap-4 mb-4 bg-dark-800/50 p-2 rounded-lg border border-dark-700 admin-only">
                        <span class="text-xs text-slate-400 self-center mr-2 uppercase font-bold">Paint Tools:</span>
                        <button onclick="setTool('morning')" class="tool-btn w-8 h-8 rounded bg-yellow-400 flex items-center justify-center text-black text-xs font-bold" title="Morning">1st</button>
                        <button onclick="setTool('evening')" class="tool-btn w-8 h-8 rounded bg-blue-400 flex items-center justify-center text-black text-xs font-bold" title="Evening">2nd</button>
                        <button onclick="setTool('night')" class="tool-btn w-8 h-8 rounded bg-red-400 flex items-center justify-center text-black text-xs font-bold" title="Night">3rd</button>
                        <button onclick="setTool('nowork')" class="tool-btn w-8 h-8 rounded bg-slate-500 flex items-center justify-center text-white text-xs font-bold" title="No Work">NW</button>
                        <button onclick="setTool('clear')" class="tool-btn w-8 h-8 rounded bg-dark-600 border border-slate-500 flex items-center justify-center text-white text-xs" title="Clear"><i class="fas fa-eraser"></i></button>
                        <span class="text-xs text-slate-500 self-center ml-auto">Click & Drag to paint. Use <b>Actions</b> column to fill month.</span>
                    </div>
                    <div class="matrix-wrapper flex-1 custom-scrollbar"><table class="matrix-table" id="planner-matrix"></table></div>
                </div>

                <div id="subview-overtime" class="sub-view hidden h-full">
                    <div class="flex flex-col lg:flex-row gap-6 h-full">
                         <div class="glass-card p-6 rounded-xl border-t-4 border-orange-500 lg:w-1/3 shrink-0">
                            <h3 class="text-white font-bold mb-4">Add Weekend / OT</h3>
                            <div class="space-y-3">
                                <select id="otEmpSelect" class="w-full bg-dark-900 border border-dark-600 text-white rounded px-3 py-2 text-sm"></select>
                                <div class="flex gap-2">
                                    <input type="date" id="otDate" class="w-full bg-dark-900 border border-dark-600 text-white rounded px-3 py-2 text-sm">
                                    <button onclick="addNoWork()" class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded font-bold text-sm shrink-0 admin-only">No Work</button>
                                </div>
                                <div class="flex gap-2">
                                  <input type="time" id="otTimeFrom" class="w-full bg-dark-900 border border-dark-600 text-white rounded px-2 py-2 text-sm">
                                  <input type="time" id="otTimeTo" class="w-full bg-dark-900 border border-dark-600 text-white rounded px-2 py-2 text-sm">
                                </div>
                                <input type="text" id="otTask" class="w-full bg-dark-900 border border-dark-600 text-white rounded px-3 py-2 text-sm" placeholder="Task (optional)">
                                <div class="flex gap-2">
                                  <button onclick="addOvertime()" class="w-full bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded font-bold">Add Overtime</button>
								  <button onclick="finalizeWeekendSession()" class="w-full bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded font-bold">Save Weekly Table</button>
								</div>
                            </div>
                        </div>
                        <div class="glass-card p-6 rounded-xl border-t-4 border-brand-500 flex-1 min-h-[300px]">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-white font-bold">Current Weekend Schedule</h3>
                                <div class="flex gap-2">
                                </div>
                            </div>
                            <div id="ot-content-current" class="ot-content-view">
                                <div class="flex gap-4 items-start">
                                <div class="flex-1 overflow-x-auto text-black bg-white p-4 rounded-lg" id="weekend-table-preview"></div>
                                <div class="w-[340px] max-w-[340px] bg-dark-900/50 p-4 rounded-lg" id="weekend-log-container"></div>
                                </div>
                                <button onclick="copyTableToClipboard('weekend-table-preview')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded text-xs font-bold shadow-lg flex items-center gap-2 mt-4"><i class="fas fa-envelope"></i> Copy for Email</button>
                            </div>
                            <div id="ot-content-history-log" class="ot-content-view hidden">
                                <div id="ot-history-log-table" class="overflow-x-auto bg-dark-900/50 p-4 rounded-lg"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="subview-data" class="sub-view hidden h-full space-y-8">
                    <div class="glass-card p-8 rounded-xl border-l-4 border-indigo-500">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-white mb-1">Master JSON Editor</h3>
                                <p class="text-xs text-slate-400">Edit general metrics in <b>WHSdata.json</b>.</p>
                            </div>
                            <div class="flex gap-2">
                                <input type="file" id="import-csv-file" accept=".csv" class="hidden" onchange="importDatasetCSV(this)">
                                <button onclick="document.getElementById('import-csv-file').click()" class="bg-green-700 hover:bg-green-600 text-white px-3 py-2 rounded font-bold shadow-lg text-sm flex items-center"><i class="fas fa-file-csv mr-2"></i> Import CSV</button>
                                <button onclick="saveCSV()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-2 rounded font-bold shadow-lg flex items-center text-sm"><i class="fas fa-save mr-2"></i> Save Changes</button>
                            </div>
                        </div>
                        <div class="overflow-auto max-h-96 border border-dark-600 rounded bg-dark-900 custom-scrollbar"><table class="w-full text-xs text-left" id="csv-editor-table"></table></div>
                    </div>

                    <div class="glass-card p-8 rounded-xl border-l-4 border-green-500">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-white mb-1">Add New Record</h3>
                            <button onclick="addCSVRow()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded font-bold shadow-lg text-sm"><i class="fas fa-plus mr-2"></i> Add Row</button>
                        </div>
                        <p class="text-xs text-slate-400 mb-4">Populate each field to append a new row to the dataset. All values will be saved to <b>WHSdata.json</b>.</p>
                        <div id="csv-form-tabs" class="flex flex-wrap gap-2 mb-4"></div>
                        <div id="csv-form-contents"></div>
                    </div>

                    <div class="glass-card p-8 rounded-xl border-l-4 border-green-500">
                        <h3 class="text-xl font-bold text-white mb-4">Upload Daily Shift Log</h3>
                        <label class="inline-block bg-green-600 hover:bg-green-500 text-white border border-green-500 px-6 py-3 rounded-lg font-bold cursor-pointer transition-colors shadow-lg"><i class="fas fa-file-csv mr-2"></i> Select CSV File<input type="file" onchange="handleShiftLogUpload(this)" class="hidden" accept=".csv"></label>
                    </div>
                    
                    <div class="glass-card p-8 rounded-xl border-l-4 border-brand-500">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-white font-bold text-xl">Add Custom Metric Card</h3>
                            <button onclick="openAddCardModal()" class="bg-brand-600 text-white px-3 py-1.5 rounded text-xs font-bold">Add New</button>
                        </div>
                        <div id="custom-metric-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>
                </div>

                <div id="subview-staff" class="sub-view hidden h-full">
                    <div class="flex justify-between items-center mb-4 ops-access"><h3 class="text-white font-bold">Staff Directory</h3><button onclick="addNewEmployee()" class="bg-brand-600 text-white px-4 py-2 rounded text-xs font-bold admin-only">+ New Employee</button></div>
                    <div class="glass-card rounded-xl overflow-hidden"><table class="w-full text-left"><thead class="bg-dark-800 text-slate-400 text-xs uppercase"><tr><th class="p-4">Name</th><th class="p-4 text-center admin-only">Actions</th></tr></thead><tbody id="emp-table-body" class="text-slate-300 text-sm divide-y divide-dark-700"></tbody></table></div>
                </div>
                
                 <div id="subview-vacations" class="sub-view hidden h-full">
                    <div class="flex flex-col lg:flex-row gap-6 h-full">
                        
                        <div class="glass-card p-6 rounded-xl border-t-4 border-purple-500 lg:w-1/3 shrink-0 h-fit">
                            <h3 class="text-white font-bold mb-4">Schedule Vacation</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Employee</label>
                                    <select id="vacationEmpSelect" class="w-full bg-dark-900 border border-dark-600 text-white rounded px-3 py-2 text-sm"></select>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs text-slate-400 mb-1">Start Date</label>
                                        <input type="date" id="vacationStart" class="w-full bg-dark-900 border border-dark-600 text-white rounded px-3 py-2 text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-400 mb-1">End Date</label>
                                        <input type="date" id="vacationEnd" class="w-full bg-dark-900 border border-dark-600 text-white rounded px-3 py-2 text-sm">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Type</label>
                                    <select id="vacationType" class="w-full bg-dark-900 border border-dark-600 text-white rounded px-3 py-2 text-sm">
                                        <option value="Annual">Annual Leave</option>
                                        <option value="Sick">Sick Leave</option>
                                        <option value="Emergency">Emergency</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <button onclick="addVacation()" class="w-full bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded font-bold shadow-lg">Save Vacation</button>
                            </div>
                        </div>

                        <div class="glass-card p-6 rounded-xl border-t-4 border-brand-500 flex-1 flex flex-col h-full overflow-hidden">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-white font-bold">Upcoming Vacations List</h3>
                            </div>
                            
                            <div class="flex-1 scrollable-table-container custom-scrollbar" style="max-height: 500px;">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-dark-800 text-slate-400 sticky-header">
                                        <tr>
                                            <th class="p-3">Employee</th>
                                            <th class="p-3">Start Date</th>
                                            <th class="p-3">End Date</th>
                                            <th class="p-3">Type</th>
                                            <th class="p-3">Duration</th>
                                            <th class="p-3 text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vacations-table-body" class="text-slate-200 divide-y divide-dark-700"></tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>

                <div id="subview-incidents" class="sub-view hidden h-full flex flex-col gap-6">
                    <div class="glass-card p-6 rounded-xl border-t-4 border-red-500">
                        <h3 class="text-white font-bold text-lg mb-4 flex items-center gap-2"><i class="fas fa-exclamation-triangle text-red-400"></i> Damaged Product Report</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div><label class="text-xs text-slate-400 uppercase mb-1 block">Product</label><input type="text" id="damage-product" class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm" placeholder="Product name"></div>
                            <div><label class="text-xs text-slate-400 uppercase mb-1 block">Batch</label><input type="text" id="damage-batch" class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm" placeholder="Batch number"></div>
                            <div><label class="text-xs text-slate-400 uppercase mb-1 block">Quantity</label><input type="number" id="damage-qty" class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm" placeholder="Quantity"></div>
                        </div>
                        <label class="text-xs text-slate-400 uppercase mb-1 block">Notes</label>
                        <textarea id="damage-notes" rows="3" class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm mb-4" placeholder="Additional details"></textarea>
                        <label class="text-xs text-slate-400 uppercase mb-1 block">Upload Photo</label>
                        <input type="file" id="damage-image" accept="image/*" class="mb-4 text-sm">
                        <button onclick="submitDamageReport()" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded font-bold shadow-lg">Submit Report</button>
                    </div>
                </div>

                <div id="subview-pallets" class="sub-view hidden h-full flex flex-col gap-6">
                    <div class="glass-card p-6 rounded-xl border-t-4 border-amber-500">
                        
                        <div class="flex gap-4 mb-4 border-b border-dark-700">
                            <button onclick="switchPalletsTab('open')" id="pallets-tab-open" class="nav-tab active">Open POs</button>
                            <button onclick="switchPalletsTab('history')" id="pallets-tab-history" class="nav-tab">History</button>
                        </div>

                        <div id="pallets-view-open" class="pallets-view">
                            <h3 class="text-white font-bold text-lg mb-4 flex items-center gap-2"><i class="fas fa-boxes text-amber-400"></i> PO Pallet Tracking</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div><label class="text-xs text-slate-400 uppercase mb-1 block">PO Number</label><input type="text" id="po-number" class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm" placeholder="PO#"></div>
                                <div><label class="text-xs text-slate-400 uppercase mb-1 block">Type</label><select id="po-type" class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm"><option value="euro">Euro</option><option value="used">Used</option></select></div>
                                <div><label class="text-xs text-slate-400 uppercase mb-1 block">Quantity</label><input type="number" id="po-qty" class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm" placeholder="Qty"></div>
                            </div>
                            <button onclick="addPO()" class="bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded font-bold shadow-lg mb-6">Add PO</button>
                            
                            <div class="mb-4"><input type="text" id="pallets-search-open" placeholder="Search PO..." class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm" oninput="renderPalletsTable();"></div>
                            
                            <div class="glass-card p-4 rounded-lg border border-dark-700 scrollable-table-container custom-scrollbar" style="max-height: 400px;">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-dark-800 text-slate-400 sticky-header">
                                        <tr><th class="p-3">PO Number</th><th class="p-3">Type</th><th class="p-3 text-right">Qty</th><th class="p-3 text-center">Actions</th></tr>
                                    </thead>
                                    <tbody id="pallets-table-body" class="text-slate-200"></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="pallets-view-history" class="pallets-view hidden">
                            <h3 class="text-white font-bold text-lg mb-4 flex items-center gap-2"><i class="fas fa-history text-amber-400"></i> Closed PO History</h3>
                            <div class="mb-4"><input type="text" id="pallets-search-history" placeholder="Search Closed PO..." class="w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm" oninput="renderPalletsHistoryTable();"></div>
                            
                            <div class="glass-card p-4 rounded-lg border border-dark-700 scrollable-table-container custom-scrollbar" style="max-height: 400px;">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-dark-800 text-slate-400 sticky-header">
                                        <tr><th class="p-3">PO Number</th><th class="p-3">Type</th><th class="p-3">Total Used</th><th class="p-3 text-center">Details</th></tr>
                                    </thead>
                                    <tbody id="pallets-history-body" class="text-slate-200"></tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>

                <div id="subview-manager" class="sub-view hidden flex-1 flex flex-col gap-6 overflow-y-auto">
                    <h3 class="text-white font-bold text-lg mb-4">Incident Reports</h3>
                    <div class="glass-card p-6 rounded-xl overflow-auto"><table class="w-full text-left text-sm"><thead class="bg-dark-800 text-slate-400"><tr><th class="p-3">Date</th><th class="p-3">Product</th><th class="p-3">Batch</th><th class="p-3 text-right">Qty</th><th class="p-3">Image</th><th class="p-3 text-center">View Details</th></tr></thead><tbody id="incident-table-body" class="text-slate-200"></tbody></table></div>
                </div>

                <div id="subview-shiftlogs" class="sub-view hidden h-full flex flex-col gap-6">
                    
                    <div class="glass-card p-6 rounded-xl border-t-4 border-blue-500 shrink-0">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-white font-bold text-lg flex items-center gap-2">
                                    <i class="fas fa-calendar-day text-blue-400"></i> Shift Log Editor
                                </h3>
                                <p class="text-xs text-slate-400 mt-1">Add or remove shift log records manually.</p>
                            </div>
                            <button onclick="addShiftLogRecord()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-lg font-bold text-sm shadow-lg flex items-center gap-2 transition-all hover:scale-105">
                                <i class="fas fa-plus"></i> Add Entry
                            </button>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-6 gap-4 items-end">
                            <div class="col-span-1 md:col-span-1">
                                <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1">Date</label>
                                <input type="date" id="shiftlog-date" class="w-full bg-dark-900 border border-dark-600 text-white rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none transition-colors">
                            </div>
                            <div class="col-span-1 md:col-span-1">
                                <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1">Shift</label>
                                <select id="shiftlog-shift" class="w-full bg-dark-900 border border-dark-600 text-white rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none transition-colors">
                                    <option value="morning">Morning</option>
                                    <option value="evening">Evening</option>
                                    <option value="night">Night</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1" title="Pallets Received">Pallets Rec</label>
                                <input type="number" id="shiftlog-pallets" placeholder="0" class="w-full bg-dark-900 border border-dark-600 text-white rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none transition-colors">
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1" title="Pallets Dispatched">Pallets Disp</label>
                                <input type="number" id="shiftlog-palletsDisp" placeholder="0" class="w-full bg-dark-900 border border-dark-600 text-white rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none transition-colors">
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1" title="Trucks Plan">Trucks Plan</label>
                                <input type="number" id="shiftlog-plan" placeholder="0" class="w-full bg-dark-900 border border-dark-600 text-white rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none transition-colors">
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1" title="Trucks Actual">Trucks Act</label>
                                <input type="number" id="shiftlog-act" placeholder="0" class="w-full bg-dark-900 border border-dark-600 text-white rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none transition-colors">
                            </div>
                        </div>
                    </div>

                    <div class="glass-card p-6 rounded-xl flex-1 flex flex-col overflow-hidden border border-dark-700">
                        <h4 class="text-white font-bold text-sm mb-4">Current Log Records</h4>
                        
                        <div class="flex-1 scrollable-table-container custom-scrollbar">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-dark-800 text-slate-400 sticky-header">
                                    <tr>
                                        <th class="p-3">Date</th>
                                        <th class="p-3">Shift</th>
                                        <th class="p-3">Pallets Rec</th>
                                        <th class="p-3">Pallets Disp</th>
                                        <th class="p-3">Trucks Plan</th>
                                        <th class="p-3">Trucks Act</th>
                                        <th class="p-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="shiftlog-table-body" class="text-slate-200 divide-y divide-dark-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
				<div id="subview-permissions" class="sub-view hidden h-full flex flex-col gap-6">
                    <div class="glass-card p-6 rounded-xl border-t-4 border-teal-500">
                        <h3 class="text-white font-bold text-lg mb-4 flex items-center gap-2">
                            <i class="fas fa-user-shield text-teal-400"></i> Permissions Management
                        </h3>
                        <p class="text-xs text-slate-400 mb-4">Customize which tabs and features are visible for each user role.</p>
                        <div id="permissions-form" class="overflow-auto mb-4 custom-scrollbar" style="max-height: 500px;"></div>
                        <button onclick="savePermissions()" class="bg-teal-600 hover:bg-teal-500 text-white px-4 py-2 rounded font-bold self-start shadow-lg">Save Permissions</button>
                    </div>
                </div>

                <div id="subview-presentation" class="sub-view hidden h-full flex flex-col gap-6">
                    <div class="glass-card p-6 rounded-xl border-t-4 border-purple-500">
                        <h3 class="text-white font-bold text-lg mb-4 flex items-center gap-2">
                            <i class="fas fa-slideshare text-purple-400"></i> Presentation Configuration
                        </h3>
                        <p class="text-xs text-slate-400 mb-4">Select which dashboard sections appear in presentation mode for each role.</p>
                        <div id="presentation-form" class="overflow-auto mb-4 custom-scrollbar" style="max-height: 500px;"></div>
                        <button onclick="savePresentationConfig()" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded font-bold self-start shadow-lg">Save Slides</button>
                    </div>
                </div>

            </div> <div class="w-full text-center py-6 mt-8 border-t border-dark-700/50 text-slate-500 text-xs">
                SPIMACO Finished Goods Warehouse <span class="font-bold text-brand-400">WAFI</span> &copy; 2025
            </div>

        </div> </main>
    
    <div id="poHistoryModal" class="fixed inset-0 bg-dark-900/90 z-[99999] hidden items-center justify-center p-4">
        <div class="glass-card rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b border-dark-600 pb-2">
                <h3 class="text-xl font-bold text-white" id="poHistoryModalTitle">PO History Details</h3>
                <button onclick="document.getElementById('poHistoryModal').style.display='none'" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="poHistoryModalContent"></div>
        </div>
    </div>

    <div id="incidentDetailModal" class="fixed inset-0 bg-dark-900/90 z-[99999] hidden items-center justify-center p-4">
        <div class="glass-card rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b border-dark-600 pb-2">
                <h3 class="text-xl font-bold text-white">Incident Details</h3>
                <button onclick="document.getElementById('incidentDetailModal').style.display='none'" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="incidentDetailModalContent"></div>
        </div>
    </div>
<div id="aiSummaryModal" class="fixed inset-0 bg-dark-900/95 z-[99999] hidden items-center justify-center p-4 backdrop-blur-sm">
    <div class="glass-card rounded-2xl p-0 w-full max-w-2xl border border-purple-500/30 shadow-2xl relative overflow-hidden flex flex-col max-h-[80vh]">
        <div class="bg-gradient-to-r from-purple-900/50 to-blue-900/50 p-4 border-b border-white/10 flex justify-between items-center">
            <h3 class="text-white font-bold text-lg flex items-center gap-2"><i class="fas fa-sparkles text-purple-400"></i> Daily Executive Summary</h3>
            <button onclick="document.getElementById('aiSummaryModal').style.display='none'" class="text-slate-400 hover:text-white transition-colors"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div id="aiSummaryContent" class="p-6 text-slate-300 text-sm leading-relaxed overflow-y-auto custom-scrollbar" dir="rtl" style="text-align: right;">
            <div class="flex flex-col items-center justify-center py-10 space-y-4">
                <i class="fas fa-circle-notch fa-spin text-4xl text-purple-500"></i>
                <p class="animate-pulse">Analyzing dashboard data...</p>
            </div>
        </div>
        <div class="p-3 bg-dark-900/50 border-t border-white/5 text-[10px] text-slate-500 text-center flex justify-between items-center px-6">
            <span>Logistics Manager AI 0.1V</span>
            <span id="ai-cache-status" class="hidden text-green-400"><i class="fas fa-bolt mr-1"></i> Cached Result</span>
        </div>
    </div>
</div>
    <script>
	function escapeHTML(str) {
    if (!str) return '';
    return str.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function compressImage(file, maxWidth, quality) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = event => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const elem = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                    elem.width = width;
                    elem.height = height;
                    const ctx = elem.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(elem.toDataURL('image/jpeg', quality));
                };
                img.onerror = error => reject(error);
            };
            reader.onerror = error => reject(error);
        });
    }

        const WORKER_URL = "https://api.wf6638.workers.dev";
        let WH_ORDER = ['SPIMACO', 'PROCEED', 'DSV'];
        const CHART_COLORS = { SPIMACO: '#60a5fa', PROCEED: '#9e2062', DSV: '#1e3a8a' }; 
        const COLORS = { 'SPIMACO': 'blue', 'PROCEED': 'green', 'DSV': 'orange', 'default': 'brand' };

        let rawData = [];
        let rawCSVData = [];
        let monthList = [];
        let fullMonthList = [];
        let chartInstances = {};
        let sparklineInstances = [];
        let selectedWarehouses = [...WH_ORDER];
        let sessionToken = null; 
        let currentUser = null; 
// Provide a helper to safely get the current user's role or a sensible default.
function getUserRole() {
  // If currentUser is defined and has a role return it. Otherwise fallback to whatever was stored
  // in localStorage during a previous session or default to "guest" for unauthenticated users.
  return (currentUser && currentUser.role) ? currentUser.role : (localStorage.getItem('userRole') || 'guest');
}
        let employees = []; 
        let shifts = {}; 
        let overtime = []; 
        let customCards = []; 
        let masterShiftLogs = {}; 
        let manualMetrics = {};
        let damageReports = [];
        let pallets = [];
        let palletsClosed = [];
        let vacations = []; 
        let currentTool = 'morning'; 
        let isPainting = false;
        let permissions = {};

        function formatTime12h(t) {
            if(!t) return 'N/A';
            const [h, m] = t.split(':');
            const H = parseInt(h);
            const ampm = H >= 12 ? 'PM' : 'AM';
            const h12 = H % 12 || 12;
            return `${h12}:${m} ${ampm}`;
        }

        function switchOvertimeTab(viewId) {
            document.querySelectorAll('.ot-content-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(`ot-content-${viewId}`)?.classList.remove('hidden');
            if (viewId === 'history-log') renderOvertimeHistoryLog();
            else if (viewId === 'current') renderWeekendTable();
        }

        function renderOvertimeHistoryLog() {
            const container = document.getElementById('ot-history-log-table');
            if (!container) return;
            const otHistory = overtime.filter(o => o.type === 'overtime');
            const totals = {};
            otHistory.forEach(o => { totals[o.name] = (totals[o.name] || 0) + o.hours; });
            const sortedTotals = Object.entries(totals).sort(([, a], [, b]) => b - a);
            let html = '<h4 class="text-white font-bold text-lg mb-4">Total Overtime Hours (Since Start)</h4><div class="overflow-hidden rounded-lg border border-dark-700"><table class="w-full text-left text-sm"><thead class="bg-dark-800 text-slate-400"><tr><th class="p-3">Employee</th><th class="p-3 text-right">Total Hours</th></tr></thead><tbody class="text-slate-200">';
            if (sortedTotals.length === 0) html += '<tr><td colspan="2" class="p-3 text-center text-slate-500">No overtime records found.</td></tr>';
            else sortedTotals.forEach(([name, hours]) => { html += `<tr><td class="p-3">${name}</td><td class="p-3 text-right font-mono">${hours.toFixed(1)}</td></tr>`; });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

async function handleLogin(e) {
    e.preventDefault();
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();
    const btn = document.getElementById('loginBtn');
    
    if(!u || !p) return;

    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Checking...';
    
    try {
        const response = await fetch(`${WORKER_URL}/api/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: u, password: p })
        });

        if (response.ok) {
            const data = await response.json();
            
            sessionToken = data.token; 
            localStorage.setItem('authToken', data.token); 
            localStorage.setItem('userRole', data.role);
            localStorage.setItem('userName', data.username);
            
            currentUser = { username: data.username, role: data.role };
            
            document.getElementById('userNameDisplay').textContent = data.username;
            document.getElementById('userAvatar').textContent = data.username.charAt(0).toUpperCase();
            
            await loadPermissions();
            applyRoleUI(currentUser.role);
            
            document.getElementById('loadingOverlayData').style.display = 'flex';
            await refreshData();
            await backgroundRefresh();
            
            document.getElementById('loadingOverlayData').style.display = 'none';
            document.getElementById('loginOverlay').style.display = 'none';
            
            if (permissions && permissions[currentUser.role]) {
               const perms = permissions[currentUser.role];
               if (perms.dashboard !== false) {
  showMainView('dashboard');
} else {
  showMainView('workforce');
}

            } else {
                showMainView('dashboard');
            }
            
            setInterval(() => { backgroundRefresh(); }, 300000);

        } else {
            document.getElementById('loginError').classList.remove('hidden');
            btn.innerHTML = 'Access System';
        }
    } catch (error) {
        console.error(error);
        document.getElementById('loginError').classList.remove('hidden');
        btn.innerHTML = 'Access System';
    }
}

function logout() {
  try {
    localStorage.removeItem('authToken');
    localStorage.removeItem('userRole');
    localStorage.removeItem('userName');
  } catch (e) {}
  location.reload();
}


        function applyRoleUI(role) {
            document.querySelectorAll('.admin-only').forEach(el => {if (el.classList.contains('sub-view')) return; if (role === 'admin') el.classList.remove('hidden');else el.classList.add('hidden');});
            document.querySelectorAll('.manager-access').forEach(el => { if (role === 'admin' || role === 'manager') el.classList.remove('hidden'); else el.classList.add('hidden'); });
            document.querySelectorAll('.ops-access').forEach(el => { if (role === 'admin' || role === 'manager') el.classList.remove('hidden'); else el.classList.add('hidden'); });
            if (permissions && permissions[role]) {
                const feats = ['roster','planner','overtime','data','staff','incidents','pallets','manager','shiftlogs','permissions','presentation','vacations']; 
                feats.forEach(f => {
                    const tab = document.getElementById('tab-' + f);
                    if (tab) { if (permissions[role][f] === false) tab.classList.add('hidden'); else tab.classList.remove('hidden'); }
                });
                const allSections = ['shift-log-display','overview','storage','quality','inbound','outbound','finance','pending','monthly-schedule','vacations-section','pallets-summary','custom-cards-grid','ot-leaderboard-section'];
                const cardPerms = permissions[role].cards || {};
                allSections.forEach(secId => {
                    const secEl = document.getElementById(secId);
                    if (!secEl) return;
                    if (cardPerms[secId] !== false) secEl.classList.remove('hidden');
                    else secEl.classList.add('hidden');
                });
                document.querySelectorAll('nav a[onclick^="scrollToId("]').forEach(link => {
                    const match = /scrollToId\(['"]([^'"]+)['"]\)/.exec(link.getAttribute('onclick'));
                    if (match && cardPerms[match[1]] === false) link.classList.add('hidden');
                    else link.classList.remove('hidden');
                });
                const dashboardPerm = permissions[role].dashboard;
                const workforcePerm = permissions[role].workforce;
                const dashView = document.getElementById('view-dashboard');
                const wfView = document.getElementById('view-workforce');
                const dashLink = document.querySelector('a[onclick*="showMainView(\'dashboard\')"]');
                const wfLink = document.querySelector('a[onclick*="showMainView(\'workforce\')"]');
				if (dashView && dashboardPerm === false) { dashView.classList.add('hidden'); }
                if (wfView && workforcePerm === false) { wfView.classList.add('hidden'); }
                if (dashLink) { if (dashboardPerm === false) dashLink.classList.add('hidden'); else dashLink.classList.remove('hidden'); }
                if (wfLink) { if (workforcePerm === false) wfLink.style.display = 'none'; else wfLink.style.display = 'flex'; }
                const sidebarDashLink = document.querySelector('nav .nav-btn[onclick*="showMainView(\'dashboard\')"]');
                if (sidebarDashLink) { if (dashboardPerm === false) sidebarDashLink.classList.add('hidden'); else sidebarDashLink.classList.remove('hidden'); }
                const dashboardAccessGroup = document.querySelector('nav .mt-5');
                if (dashboardAccessGroup) { if (dashboardPerm === false) dashboardAccessGroup.classList.add('hidden'); else dashboardAccessGroup.classList.remove('hidden'); }
            }
        }
// Use a safe role lookup to avoid errors when currentUser is null
const __roleSafe = getUserRole();
if (permissions && permissions[__roleSafe]) {
  const perms = permissions[__roleSafe];
  const cardPerms = perms.cards || {};

  //        
  const anyDashboardSectionVisible = [
    'shift-log-display','overview','storage','quality','inbound','outbound','finance','pending',
    'monthly-schedule','vacations-section','pallets-summary','custom-cards-grid','ot-leaderboard-section'
  ].some(id => cardPerms[id] !== false);

  if (perms.dashboard !== false && anyDashboardSectionVisible) {
    showMainView('dashboard');
  } else {
    showMainView('workforce'); //      (  1)
  }
} else {
  showMainView('dashboard');
}

        async function refreshData() {
            employees = await fetchGithub('employees.json'); if (!Array.isArray(employees)) employees = [];
            shifts = await fetchGithub('shifts.json'); if (!shifts || typeof shifts !== 'object' || Array.isArray(shifts)) shifts = {};
            overtime = await fetchGithub('overtime.json'); if (!Array.isArray(overtime)) overtime = [];
            customCards = await fetchGithub('custom_cards.json'); if (!Array.isArray(customCards)) customCards = [];
            masterShiftLogs = await fetchGithub('shift_logs_master.json'); if (typeof masterShiftLogs !== 'object' || masterShiftLogs === null) masterShiftLogs = {};
            manualMetrics = await fetchGithub('manual_metrics.json'); if (typeof manualMetrics !== 'object' || manualMetrics === null) manualMetrics = {};
            damageReports = await fetchGithub('damage_reports.json'); if (!Array.isArray(damageReports)) damageReports = [];
            pallets = await fetchGithub('pallets.json');
            if (!Array.isArray(pallets)) { try { pallets = JSON.parse(pallets); } catch (e) { pallets = []; } }
            pallets.forEach(p => { if (!Array.isArray(p.history)) p.history = []; });
            palletsClosed = await fetchGithub('pallets_closed.json');
            if (!Array.isArray(palletsClosed)) { try { palletsClosed = JSON.parse(palletsClosed); } catch (e) { palletsClosed = []; } }
            palletsClosed.forEach(p => { if (!Array.isArray(p.history)) p.history = []; });
            
            try {
                const vacData = await fetchGithub('vacations.json');
                vacations = Array.isArray(vacData) ? vacData : [];
            } catch(e) { vacations = []; }

            const today = new Date();
            document.getElementById('plannerYear').value = today.getFullYear();
            document.getElementById('plannerMonth').value = today.getMonth() + 1;
            const sel = document.getElementById('otEmpSelect'); 
            if(sel) sel.innerHTML = '<option value="">Select...</option>' + employees.map(e => `<option value="${e.name}">${e.name}</option>`).join('');
            
            const vacSel = document.getElementById('vacationEmpSelect');
            if(vacSel) vacSel.innerHTML = employees.map(e => `<option value="${e.name}">${e.name}</option>`).join('');

            initPlannerMatrix(); renderWeekendTable(); renderEmpTable(); renderCustomCards(); renderManagerLeaderboard();
            const sortedDates = Object.keys(masterShiftLogs).sort((a,b)=>new Date(a)-new Date(b));
            if(sortedDates.length > 0) updateDashboardShiftCards(sortedDates[sortedDates.length-1], masterShiftLogs[sortedDates[sortedDates.length-1]]);
            renderPalletsTable(); renderPalletsHistoryTable(); renderPalletsOverview(); renderManagerReports();
            renderVacationsManager(); renderVacationsDashboard();
        }

        function showMainView(id) {
  document.querySelectorAll('.main-view').forEach(el => el.classList.add('hidden'));
  document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('bg-dark-700', 'text-white'));

  const viewEl = document.getElementById(`view-${id}`);
  if (viewEl) viewEl.classList.remove('hidden');

  const qNav = document.getElementById('quickNav');

  if (id === 'dashboard') {
    render();
    qNav.classList.remove('hidden');
    document.getElementById('pageTitle').textContent = 'Dashboard Overview';
  } else {
    qNav.classList.add('hidden');
    document.getElementById('pageTitle').textContent = 'Control Panel';

    document.querySelectorAll('.sub-view').forEach(el => el.classList.add('hidden'));


    const activeBtn = document.querySelector('#view-workforce .nav-tab.active');
    const activeId =
      (activeBtn && !activeBtn.classList.contains('hidden'))
        ? activeBtn.id.replace('tab-', '')
        : null;

    // Determine the user's role safely, falling back to guest if unknown
    const safeRoleForTab = getUserRole();
    const preferred = activeId || getFirstAllowedWorkforceTab(safeRoleForTab);

    if (preferred) switchAdminTab(preferred);
  }
}


        function scrollToId(id) { const el = document.getElementById(id); if(el) { el.scrollIntoView({behavior: 'smooth', block: 'center'}); } }
        
        async function switchAdminTab(tabId) {
            document.querySelectorAll('.sub-view').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            const view = document.getElementById(`subview-${tabId}`);
            if (view) view.classList.remove('hidden');
            const btn = document.getElementById(`tab-${tabId}`);
            if (btn) btn.classList.add('active');
            if (tabId === 'shiftlogs') loadShiftLogs();
            if (tabId === 'permissions') loadPermissions();
            if (tabId === 'presentation') renderPresentationForm();
            if (tabId === 'pallets') switchPalletsTab('open');
            if (tabId === 'overtime') switchOvertimeTab('current');
            if (tabId === 'vacations') renderVacationsManager();
        }
function getFirstAllowedWorkforceTab(role) {
  const perms = (permissions && permissions[role]) ? permissions[role] : {};

  const order = [
    'incidents',
    'pallets',
    'shiftlogs',
    'overtime',
    'planner',
    'roster',
    'vacations',
    'staff',
    'data',
    'manager',
    'presentation',
    'permissions'
  ];

  for (const t of order) {
    const btn = document.getElementById('tab-' + t);
    const allowed = perms[t] !== false;
    const visible = btn && !btn.classList.contains('hidden');
    if (allowed && visible) return t;
  }

  const anyVisible =
    document.querySelector('#view-workforce .nav-tab:not(.hidden)');
  return anyVisible ? anyVisible.id.replace('tab-', '') : null;
}

        function switchPalletsTab(tabId) {
            document.querySelectorAll('.pallets-view').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('#subview-pallets .nav-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`pallets-view-${tabId}`)?.classList.remove('hidden');
            document.getElementById(`pallets-tab-${tabId}`)?.classList.add('active');
            if(tabId === 'open') renderPalletsTable();
            else if (tabId === 'history') renderPalletsHistoryTable();
        }

        function setTool(t) { currentTool = t; document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active')); document.querySelector(`button[onclick="setTool('${t}')"]`).classList.add('active'); }
        function initPlannerMatrix() {
            const year = document.getElementById('plannerYear').value; const month = document.getElementById('plannerMonth').value; const daysInMonth = new Date(year, month, 0).getDate(); const table = document.getElementById('planner-matrix');
            let html = `<thead><tr><th class="matrix-th" style="width:150px; left:0; z-index:20;">EMPLOYEE</th>`;
            for(let i=1; i<=daysInMonth; i++) { const d = new Date(year, month-1, i); const isWeekend = d.getDay()===5 || d.getDay()===6; html += `<th class="matrix-th ${isWeekend?'text-orange-400':''}">${i}<br><span class="text-[9px]">${d.toLocaleDateString('en-US',{weekday:'narrow'})}</span></th>`; }
            const actionHeader = (currentUser && currentUser.role === 'admin') ? `<th class="matrix-th" style="right:0; z-index:20; width:120px;">Actions</th>` : '';
            html += `${actionHeader}</tr></thead><tbody onmouseleave="isPainting=false">`;
            employees.forEach(emp => { 
                html += `<tr><td class="matrix-td-name">${emp.name}</td>`; 
                for(let i=1; i<=daysInMonth; i++) { 
                    const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(i).padStart(2,'0')}`; const dObj = new Date(year, month-1, i); const isWeekend = dObj.getDay()===5 || dObj.getDay()===6; 
                    
                    let isVacation = false;
                    if(vacations && Array.isArray(vacations)) {
                        isVacation = vacations.some(v => v.name === emp.name && new Date(v.start) <= dObj && new Date(v.end) >= dObj);
                    }
                    
                    let cls = isWeekend ? 'cell-weekend' : ''; let char = ''; 
                    
                    if (isVacation) {
                        cls = 'cell-vacation';
                        char = 'VAC';
                    } else if(shifts[dateStr]) {
                        if(shifts[dateStr].morning && shifts[dateStr].morning.includes(emp.name)) { cls = 'cell-m'; char = '1st'; } 
                        else if(shifts[dateStr].evening && shifts[dateStr].evening.includes(emp.name)) { cls = 'cell-e'; char = '2nd'; } 
                        else if(shifts[dateStr].night && shifts[dateStr].night.includes(emp.name)) { cls = 'cell-n'; char = '3rd'; } 
                        else if(shifts[dateStr].nowork && shifts[dateStr].nowork.includes(emp.name)) { cls = 'cell-nowork'; char = 'NW'; }
                    }
                    const interactions = (currentUser && currentUser.role === 'admin') ? `onmousedown="startPaint(this)" onmouseover="paint(this)" onmouseup="stopPaint()"` : '';
                    html += `<td class="matrix-cell ${cls}" data-date="${dateStr}" data-emp="${emp.name}" data-weekend="${isWeekend}" ${interactions}>${char}</td>`; 
                } 
                if(currentUser && currentUser.role === 'admin') {
                    html += `<td class="matrix-td-action"><div class="flex gap-1 justify-center">
                        <button onclick="fillMonth('${emp.name}', 'morning')" class="text-[10px] bg-yellow-400 text-black w-5 h-5 rounded font-bold hover:scale-110" title="Fill Morning">1st</button>
                        <button onclick="fillMonth('${emp.name}', 'evening')" class="text-[10px] bg-blue-400 text-black w-5 h-5 rounded font-bold hover:scale-110" title="Fill Evening">2nd</button>
                        <button onclick="fillMonth('${emp.name}', 'night')" class="text-[10px] bg-red-400 text-black w-5 h-5 rounded font-bold hover:scale-110" title="Fill Night">3rd</button>
                        <button onclick="fillMonth('${emp.name}', 'nowork')" class="text-[10px] bg-slate-500 text-white w-5 h-5 rounded font-bold hover:scale-110" title="Fill No Work">NW</button>
                        <button onclick="fillMonth('${emp.name}', 'clear')" class="text-[10px] bg-slate-600 text-white w-5 h-5 rounded font-bold hover:scale-110" title="Clear Month"><i class="fas fa-times"></i></button>
                    </div></td>`;
                }
                html += `</tr>`; 
            });
            table.innerHTML = html + `</tbody>`;
        }
        function startPaint(cell) { if(currentUser.role !== 'admin') return; isPainting = true; applyShift(cell); } function stopPaint() { isPainting = false; } function paint(cell) { if(isPainting) applyShift(cell); }
        function applyShift(cell) {
            if (cell.classList.contains('cell-vacation')) return; 
            if(cell.dataset.weekend === 'true' && currentTool !== 'nowork' && currentTool !== 'clear' || currentUser.role !== 'admin') return;
            const date = cell.dataset.date; const emp = cell.dataset.emp; updateShiftData(date, emp, currentTool);
            cell.className = 'matrix-cell'; cell.innerText = '';
            if(currentTool !== 'clear') {
                if (currentTool === 'morning') cell.classList.add('cell-m'); else if (currentTool === 'evening') cell.classList.add('cell-e');
                else if (currentTool === 'night') cell.classList.add('cell-n'); else if (currentTool === 'nowork') cell.classList.add('cell-nowork');
                cell.innerText = currentTool === 'morning' ? '1st' : currentTool === 'evening' ? '2nd' : currentTool === 'night' ? '3rd' : 'NW';
            }
        }
        function updateShiftData(date, emp, shiftType) { 
            if(!shifts[date]) shifts[date] = { morning:[], evening:[], night:[], nowork:[] }; 
            shifts[date].morning = shifts[date].morning.filter(n => n !== emp); shifts[date].evening = shifts[date].evening.filter(n => n !== emp); 
            shifts[date].night = shifts[date].night.filter(n => n !== emp); shifts[date].nowork = shifts[date].nowork.filter(n => n !== emp); 
            if(shiftType !== 'clear') shifts[date][shiftType].push(emp); 
        }
        function fillMonth(empName, shiftType) { 
            const year = document.getElementById('plannerYear').value; const month = document.getElementById('plannerMonth').value; const daysInMonth = new Date(year, month, 0).getDate(); 
            for(let i=1; i<=daysInMonth; i++) { 
                const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(i).padStart(2,'0')}`; const dObj = new Date(year, month-1, i);
                const isVacation = vacations.some(v => v.name === empName && new Date(v.start) <= dObj && new Date(v.end) >= dObj);
                if (isVacation) continue;
                if(shiftType !== 'nowork' && shiftType !== 'clear' && (dObj.getDay() === 5 || dObj.getDay() === 6)) continue; 
                updateShiftData(dateStr, empName, shiftType); 
            } 
            initPlannerMatrix(); Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: `Updated ${empName} to ${shiftType}`, showConfirmButton: false, timer: 1500 }); 
        }
        async function savePlanner() { 
            if (currentUser.role !== 'admin') return Swal.fire('Permission Denied', 'Only Admins can save the schedule.', 'error');
            if (await saveGithub('shifts.json', shifts)) Swal.fire('Saved', 'Monthly roster updated successfully.', 'success'); 
        }
        
        function copyTableToClipboard(elementId) {
            const el = document.getElementById(elementId); if (!el) return;
            const isPlannerMatrix = elementId === 'planner-matrix';
            if (isPlannerMatrix) {
                let textContent = "Monthly Shift Schedule\n";
                const rows = el.querySelectorAll('tr');
                rows.forEach((row) => {
                    let line = [];
                    row.querySelectorAll('th, td').forEach((cell, cIdx) => {
                        if (cIdx === row.querySelectorAll('th, td').length - 1 && row.querySelector('.matrix-td-action')) return;
                        let cellText = cell.innerText.replace(/\n/g, ' ').trim();
                     if (/^[=+\-@]/.test(cellText)) { cellText = "'" + cellText; }
                       line.push(cellText);
						
                    });
                    if (line.length > 0) textContent += line.join('\t') + '\n';
                });
                navigator.clipboard.writeText(textContent).then(() => { Swal.fire('Copied', 'Schedule table copied to clipboard as text.', 'success'); }).catch(() => {});
                return;
            }
            const noEmails = el.querySelectorAll('.no-email');
            noEmails.forEach(n => n.style.display = 'none');
            if (typeof html2canvas === 'function' && navigator.clipboard && window.ClipboardItem) {
                html2canvas(el).then(canvas => {
                    canvas.toBlob(async (blob) => {
                        try { await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]); Swal.fire('Copied', 'Table image copied to clipboard', 'success'); } catch (err) { Swal.fire('Error', 'Failed to copy image', 'error'); }
                        noEmails.forEach(n => n.style.display = '');
                    });
                });
            } else {
                const range = document.createRange(); range.selectNode(el); window.getSelection().removeAllRanges(); window.getSelection().addRange(range);
                try { const success = document.execCommand('copy'); Swal.fire(success ? 'Copied' : 'Error', success ? 'Table copied to clipboard' : 'Copy failed', success ? 'success' : 'error'); } catch (e) { Swal.fire('Error', 'Copy failed', 'error'); }
                window.getSelection().removeAllRanges();
                noEmails.forEach(n => n.style.display = '');
            }
        }

        let weekendSessionIds = []; 
function renderWeekendTable() {
            const preview = document.getElementById('weekend-table-preview');
            if (!preview) return;
            
            const sessionEntries = overtime.filter(o => weekendSessionIds.includes(o.id)).sort((a,b) => new Date(a.date) - new Date(b.date));
            
            if (sessionEntries.length === 0) { 
                preview.innerHTML = ''; 
                renderWeekendLog(); 
                return; 
            }
            
            const byDate = {};
            sessionEntries.forEach(o => {
                if (!byDate[o.date]) byDate[o.date] = { overtime: [], nowork: [] };
                if (o.type === 'overtime') byDate[o.date].overtime.push(o);
                if (o.type === 'nowork')  byDate[o.date].nowork.push(o);
            });

            const tableStyle = 'width:100%; border-collapse: collapse; font-family: Arial, sans-serif; font-size: 12px; color: black; background: white; border: 1px solid black;';
            
            const commonCellStyle = 'padding: 8px; border: 1px solid black; text-align: center; vertical-align: middle;';
            
            const headerStyle = `background-color: #9dc3e6; color: black; font-weight: bold; ${commonCellStyle}`;
            const subHeaderStyle = `background-color: #e7e6e6; color: black; font-weight: bold; ${commonCellStyle}`;
            const cellStyle = `color: black; ${commonCellStyle}`;
            const cellNameStyle = `padding: 8px; border: 1px solid black; text-align: left; vertical-align: middle; padding-left:10px; color: black;`;
            const noWorkStyle = `background-color: #f4b084; color: black; font-weight: bold; ${commonCellStyle}`;

            let html = `<table border="1" cellspacing="0" cellpadding="0" style="${tableStyle}">`;
            
            Object.keys(byDate).forEach(d => {
                const dayName = new Date(d).toLocaleDateString('en-US', { weekday:'long' });
                const dateFmt = new Date(d).toLocaleDateString('en-GB');
                
                html += `<tr><td colspan="5" align="center" valign="middle" style="${headerStyle}">${dayName} ${dateFmt}</td></tr>`;
                
                if (byDate[d].overtime.length === 0 && byDate[d].nowork.length > 0) { 
                    html += `<tr><td colspan="5" align="center" valign="middle" style="${noWorkStyle}">No Work</td></tr>`; 
                    return; 
                }
                
                if (byDate[d].overtime.length > 0) {
                    html += `<tr style="background-color: #e7e6e6;">
                        <td align="center" valign="middle" style="${subHeaderStyle}">Name</td>
                        <td align="center" valign="middle" style="${subHeaderStyle}">From</td>
                        <td align="center" valign="middle" style="${subHeaderStyle}">To</td>
                        <td align="center" valign="middle" style="${subHeaderStyle}">Task</td>
                        <td class="no-email" align="center" valign="middle" style="${subHeaderStyle}">Del</td>
                    </tr>`;
                    
                    byDate[d].overtime.forEach(i => {
                        html += `<tr>
                            <td align="left" valign="middle" style="${cellNameStyle}">${escapeHTML(i.name)}</td>
                            <td align="center" valign="middle" style="${cellStyle}">${formatTime12h(i.from)}</td>
                            <td align="center" valign="middle" style="${cellStyle}">${formatTime12h(i.to)}</td>
                            <td align="center" valign="middle" style="${cellStyle}">${(i.task && i.task.trim()) ? escapeHTML(i.task) : 'N/A'}</td>
                            <td class="no-email" align="center" valign="middle" style="${cellStyle}">
                                <button onclick="deleteWeekendEntry(${i.id})" style="color: red; font-weight: bold; cursor: pointer; border: none; background: none;"><i class="fas fa-times"></i></button>
                            </td>
                        </tr>`;
                    });
                }
            });
            
            html += `</table>`;
            preview.innerHTML = html;
            renderWeekendLog();
        }

        async function addNoWork() {
            const name = document.getElementById('otEmpSelect').value; const date = document.getElementById('otDate').value;
            if(!name || !date) return Swal.fire('Error', 'Select employee and date.', 'warning');
            const newId = Date.now();
            overtime.push({ id: newId, name, date, type: 'nowork', hours: 0, from: 'N/A', to: 'N/A', task: 'N/A' });
            weekendSessionIds.push(newId);
            await saveGithub('overtime.json', overtime); renderWeekendTable();
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: `No Work logged for ${name}`, showConfirmButton: false, timer: 1500 });
        }

        async function addOvertime() { 
            const name = document.getElementById('otEmpSelect').value; const date = document.getElementById('otDate').value; const from = document.getElementById('otTimeFrom').value; const to = document.getElementById('otTimeTo').value; const task = (document.getElementById('otTask')?.value || '').trim();
            if(!name || !date || !from || !to) return Swal.fire('Error', 'Fill all fields', 'warning'); 
            const d1 = new Date(`2000-01-01T${from}`); const d2 = new Date(`2000-01-01T${to}`); let hours = (d2 - d1) / 36e5; if(hours < 0) hours += 24; 
            const newId = Date.now();
            overtime.push({ id: newId, name, date, from, to, hours: parseFloat(hours.toFixed(1)), task: task || 'N/A', type: 'overtime' });
            weekendSessionIds.push(newId);
            await saveGithub('overtime.json', overtime); renderWeekendTable();
        }

        function finalizeWeekendSession() {
            weekendSessionIds = []; resetWeekendEntryForm();
            const preview = document.getElementById('weekend-table-preview'); if (preview) preview.innerHTML = '';
            Swal.fire({ toast:true, position:'top-end', icon:'success', title:'Weekend saved. Ready for new entry.', showConfirmButton:false, timer:1500 });
            renderWeekendLog();
        }

        async function deleteWeekendEntry(id) {
            const ok = await Swal.fire({ title: 'Delete?', text: 'This will remove the entry permanently.', icon: 'warning', showCancelButton: true, confirmButtonText: 'Delete' });
            if (!ok.isConfirmed) return;
            overtime = overtime.filter(o => o.id !== id); weekendSessionIds = weekendSessionIds.filter(x => x !== id);
            await saveGithub('overtime.json', overtime); renderWeekendTable(); renderWeekendLog();
        }

        function resetWeekendEntryForm() {
            const emp = document.getElementById('otEmpSelect'); const date = document.getElementById('otDate'); const from = document.getElementById('otTimeFrom'); const to = document.getElementById('otTimeTo'); const task = document.getElementById('otTask'); const preview = document.getElementById('weekend-table-preview');
            if (emp) emp.value = ''; if (date) date.value = ''; if (from) from.value = ''; if (to) to.value = ''; if (task) task.value = '';
            weekendSessionIds = []; if (preview) preview.innerHTML = ''; renderWeekendLog();
        }

        function handleShiftLogUpload(input) { const file = input.files[0]; if(!file) return; Papa.parse(file, { complete: async function(results) { const data = results.data; let newEntriesCount = 0; data.forEach((row, i) => { if(i === 0 || row.length < 8) return; const dateRaw = row[0]; if(!dateRaw) return; const parts = dateRaw.split('/'); const isoDate = `${parts[2]}-${parts[1]}-${parts[0]}`; if(!masterShiftLogs[isoDate]) masterShiftLogs[isoDate] = { morning:null, evening:null, night:null, nowork: null, displayDate: dateRaw }; const shiftRaw = row[1].toLowerCase().replace(/\s/g, ''); let key = 'morning'; if(shiftRaw.includes('second') || shiftRaw.includes('even')) key = 'evening'; if(shiftRaw.includes('third') || shiftRaw.includes('night')) key = 'night'; masterShiftLogs[isoDate][key] = { rec: row[2], disp: row[3], std: row[4], trucksPlan: row[5], trucksRec: row[6], trucksDisp: row[7] }; newEntriesCount++; }); await saveGithub('shift_logs_master.json', masterShiftLogs); const dates = Object.keys(masterShiftLogs).sort((a,b)=>new Date(a)-new Date(b)); if(dates.length > 0) { const lastDate = dates[dates.length-1]; updateDashboardShiftCards(lastDate, masterShiftLogs[lastDate]); } renderShiftTrendChart(); Swal.fire('Success', `Imported ${newEntriesCount} log entries.`, 'success'); input.value = ''; } }); }
        
        function updateDashboardShiftCards(isoDate, data) {
            const displayDate = data.displayDate || isoDate;
            document.getElementById('shift-log-display').classList.remove('hidden'); document.getElementById('shift-log-date').textContent = displayDate;
            const roster = shifts[isoDate] || { morning: [], evening: [], night: [], nowork: [] };
            const renderStats = (d, staffList) => {
            if (!d) return '<p class="italic opacity-50">No Data</p>';
            const staffStr = staffList && staffList.length > 0 ? staffList.map(s => escapeHTML(s)).join(', ') : 'No staff assigned';
             return `<div class="grid grid-cols-2 gap-2"><div><span class="block text-xs opacity-60 font-bold">PALLETS</span><div class="flex justify-between text-xs"><span>Rec:</span><span class="font-bold">${escapeHTML(d.rec)}</span></div><div class="flex justify-between text-xs"><span>Disp:</span><span class="font-bold">${escapeHTML(d.disp)}</span></div></div><div><span class="block text-xs opacity-60 font-bold">TRUCKS</span><div class="flex justify-between text-xs"><span>Plan:</span><span class="font-bold">${escapeHTML(d.trucksPlan)}</span></div><div class="flex justify-between text-xs"><span>Act:</span><span class="font-bold">${escapeHTML(d.trucksRec)}</span></div></div></div><div class="mt-2 text-[10px] text-slate-400"><span class="font-bold text-slate-300">Staff:</span> ${staffStr}</div>`;
};
            document.getElementById('card-stats-morning').innerHTML =  renderStats(data.morning, roster.morning); document.getElementById('card-staff-morning').innerHTML = roster.morning.map(n => `<div>${n}</div>`).join('') || 'No staff assigned';
            document.getElementById('card-stats-evening').innerHTML =  renderStats(data.evening, roster.evening); document.getElementById('card-staff-evening').innerHTML = roster.evening.map(n => `<div>${n}</div>`).join('') || 'No staff assigned';
            document.getElementById('card-stats-night').innerHTML =    renderStats(data.night, roster.night); document.getElementById('card-staff-night').innerHTML = roster.night.map(n => `<div>${n}</div>`).join('') || 'No staff assigned';

		}

function renderShiftTrendChart() {
    const ctxDisp = document.getElementById('chart-shift-dispatch');
    const ctxTrk = document.getElementById('chart-shift-trucks');
    
    if (window.shiftChartDisp instanceof Chart) window.shiftChartDisp.destroy();
    if (window.shiftChartTrk instanceof Chart) window.shiftChartTrk.destroy();

    if(!ctxDisp || !ctxTrk) return;

    const updateTitle = (canvas, newTitle) => {
        const titleEl = canvas.parentElement.querySelector('h5') || canvas.previousElementSibling;
        if (titleEl && titleEl.tagName === 'H5') titleEl.textContent = newTitle;
    };
    updateTitle(ctxDisp, "Daily Dispatch Volume (Shift Breakdown)");
    updateTitle(ctxTrk, "Daily Truck Traffic (Shift Breakdown)");
    
    const dates = Object.keys(masterShiftLogs).sort((a,b) => new Date(a) - new Date(b));
    const last30 = dates.slice(-30);
    const labels = last30.map(d => masterShiftLogs[d].displayDate || new Date(d).toLocaleDateString('en-GB', {day:'numeric', month:'short'}));

    const dDispM = [], dDispE = [], dDispN = [];
    const dTrkM = [], dTrkE = [], dTrkN = [];

    let maxTrucks = { val: -1, date: '-', breakdown: {m:0, e:0, n:0} };
    let maxPallets = { val: -1, date: '-', breakdown: {m:0, e:0, n:0} };
    
    const shiftStats = { 
        morning: { truckSum: 0, daysCount: 0, rec: 0, disp: 0 }, 
        evening: { truckSum: 0, daysCount: 0, rec: 0, disp: 0 }, 
        night:   { truckSum: 0, daysCount: 0, rec: 0, disp: 0 } 
    };

    const getVal = (obj, key1, key2) => {
        if (!obj) return 0;
        let v = obj[key1];
        if (v === undefined || v === null || v === '') v = obj[key2];
        return parseInt(v) || 0;
    };

    last30.forEach(dateKey => {
        const log = masterShiftLogs[dateKey];
        const displayDate = log.displayDate || new Date(dateKey).toLocaleDateString('en-GB', {day:'numeric', month:'short'});

        const mRec = getVal(log.morning, 'rec'); const mDisp = getVal(log.morning, 'disp'); const mTrk = getVal(log.morning, 'trucksRec', 'act');
        const eRec = getVal(log.evening, 'rec'); const eDisp = getVal(log.evening, 'disp'); const eTrk = getVal(log.evening, 'trucksRec', 'act');
        const nRec = getVal(log.night, 'rec');   const nDisp = getVal(log.night, 'disp');   const nTrk = getVal(log.night, 'trucksRec', 'act');

        dDispM.push(mDisp); dDispE.push(eDisp); dDispN.push(nDisp);
        dTrkM.push(mTrk);   dTrkE.push(eTrk);   dTrkN.push(nTrk);

        const totalTrkDay = mTrk + eTrk + nTrk;
        if (totalTrkDay > maxTrucks.val) {
            maxTrucks = { val: totalTrkDay, date: displayDate, breakdown: {m:mTrk, e:eTrk, n:nTrk} };
        }

        const totalPalletsDay = (mRec + mDisp) + (eRec + eDisp) + (nRec + nDisp);
        if (totalPalletsDay > maxPallets.val) {
            maxPallets = { val: totalPalletsDay, date: displayDate, breakdown: {m:(mRec+mDisp), e:(eRec+eDisp), n:(nRec+nDisp)} };
        }

        if (log.morning) { shiftStats.morning.truckSum += mTrk; shiftStats.morning.rec += mRec; shiftStats.morning.disp += mDisp; shiftStats.morning.daysCount++; }
        if (log.evening) { shiftStats.evening.truckSum += eTrk; shiftStats.evening.rec += eRec; shiftStats.evening.disp += eDisp; shiftStats.evening.daysCount++; }
        if (log.night)   { shiftStats.night.truckSum += nTrk;   shiftStats.night.rec += nRec;   shiftStats.night.disp += nDisp;   shiftStats.night.daysCount++; }
    });

    const commonOptions = {
        responsive: true, maintainAspectRatio: false,
        scales: { x: { stacked: true, grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 10 } } }, y: { stacked: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } } },
        plugins: { legend: { display: false } }
    };

    window.shiftChartDisp = new Chart(ctxDisp, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Morning', data: dDispM, backgroundColor: '#facc15' }, { label: 'Evening', data: dDispE, backgroundColor: '#3b82f6' }, { label: 'Night', data: dDispN, backgroundColor: '#ef4444' }] }, options: commonOptions });
    window.shiftChartTrk = new Chart(ctxTrk, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Morning', data: dTrkM, backgroundColor: '#facc15' }, { label: 'Evening', data: dTrkE, backgroundColor: '#3b82f6' }, { label: 'Night', data: dTrkN, backgroundColor: '#ef4444' }] }, options: commonOptions });

    renderShiftStatsCards(maxTrucks, maxPallets, shiftStats);
}

function renderShiftStatsCards(maxTrk, maxPlt, stats) {
    const container = document.getElementById('shift-stats-container');
    if (!container) return;

    const calcAvg = (s) => s.daysCount > 0 ? (s.truckSum / s.daysCount) : 0;
    const mAvg = calcAvg(stats.morning);
    const eAvg = calcAvg(stats.evening);
    const nAvg = calcAvg(stats.night);

    let best = { name: 'Morning', avg: mAvg, icon: 'sun', color: 'text-yellow-400', border: 'border-yellow-500', data: stats.morning };
    if (eAvg > best.avg) best = { name: 'Evening', avg: eAvg, icon: 'moon', color: 'text-blue-400', border: 'border-blue-500', data: stats.evening };
    if (nAvg > best.avg) best = { name: 'Night', avg: nAvg, icon: 'star', color: 'text-red-400', border: 'border-red-500', data: stats.night };

    if (maxTrk.val === -1) maxTrk.val = 0;
    if (maxPlt.val === -1) maxPlt.val = 0;
    const fmt = (n) => n.toLocaleString('en-US');

    container.innerHTML = `
        <div class="glass-card rounded-xl p-5 border-l-4 border-indigo-500 relative group flex flex-col justify-center transition-all hover:-translate-y-1">
            <h5 class="text-xs font-bold text-slate-400 uppercase mb-4 flex items-center gap-2">
                <i class="fas fa-truck-moving"></i> Peak Truck Traffic
            </h5>
            <div class="flex justify-between items-end">
                <div>
                    <span class="text-xs text-indigo-300 font-bold mb-1 block">Highest 24h Count</span>
                    <span class="text-3xl font-bold text-white num-font">${fmt(maxTrk.val)}</span>
                </div>
                <div class="text-right">
                    <span class="text-[10px] text-slate-500 block">Date</span>
                    <span class="text-xs font-bold text-white bg-dark-700 px-2 py-1 rounded">${maxTrk.date}</span>
                </div>
            </div>
            <div class="absolute inset-0 bg-dark-900/95 backdrop-blur-md z-20 flex flex-col justify-center px-6 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-xl pointer-events-none">
                <h6 class="text-indigo-400 text-xs font-bold uppercase mb-3 border-b border-indigo-500/30 pb-1 text-center">Traffic Breakdown</h6>
                <div class="space-y-2">
                    <div class="flex justify-between text-xs"><span class="text-yellow-400">Morning</span> <span class="text-white font-bold">${maxTrk.breakdown.m}</span></div>
                    <div class="flex justify-between text-xs"><span class="text-blue-400">Evening</span> <span class="text-white font-bold">${maxTrk.breakdown.e}</span></div>
                    <div class="flex justify-between text-xs"><span class="text-red-400">Night</span> <span class="text-white font-bold">${maxTrk.breakdown.n}</span></div>
                </div>
            </div>
        </div>

        <div class="glass-card rounded-xl p-5 border-l-4 border-emerald-500 relative group flex flex-col justify-center transition-all hover:-translate-y-1">
            <h5 class="text-xs font-bold text-slate-400 uppercase mb-4 flex items-center gap-2">
                <i class="fas fa-cubes"></i> Max Daily Throughput
            </h5>
            <div class="flex justify-between items-end">
                <div>
                    <span class="text-xs text-emerald-300 font-bold mb-1 block">Rec & Disp Volume</span>
                    <span class="text-3xl font-bold text-white num-font">${fmt(maxPlt.val)}</span>
                </div>
                <div class="text-right">
                    <span class="text-[10px] text-slate-500 block">Date</span>
                    <span class="text-xs font-bold text-white bg-dark-700 px-2 py-1 rounded">${maxPlt.date}</span>
                </div>
            </div>
            <div class="absolute inset-0 bg-dark-900/95 backdrop-blur-md z-20 flex flex-col justify-center px-6 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-xl pointer-events-none">
                <h6 class="text-emerald-400 text-xs font-bold uppercase mb-3 border-b border-emerald-500/30 pb-1 text-center">Volume Breakdown</h6>
                <div class="space-y-2">
                    <div class="flex justify-between text-xs"><span class="text-yellow-400">Morning</span> <span class="text-white font-bold">${fmt(maxPlt.breakdown.m)}</span></div>
                    <div class="flex justify-between text-xs"><span class="text-blue-400">Evening</span> <span class="text-white font-bold">${fmt(maxPlt.breakdown.e)}</span></div>
                    <div class="flex justify-between text-xs"><span class="text-red-400">Night</span> <span class="text-white font-bold">${fmt(maxPlt.breakdown.n)}</span></div>
                </div>
            </div>
        </div>

        <div class="glass-card rounded-xl p-5 border-l-4 ${best.border} relative group text-center flex flex-col items-center justify-center transition-all hover:-translate-y-1">
            <h5 class="text-xs font-bold text-slate-400 uppercase mb-3">Shift Efficiency Leader</h5>
            <div class="w-14 h-14 rounded-full bg-dark-700 flex items-center justify-center mb-2 shadow-lg border border-dark-600">
                <i class="fas fa-${best.icon} text-2xl ${best.color}"></i>
            </div>
            <h4 class="text-xl font-bold text-white">${best.name}</h4>
            <p class="text-[10px] text-slate-500 mt-1">Avg Activity: <span class="text-white font-mono font-bold">${best.avg.toFixed(1)}</span> Trucks/Day</p>
            
            <div class="absolute inset-0 bg-dark-900/95 backdrop-blur-md z-20 flex flex-col justify-center px-6 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-xl pointer-events-none">
                <h6 class="${best.color} text-xs font-bold uppercase mb-3 border-b border-dark-600 pb-1 text-center">${best.name} Totals (30d)</h6>
                <div class="space-y-2 w-full text-left">
                    <div class="flex justify-between text-xs"><span>Total Trucks</span> <b class="font-mono">${fmt(best.data.truckSum)}</b></div>
                    <div class="flex justify-between text-xs"><span>Total Rec</span> <b class="font-mono">${fmt(best.data.rec)}</b></div>
                    <div class="flex justify-between text-xs"><span>Total Disp</span> <b class="font-mono">${fmt(best.data.disp)}</b></div>
                </div>
            </div>
        </div>
    `;
}
        async function loadShiftLogs() {
            try { const data = await fetchGithub('shift_logs_master.json'); if (data && typeof data === 'object') masterShiftLogs = data; else masterShiftLogs = {}; } catch (e) { masterShiftLogs = {}; }
            renderShiftLogTable(); renderShiftTrendChart();
        }

        function renderShiftLogTable() {
    const body = document.getElementById('shiftlog-table-body'); if (!body) return; let html = '';
    const dates = Object.keys(masterShiftLogs).sort((a, b) => new Date(a) - new Date(b));
    dates.forEach(date => {
        const logs = masterShiftLogs[date]; const displayDate = logs.displayDate || new Date(date).toLocaleDateString('en-GB');
        ['morning','evening','night'].forEach(shift => { 
            const entry = logs[shift]; 
            if (entry) { 
                const rec = escapeHTML(entry.rec || ''); 
                const disp = escapeHTML(entry.disp || ''); 
                const plan = escapeHTML(entry.plan ?? entry.trucksPlan ?? ''); 
                const act  = escapeHTML(entry.act  ?? entry.trucksRec ?? ''); 
                html += `<tr><td class="p-2">${displayDate}</td><td class="p-2 capitalize">${shift}</td><td class="p-2">${rec}</td><td class="p-2">${disp}</td><td class="p-2">${plan}</td><td class="p-2">${act}</td><td class="p-2 text-center"><button onclick="deleteShiftLogRecord('${date}','${shift}')" class="text-red-500 hover:text-red-400"><i class="fas fa-trash"></i></button></td></tr>`; 
            } 
        });
    });
    if (!html) html = '<tr><td colspan="7" class="p-2 text-center text-slate-500">No entries</td></tr>'; body.innerHTML = html;
}

        async function addShiftLogRecord() {
            const date = document.getElementById('shiftlog-date').value; const shift = document.getElementById('shiftlog-shift').value; const rec = document.getElementById('shiftlog-pallets').value; const disp = document.getElementById('shiftlog-palletsDisp').value; const plan = document.getElementById('shiftlog-plan').value; const act  = document.getElementById('shiftlog-act').value;
            if (!date || !shift) { Swal.fire('Error', 'Date and shift are required.', 'warning'); return; }
            if (!masterShiftLogs[date]) { masterShiftLogs[date] = { morning: null, evening: null, night: null, nowork: null, displayDate: new Date(date).toLocaleDateString('en-GB') }; }
            masterShiftLogs[date][shift] = { rec: rec, disp: disp, plan: plan, act: act, trucksPlan: plan, trucksRec: act };
            await saveGithub('shift_logs_master.json', masterShiftLogs); renderShiftLogTable(); renderShiftTrendChart();
            document.getElementById('shiftlog-pallets').value = ''; document.getElementById('shiftlog-palletsDisp').value = ''; document.getElementById('shiftlog-plan').value = ''; document.getElementById('shiftlog-act').value = '';
            Swal.fire({ toast: true, icon: 'success', title: 'Entry added', timer: 1500, position: 'top-end', showConfirmButton: false });
        }

        async function deleteShiftLogRecord(date, shift) {
            if (!masterShiftLogs[date]) return; masterShiftLogs[date][shift] = null;
            const logs = masterShiftLogs[date]; if (!logs.morning && !logs.evening && !logs.night && !logs.nowork) delete masterShiftLogs[date];
            await saveGithub('shift_logs_master.json', masterShiftLogs); renderShiftLogTable(); renderShiftTrendChart();
            Swal.fire({ toast: true, icon: 'success', title: 'Entry deleted', timer: 1500, position: 'top-end', showConfirmButton: false });
        }

        async function loadPermissions() {
            try { const data = await fetchGithub('permissions.json'); if (data && typeof data === 'object') permissions = data; } catch (e) {}
            if (!permissions || Object.keys(permissions).length === 0) {
                const defaultCardPerms = (shiftLog, customCards, otLeaderboard, monthlySchedule, palletsSummary, vacations) => ({ 'shift-log-display': shiftLog, 'overview': true,  'storage': true,  'quality': true,  'inbound': true,  'outbound': true,  'finance': true,  'pending': true, 'monthly-schedule': monthlySchedule, 'vacations-section': vacations, 'pallets-summary': palletsSummary,  'custom-cards-grid': customCards,  'ot-leaderboard-section': otLeaderboard });
                permissions = {
                    admin: { dashboard:true, workforce:true, roster:true, planner:true, overtime:true, data:true, staff:true, incidents:true, pallets:true, manager:true, shiftlogs:true, permissions:true, presentation:true, vacations:true, cards: defaultCardPerms(true, true, true, true, true, true), slides: { overview:true, storage:true, quality:true, inbound:true, outbound:true, finance:true, pending:true } },
                    manager: { dashboard:true, workforce:true, roster:true, planner:true, overtime:true, data:false, staff:true, incidents:true, pallets:true, manager:true, shiftlogs:false, permissions:false, presentation:false, vacations:true, cards: defaultCardPerms(true, false, true, true, true, true), slides: { overview:true, storage:true, quality:true, inbound:true, outbound:true, finance:true, pending:true } },
                    guest: { dashboard:true, workforce:true, roster:true, planner:false, overtime:false, data:false, staff:false, incidents:false, pallets:false, manager:false, shiftlogs:false, permissions:false, presentation:false, vacations:false, cards: defaultCardPerms(false, false, false, false, true, false), slides: { overview:true, storage:true, quality:true, inbound:true, outbound:false, finance:false, pending:false } },
                    role1: { dashboard:true, workforce:true, roster:true, planner:false, overtime:false, data:false, staff:false, incidents:false, pallets:false, manager:false, shiftlogs:false, permissions:false, presentation:false, vacations:false, cards: defaultCardPerms(false, false, false, false, false, false), slides: { overview:true, storage:true, quality:true, inbound:false, outbound:false, finance:false, pending:false } },
                    role2: { dashboard:true, workforce:true, roster:true, planner:false, overtime:false, data:false, staff:false, incidents:false, pallets:false, manager:false, shiftlogs:false, permissions:false, presentation:false, vacations:false, cards: defaultCardPerms(false, false, false, false, false, false), slides: { overview:true, storage:false, quality:false, inbound:false, outbound:false, finance:false, pending:false } },
                    role3: { dashboard:true, workforce:true, roster:true, planner:false, overtime:false, data:false, staff:false, incidents:false, pallets:false, manager:false, shiftlogs:false, permissions:false, presentation:false, vacations:false, cards: defaultCardPerms(false, false, false, false, false, false), slides: { overview:true, storage:false, quality:false, inbound:false, outbound:false, finance:false, pending:false } },
                    role4: { dashboard:true, workforce:true, roster:true, planner:false, overtime:false, data:false, staff:false, incidents:false, pallets:false, manager:false, shiftlogs:false, permissions:false, presentation:false, vacations:false, cards: defaultCardPerms(false, false, false, false, false, false), slides: { overview:true, storage:false, quality:false, inbound:false, outbound:false, finance:false, pending:false } },
                    role5: { dashboard:true, workforce:true, roster:true, planner:false, overtime:false, data:false, staff:false, incidents:false, pallets:false, manager:false, shiftlogs:false, permissions:false, presentation:false, vacations:false, cards: defaultCardPerms(false, false, false, false, false, false), slides: { overview:true, storage:false, quality:false, inbound:false, outbound:false, finance:false, pending:false } }
                };
            }
            renderPermissionsForm();
        }

        function renderPermissionsForm() {
            const container = document.getElementById('permissions-form'); if (!container) return; const roles = Object.keys(permissions);
            const features = ['dashboard','workforce','roster','planner','overtime','data','staff','incidents','pallets','manager','shiftlogs','permissions','presentation','vacations'];
            let html = '<table class="w-full text-left text-sm"><thead><tr><th class="p-2">Role</th>' + features.map(f => `<th class="p-2 capitalize">${f}</th>`).join('') + '</tr></thead><tbody>';
            roles.forEach(role => { html += `<tr><td class="p-2 font-bold">${role}</td>`; features.forEach(feat => { const checked = permissions[role][feat] !== false ? 'checked' : ''; html += `<td class="p-2 text-center"><input type="checkbox" id="perm-${role}-${feat}" ${checked}></td>`; }); html += `</tr>`; });
            html += '</tbody></table>';
            const cards = [ { id: 'shift-log-display', label: 'Shift Log' }, { id: 'overview', label: 'Overview' }, { id: 'storage', label: 'Storage' }, { id: 'quality', label: 'Quality' }, { id: 'inbound', label: 'Inbound' }, { id: 'outbound', label: 'Outbound' }, { id: 'finance', label: 'Stock Reconciliation' }, { id: 'pending', label: 'Pending' }, { id: 'monthly-schedule', label: 'Monthly Schedule' }, { id: 'vacations-section', label: 'Vacations' }, { id: 'pallets-summary', label: 'PO Pallet Tracking' }, { id: 'custom-cards-grid', label: 'Custom Cards' }, { id: 'ot-leaderboard-section', label: 'Operational Overtime Log' } ];
            html += '<h4 class="mt-6 mb-2 text-sm font-bold">Dashboard Sections</h4><table class="w-full text-left text-sm"><thead><tr><th class="p-2">Role</th>' + cards.map(c => `<th class="p-2 text-xs">${c.label}</th>`).join('') + '</tr></thead><tbody>';
            roles.forEach(role => { html += `<tr><td class="p-2 font-bold">${role}</td>`; cards.forEach(card => { if (!permissions[role].cards) permissions[role].cards = {}; const checkedCard = permissions[role].cards[card.id] !== false ? 'checked' : ''; html += `<td class="p-2 text-center"><input type="checkbox" id="perm-card-${role}-${card.id}" ${checkedCard}></td>`; }); html += `</tr>`; });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderPresentationForm() {
            const container = document.getElementById('presentation-form'); if (!container) return; const roles = Object.keys(permissions);
            const slides = ['overview','storage','quality','inbound','outbound','finance','pending'];
            let html = '<table class="w-full text-left text-sm"><thead><tr><th class="p-2">Role</th>' + slides.map(s => `<th class="p-2 capitalize">${s}</th>`).join('') + '</tr></thead><tbody>';
            roles.forEach(role => { html += '<tr><td class="p-2 font-bold">' + role + '</td>'; slides.forEach(slide => { if (!permissions[role].slides) permissions[role].slides = {}; const checked = permissions[role].slides[slide] !== false ? 'checked' : ''; html += `<td class="p-2 text-center"><input type="checkbox" id="slide-${role}-${slide}" ${checked}></td>`; }); html += '</tr>'; });
            html += '</tbody></table>'; container.innerHTML = html;
        }

        async function savePresentationConfig() {
            const roles = Object.keys(permissions); const slides = ['overview','storage','quality','inbound','outbound','finance','pending'];
            roles.forEach(role => { if (!permissions[role].slides) permissions[role].slides = {}; slides.forEach(slide => { const cb = document.getElementById(`slide-${role}-${slide}`); permissions[role].slides[slide] = cb && cb.checked; }); });
            await saveGithub('permissions.json', permissions); Swal.fire({ toast:true, icon:'success', title:'Presentation settings saved', timer:1500, position:'top-end', showConfirmButton:false });
        }

        async function savePermissions() {
            const roles = Object.keys(permissions);
            const features = ['dashboard','workforce','roster','planner','overtime','data','staff','incidents','pallets','manager','shiftlogs','permissions','presentation','vacations'];
            const cards = ['shift-log-display','overview','storage','quality','inbound','outbound','finance','pending','monthly-schedule','vacations-section','pallets-summary','custom-cards-grid','ot-leaderboard-section'];
            roles.forEach(role => { features.forEach(feat => { const cb = document.getElementById(`perm-${role}-${feat}`); permissions[role][feat] = cb && cb.checked; }); if (!permissions[role].cards) permissions[role].cards = {}; cards.forEach(cardId => { const cbCard = document.getElementById(`perm-card-${role}-${cardId}`); if (cbCard) permissions[role].cards[cardId] = cbCard.checked; }); });
            await saveGithub('permissions.json', permissions); applyRoleUI(currentUser.role); Swal.fire({ toast:true, icon:'success', title:'Permissions saved', timer:1500, position:'top-end', showConfirmButton:false });
        }

        function exportPlannerExcel() {
    const table = document.getElementById('planner-matrix'); if (!table) return;
    let csvLines = []; let headerCells = ['EMPLOYEE'];
    const dateHeaders = table.querySelector('thead tr').querySelectorAll('th:not(:first-child, :last-child)');
    dateHeaders.forEach(th => { const dayNum = th.textContent.trim().split('\n')[0]; headerCells.push(dayNum); }); csvLines.push(headerCells.join(','));
    const shiftMap = { '1st': 'M', '2nd': 'E', '3rd': 'N', 'NW': 'NW', '': '' };
    
    for (let r = 1; r < table.rows.length; r++) { 
        const row = table.rows[r]; 
        const rowCells = []; 
        
        let empName = row.cells[0].innerText.replace(/,/g, ';').trim();
        if (/^[=+\-@]/.test(empName)) {
            empName = "'" + empName;
        }
        rowCells.push(empName);
        
        for (let c = 1; c < row.cells.length - 1; c++) { 
            const cellText = row.cells[c].innerText.trim(); 
            rowCells.push(shiftMap[cellText] || ''); 
        } 
        csvLines.push(rowCells.join(',')); 
    }
    const blob = new Blob([csvLines.join('\n')], { type: 'text/csv;charset=utf-8;' }); 
    const url = URL.createObjectURL(blob); const link = document.createElement('a'); 
    link.href = url; const year = document.getElementById('plannerYear').value; 
    const month = document.getElementById('plannerMonth').value; 
    link.download = `shift_schedule_${year}_${month}.csv`; 
    document.body.appendChild(link); link.click(); 
    document.body.removeChild(link); URL.revokeObjectURL(url);
}

        function renderWeekendLog() {
            const logDiv = document.getElementById('weekend-log-container'); if (!logDiv) return;
            const allEntries = overtime.sort((a,b)=>new Date(b.date) - new Date(a.date));
            
            if (allEntries.length === 0) { logDiv.innerHTML = '<p class="text-slate-500 text-sm mt-4">No weekend/OT logs yet.</p>'; return; }
            
            let html = '<h4 class="text-white font-bold text-sm mb-2 mt-4">Full OT/No Work Log (Admin Delete Only)</h4>';
            
            html += '<div class="scrollable-table-container custom-scrollbar"><table class="w-full text-left text-xs border-t border-dark-700">';
            
            html += '<thead class="bg-dark-800 text-slate-400 sticky-header"><tr><th class="p-2">Date</th><th class="p-2">Type</th><th class="p-2">Name</th><th class="p-2">Time/Hours</th><th class="p-2 text-center">Actions</th></tr></thead><tbody>';
            
            allEntries.forEach(item => { const dFmt = new Date(item.date).toLocaleDateString('en-GB'); const timeOrHours = item.type === 'overtime' ? `${formatTime12h(item.from)}-${formatTime12h(item.to)} (${item.hours}h)` : 'N/A'; const typeLabel = item.type === 'overtime' ? 'OT' : 'No Work'; const deleteBtn = currentUser.role === 'admin' ? `<button onclick="deleteOvertime(${item.id})" class="text-red-500 hover:text-red-400"><i class="fas fa-trash"></i></button>` : `<i class="fas fa-lock text-slate-600"></i>`; html += `<tr><td class="p-2">${dFmt}</td><td class="p-2 font-bold ${item.type === 'overtime' ? 'text-orange-400' : 'text-slate-400'}">${typeLabel}</td><td class="p-2">${item.name}</td><td class="p-2">${timeOrHours}</td><td class="p-2 text-center">${deleteBtn}</td></tr>`; });
            
            html += '</tbody></table></div>'; 
            logDiv.innerHTML = html;
        }

        async function deleteOvertime(id) {
            if (currentUser.role !== 'admin') { Swal.fire('Permission Denied', 'Only Admins can delete overtime records.', 'error'); return; }
            const idx = overtime.findIndex(o => o.id === id); if (idx >= 0) { overtime.splice(idx, 1); await saveGithub('overtime.json', overtime); renderWeekendTable(); Swal.fire({ toast:true, icon:'success', title:'Deleted', timer:1500, position:'top-end', showConfirmButton:false }); }
        }

function renderMonthlySchedule(monthStr) {
    if(!monthStr || monthStr === "ALL_TOTAL") return;
    
    const container = document.getElementById('dashboard-monthly-preview');
    
    if (permissions[currentUser.role]?.cards?.['monthly-schedule'] === false) { 
        container.parentElement.classList.add('hidden'); 
        return; 
    } else { 
        container.parentElement.classList.remove('hidden'); 
    }
    
    container.className = 'grid grid-cols-1 lg:grid-cols-3 gap-6'; 
    
    const parts = monthStr.split('-'); 
    if(parts.length < 2) return;
    
    const year = 2000 + parseInt(parts[0]); 
    const monthIdx = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"].indexOf(parts[1]);
    
    if(monthIdx === -1) return; 
    const daysInMonth = new Date(year, monthIdx + 1, 0).getDate();
    
    const staffSets = { morning: new Set(), evening: new Set(), night: new Set() };
    
    for(let i=1; i<=daysInMonth; i++) { 
        const dateStr = `${year}-${String(monthIdx+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`; 
        const dayData = shifts[dateStr]; 
        if(dayData) { 
            if(dayData.morning) dayData.morning.forEach(n => staffSets.morning.add(n)); 
            if(dayData.evening) dayData.evening.forEach(n => staffSets.evening.add(n)); 
            if(dayData.night) dayData.night.forEach(n => staffSets.night.add(n)); 
        } 
    }
    
    const shiftsMap = { 
        morning: { title: '1st Shift (Morning)', color: 'yellow', icon: 'fas fa-sun' }, 
        evening: { title: '2nd Shift (Evening)', color: 'blue', icon: 'fas fa-moon' }, 
        night: { title: '3rd Shift (Night)', color: 'red', icon: 'fas fa-star' } 
    };
    
    let html = ''; 
    Object.keys(shiftsMap).forEach(key => { 
        const conf = shiftsMap[key]; 
        const names = Array.from(staffSets[key]).sort(); 
        const count = names.length; 
        
        const listHtml = names.length > 0 ? 
            `<ul class="space-y-2 p-4">${names.map(n => `<li class="flex items-center text-sm text-slate-300 border-b border-white/5 pb-2 last:border-0"><div class="w-2 h-2 rounded-full bg-${conf.color}-500 mr-3"></div>${escapeHTML(n)}</li>`).join('')}</ul>` 
            : `<div class="p-6 text-center text-slate-500 italic text-sm">No staff assigned</div>`; 

        html += `<div class="glass-card rounded-xl overflow-hidden border-t-4 border-${conf.color}-500 flex flex-col h-full"><div class="p-4 bg-dark-800/80 border-b border-dark-600 flex items-center justify-between shrink-0"><h4 class="font-bold text-white text-sm flex items-center"><i class="${conf.icon} text-${conf.color}-500 mr-2"></i>${conf.title}</h4><span class="bg-${conf.color}-500/20 text-${conf.color}-400 text-xs px-2 py-1 rounded-full font-bold">${count} Staff</span></div><div class="bg-dark-900/40 flex-1 overflow-y-auto custom-scrollbar">${listHtml}</div></div>`; 
    });
    
    container.innerHTML = html;
}

        function renderManagerLeaderboard() { 
            const otSection = document.getElementById('ot-leaderboard-section');
            if (permissions[currentUser.role]?.cards?.['ot-leaderboard-section'] === false) { if(otSection) otSection.classList.add('hidden'); return; } else { if(otSection) otSection.classList.remove('hidden'); }
            const month = document.getElementById('otLeaderboardMonth')?.value || '';
            const totals = {}; overtime.filter(o => o.type === 'overtime').forEach(o => { if(month && !o.date.startsWith(month)) return; totals[o.name] = (totals[o.name]||0) + o.hours; }); 
            const sorted = Object.entries(totals).sort(([,a],[,b]) => b-a).slice(0, 10); const tbody = document.getElementById('mgr-leaderboard'); 
            if(tbody) tbody.innerHTML = sorted.map(([n,h], i) => `<tr><td class="p-3 text-brand-400 font-bold">#${i+1}</td><td class="p-3 text-white">${escapeHTML(n)}</td><td class="p-3 text-right font-mono">${h.toFixed(1)}</td></tr>`).join(''); 
        }
        
        async function openAddCardModal() { 
            const icons = ['box', 'truck', 'users', 'warehouse', 'clipboard-list', 'chart-line', 'dollar-sign', 'calendar-check', 'shipping-fast', 'boxes', 'pallet', 'dolly'];
            const iconHtml = `<div class="icon-grid">${icons.map(i => `<div class="icon-option" onclick="selectIcon('${i}')" id="icon-${i}"><i class="fas fa-${i}"></i></div>`).join('')}</div>`;
            window.selectedIcon = 'chart-bar';
            window.selectIcon = (i) => { window.selectedIcon = i; document.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected')); document.getElementById(`icon-${i}`).classList.add('selected'); };
            const { value: form } = await Swal.fire({ title: 'Add Metric Card', html: `<input id="swal-c-title" class="swal2-input" placeholder="Title"><input id="swal-c-val" class="swal2-input" placeholder="Main Value"><div class="my-2 border-t border-slate-600"></div><p class="text-xs text-slate-400 mb-2">Additional Details (Optional)</p><input id="swal-c-lbl" class="swal2-input" placeholder="Label 1"><input id="swal-c-val-2" class="swal2-input" placeholder="Value 1"><input id="swal-c-lbl-2" class="swal2-input" placeholder="Label 2"><input id="swal-c-val-3" class="swal2-input" placeholder="Value 2"><p class="text-xs text-slate-400 mt-2">Select Icon:</p>${iconHtml}`, background: '#1e293b', color: '#fff', preConfirm: () => [ document.getElementById('swal-c-title')?.value, document.getElementById('swal-c-val')?.value, window.selectedIcon, document.getElementById('swal-c-lbl')?.value, document.getElementById('swal-c-val-2')?.value, document.getElementById('swal-c-lbl-2')?.value, document.getElementById('swal-c-val-3')?.value ] }); 
            if(form && form[0]) { 
                const newCard = { title: form[0], value: form[1], icon: form[2] || 'chart-bar', details: [] };
                if(form[3] && form[4]) newCard.details.push({ label: form[3], value: form[4] }); if(form[5] && form[6]) newCard.details.push({ label: form[5], value: form[6] });
                customCards.push(newCard); await saveGithub('custom_cards.json', customCards); renderCustomCards(); 
            } 
        }

        function renderCustomCards() { 
            const con = document.getElementById('custom-cards-grid'); const list = document.getElementById('custom-metric-list'); 
            if (permissions[currentUser.role]?.cards?.['custom-cards-grid'] === false) { if(con) con.classList.add('hidden'); return; }
            if(customCards.length > 0 && con) con.classList.remove('hidden'); 
            const html = customCards.map((c, i) => {
                const detailsHtml = c.details ? c.details.map(d => `<div class="flex justify-between text-xs mt-1 pt-1 border-t border-white/5"><span class="text-slate-400">${escapeHTML(d.label)}</span><span class="text-white font-bold">${escapeHTML(d.value)}</span></div>`).join('') : '';
                return `<div class="glass-card rounded-2xl p-6 border-l-4 border-brand-500 relative group"><button onclick="delCard(${i})" class="absolute top-2 right-2 text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-trash"></i></button><div class="flex justify-between items-start mb-2"><div><h4 class="text-slate-400 text-xs font-bold uppercase">${escapeHTML(c.title)}</h4><p class="text-2xl font-bold text-white mt-1 num-font">${escapeHTML(c.value)}</p></div><div class="h-10 w-10 rounded-full bg-dark-800/50 flex items-center justify-center"><i class="fas fa-${c.icon} text-brand-500"></i></div></div>${detailsHtml}</div>`;
            }).join(''); 
            if(con) con.innerHTML = html; if(list) list.innerHTML = html; 
        }
        async function delCard(i) { 
            if (currentUser.role !== 'admin') return Swal.fire('Permission Denied', 'Only Admins can delete custom cards.', 'error');
            customCards.splice(i,1); await saveGithub('custom_cards.json', customCards); renderCustomCards(); 
        }

        async function fetchData() {
            document.getElementById('loadingOverlayData').style.display = 'flex';
            try {
                let jsonData = await fetchGithub('WHSdata.json'); if (!Array.isArray(jsonData)) jsonData = [];
                normalizeWHSData(jsonData); rawData = jsonData; rawCSVData = jsonData.map(r => ({ ...r }));
                document.getElementById('lastUpdateTxt').innerText = 'Synced'; document.getElementById('loadingOverlayData').style.display = 'none'; init();
            } catch (error) { rawData = []; rawCSVData = []; document.getElementById('loadingOverlayData').style.display = 'none'; init(); }
        }
        function init() {
            fullMonthList = [];
            rawData.forEach(d => { let m = d.Report_Month || ''; if (typeof m === 'string') { if (!m.includes('-') && m.length >= 5) m = m.slice(0, 2) + '-' + m.slice(2); } if (m && !fullMonthList.includes(m)) fullMonthList.push(m); });
            fullMonthList.sort((a, b) => { const [ay, am] = a.split('-'); const [by, bm] = b.split('-'); const monthOrder = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; const ayNum = parseInt(ay); const byNum = parseInt(by); if (ayNum !== byNum) return ayNum - byNum; return monthOrder.indexOf(am) - monthOrder.indexOf(bm); });
            const sel = document.getElementById('monthSelect'); const currentSelection = sel.value; sel.innerHTML = '';
            fullMonthList.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
            if (fullMonthList.includes(currentSelection)) sel.value = currentSelection; else sel.value = fullMonthList[fullMonthList.length - 1];
            sel.onchange = render;
            selectedWarehouses = [...WH_ORDER];
            render(); renderCSVEditor(); renderCSVForm(); renderWarehouseFilters(); updateSectionVisibility();
        }
        
        async function saveManualMetrics() {
            const m = document.getElementById('mm-month').value; const w = document.getElementById('mm-wh').value; if(!manualMetrics[m]) manualMetrics[m] = {};
            manualMetrics[m][w] = { capacity: parseFloat(document.getElementById('mm-cap').value) || 0, used: parseFloat(document.getElementById('mm-used').value) || 0, sap: parseFloat(document.getElementById('mm-sap').value) || 0, rsd: parseFloat(document.getElementById('mm-rsd').value) || 0, pod: parseFloat(document.getElementById('mm-pod').value) || 0, ret: parseFloat(document.getElementById('mm-ret').value) || 0 };
            await saveGithub('manual_metrics.json', manualMetrics); renderDashboard(); Swal.fire({ toast: true, icon: 'success', title: 'Metrics Saved', timer: 1500 });
        }

        function render() {
            const cur = document.getElementById('monthSelect').value; const curIndex = fullMonthList.indexOf(cur);
            const startIndex = Math.max(0, curIndex - 11); monthList = fullMonthList.slice(startIndex, curIndex + 1);
            let prev = null; if (cur !== 'ALL_TOTAL') { const idx = fullMonthList.indexOf(cur); prev = (idx > 0) ? fullMonthList[idx - 1] : null; }
            clearGrids(); renderOverview(cur, prev); renderStorage(cur, prev); renderQuality(cur, prev); renderInbound(cur, prev); renderOutbound(cur, prev); renderRSD(cur, prev); renderPending(cur, prev); renderMonthlySchedule(cur); updateAllCharts(); renderShiftTrendChart();
        }

        function getMetric(m, wh, col, isPercent) { 
            if(manualMetrics[m] && manualMetrics[m][wh]) {
                const man = manualMetrics[m][wh];
                if(col === 'Capacity') return man.capacity; if(col === 'Utalized' || col === 'Average storage in the warehouse') return man.used; if(col === 'SAP') return man.sap; if(col === 'RSD') return man.rsd; if(col === 'POD pending') return man.pod; if(col === 'Return pending') return man.ret;
            }
            if (!m) return 0;

if (m.startsWith('ALL')) {
  const rows = rawData.filter(d => (d.Warehouse_Name || '').toUpperCase().includes(wh));
  if (!rows.length) return 0;

  let s = 0, c = 0;
  rows.forEach(r => {
    const raw = r?.[col];
    const txt = (raw ?? '').toString().trim();
    if (!txt || ['NA', 'N/A', '-', 'null', 'undefined'].includes(txt.toUpperCase())) return;

    const v = parseNum(raw);
    if (Number.isFinite(v)) { s += v; c++; }
  });

  return c ? (s / c) : 0;
}

			
            const rec = rawData.find(d => { let monthVal = d.Report_Month; if (typeof monthVal === 'string' && !monthVal.includes('-') && monthVal.length >= 5) monthVal = monthVal.slice(0, 2) + '-' + monthVal.slice(2); return monthVal === m && d.Warehouse_Name.toUpperCase().includes(wh); });
            if (!rec) return 0; return parseNum(rec[col]);
        }

    function handleSessionExpiry() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userRole');
        localStorage.removeItem('userName');
        Swal.fire({
            title: 'Session Expired',
            text: 'Please login again.',
            icon: 'warning',
            confirmButtonText: 'Login'
        }).then(() => {
            location.reload();
        });
    }


    async function fetchGithub(file) {
        const token = localStorage.getItem('authToken');
        if (!token) return null;

        try {
            const response = await fetch(`${WORKER_URL}/api/github-get`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ filename: file })
            });

            if (response.status === 401) {
                handleSessionExpiry();
                return null;
            }
            return await response.json();
        } catch (e) {
            console.error(e);
            return null;
        }
    }

    async function saveGithub(file, content) {
        const token = localStorage.getItem('authToken');
        if (!token) {
            Swal.fire('Error', 'You must be logged in.', 'error');
            return false;
        }

        try {
            let prepared = content;
            if (content && typeof content === 'object') {
                try { prepared = JSON.stringify(content, null, 2); } catch (e) { prepared = JSON.stringify(content); }
            }

            const res = await fetch(`${WORKER_URL}/api/github-save`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ filename: file, content: prepared, message: 'Update via Dashboard' })
            });

            if (res.status === 401) {
                handleSessionExpiry();
                return false;
            }

            if (res.ok) {
                const indicator = document.getElementById('save-indicator');
                if (indicator) {
                    indicator.classList.remove('hidden');
                    setTimeout(() => indicator.classList.add('hidden'), 2000);
                }
                return true;
            } else {
                return false;
            }
        } catch (e) {
            Swal.fire('Error', 'Token Issue', 'error');
            return false;
        }
    }


    async function backgroundRefresh() {
        const updElem = document.getElementById('lastUpdateTxt');
        if (updElem) updElem.innerText = 'Auditing...';
        try {
            const [jsonData, empData, shiftsData, otData, customCardsData, masterShiftLogsData, manualMetricsData, vacData] = await Promise.all([
                fetchGithub('WHSdata.json'),
                fetchGithub('employees.json'),
                fetchGithub('shifts.json'),
                fetchGithub('overtime.json'),
                fetchGithub('custom_cards.json'),
                fetchGithub('shift_logs_master.json'),
                fetchGithub('manual_metrics.json'),
                fetchGithub('vacations.json')
            ]);
            
            rawData = Array.isArray(jsonData) ? jsonData : [];
            normalizeWHSData(rawData);
            rawCSVData = rawData.map(r => ({ ...r }));
            
            employees = Array.isArray(empData) ? empData : [];
            shifts = (shiftsData && typeof shiftsData === 'object' && !Array.isArray(shiftsData)) ? shiftsData : {};
            overtime = Array.isArray(otData) ? otData : [];
            customCards = Array.isArray(customCardsData) ? customCardsData : [];
            masterShiftLogs = (typeof masterShiftLogsData === 'object' && masterShiftLogsData !== null) ? masterShiftLogsData : {};
            manualMetrics = (typeof manualMetricsData === 'object' && manualMetricsData !== null) ? manualMetricsData : {};
            vacations = Array.isArray(vacData) ? vacData : [];

            init();
            renderWeekendTable();
            renderEmpTable();
            renderCustomCards();
            renderManagerLeaderboard();
            renderPalletsTable();
            renderPalletsHistoryTable();
            renderPalletsOverview();
            renderManagerReports();
            renderVacationsManager();
            renderVacationsDashboard();

            if (updElem) {
                const now = new Date();
                updElem.innerText = `Synced  ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
            }
        } catch (e) {
            if (updElem) updElem.innerText = 'Sync Error';
        }
    }

    function clearGrids() {
    sparklineInstances.forEach(c => c.destroy());
    sparklineInstances = [];
    
    const gridsToClear = [
        'row-orders', 'row-returns', 
        'storage-grid', 'quality-grid', 
        'inbound-cases-grid', 'inbound-pallets-grid', 'inbound-trucks-grid', 
        'outbound-cases-grid', 'outbound-pallets-grid', 
        'outbound-total-trucks-grid', 
        'outbound-destinations-grid', 
        'outbound-trips-grid',
        'rsd-grid', 'pod-pending-grid', 'return-pending-grid'
    ];

    gridsToClear.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
    });
}

    async function refreshAllData() {
        document.getElementById('loadingOverlayData').style.display = 'flex';
        await backgroundRefresh();
        document.getElementById('loadingOverlayData').style.display = 'none';
    }

    function createCard(id, t, v, u, diff, trendData, c, historyData) {
    const clr = { blue: '#3b82f6', green: '#10b981', orange: '#f97316', red: '#ef4444', brand: '#6366f1' }[c] || '#6366f1';
    const cid = `c-${Math.random().toString(36).substr(2, 9)}`;
    const target = document.getElementById(id);

    const esc = (x) => String(x ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

    let historyHtml = '';
    if (historyData && historyData.length > 0) {
        historyData.forEach(h => {
  const hv = (h && h.value !== null && h.value !== undefined && isFinite(h.value)) ? Number(h.value).toLocaleString('en-US') : 'N/A';
  historyHtml += `<div class="flex justify-between text-xs text-white border-b border-white/10 pb-1 mb-1 last:border-0 last:mb-0"><span>${h.month ?? '--'}</span><span>${hv}</span></div>`;
});

    } else {
        historyHtml = '<div class="text-xs text-slate-400 italic">No history available</div>';
    }

    if (!target) return;

    const html = `
<div class="glass-card rounded-2xl p-6 border-l-4 group relative"
     style="border-left-color:${clr}"
     data-snap="1"
     data-grid="${esc(id)}"
     data-title="${esc(t)}"
     data-value="${esc(v)}"
     data-unit="${esc(u)}">
  <div class="flex justify-between mb-3">
    <div>
      <h4 class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">${esc(t)}</h4>
      <div class="flex items-baseline gap-2">
        <span class="text-3xl font-bold text-white num-font">${esc(v)}</span>
        <span class="text-xs text-slate-500">${esc(u)}</span>
      </div>
    </div>
    <div class="text-right">
      <div class="h-10 w-10 rounded-full bg-dark-800/50 flex items-center justify-center ml-auto mb-1">
        <i class="fas fa-chart-bar text-lg" style="color:${clr}"></i>
      </div>
      <span class="text-xs font-bold ${diff.cls} flex items-center justify-end gap-1">
        <i class="fas fa-${diff.icon}"></i> ${esc(diff.value)}
      </span>
    </div>
  </div>

  <div class="grid grid-cols-2 gap-3 text-xs mt-2">
    <div class="bg-dark-900/50 rounded-lg p-2 border border-white/5">
      <div class="text-slate-400 font-bold uppercase tracking-widest text-[10px] mb-1">Trend</div>
      <div class="h-10 w-full"><canvas id="${cid}"></canvas></div>
    </div>
    <div class="bg-dark-900/50 rounded-lg p-2 border border-white/5">
      <div class="text-slate-400 font-bold uppercase tracking-widest text-[10px] mb-1">History</div>
      ${historyHtml}
    </div>
  </div>
</div>`;

    target.insertAdjacentHTML('beforeend', html);

    setTimeout(() => {
        const ctx = document.getElementById(cid);
        let chartInstance;
        if (ctx) {
          const labels = monthList.slice(Math.max(0, monthList.length - 6));
          const dataPoints = Array.isArray(trendData) ? trendData.slice(-labels.length) : [];
          // Build a new chart instance so we can access it later
          chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                data: dataPoints,
                borderColor: clr,
                borderWidth: 2,
                pointRadius: 0,
                spanGaps: false,
                fill: { target: 'origin', above: clr + '15' }
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { display: false },
                y: { display: false }
              },
              plugins: { legend: { display: false }, tooltip: { enabled: false } },
              elements: { line: { tension: 0.35 } }
            }
          });
        }
        // Only push the chart instance if one was created; this avoids ReferenceErrors
        if (chartInstance) sparklineInstances.push(chartInstance);
    }, 30);
}


    function parseNum(v) { if (v === null || v === undefined) return 'N/A'; let s = v.toString().trim(); if (!s || s === 'NA' || s === '-' || s.includes('<')) return 'N/A'; const num = parseFloat(s.replace(/%/g, '').replace(/,/g, '')); return isNaN(num) ? 'N/A' : num; }
	function normalizeWHSData(arr) {
    if (!Array.isArray(arr)) return;
    
    const required = [
        'Report_Month', 'Warehouse_Name', 
        'Orders/Month', 'Returns', 
        'Capacity', 'Utalized', 
        'On-Time Delivery', 'Order Fill Rate', 'Order Accuracy', 'Correct Documentation', 'Customer Claims', 'Shipping utilization', 
        'inbound Case', 'Inbound Pallets', 'Inbound Trucks 45 ft', 
        'Outbound Case', 'Outbound Pallets', 
        'Outbound Trucks 45 ft', 'Outbound_20_TON', 'Outbound_10_TON', 'Outbound_5_TON',
        'TOTAL TRIPS', 'TOTAL DESTINATIONS',
        'SAP', 'RSD', 
        'POD pending', 'Return pending'
    ];
    
    arr.forEach(row => { 
        required.forEach(key => { 
            if (!Object.prototype.hasOwnProperty.call(row, key) || row[key] === undefined) { 
                row[key] = ''; 
            } 
        }); 
        
        Object.keys(row).forEach(key => {
            if (!required.includes(key)) {
                delete row[key];
            }
        });
    });
}
function formatNum(n) {
  return (n === null || n === undefined || !Number.isFinite(n)) ? 'N/A' : n.toLocaleString('en-US');
}

function calcDiff(c, p) {
  const curr = (typeof c === 'number' && isFinite(c)) ? c : null;
  const prev = (typeof p === 'number' && isFinite(p)) ? p : null;

  if (curr === null || prev === null) {
    return { val: '', value: '', icon: 'minus', cls: 'text-slate-500' };
  }

  if (prev === 0) {
    const v = curr > 0 ? '+100%' : '0%';
    return { val: v, value: v, icon: 'minus', cls: 'text-slate-500' };
  }

  const raw = ((curr - prev) / prev) * 100;
  const v = (raw >= 0 ? '+' : '-') + Math.abs(raw).toFixed(1) + '%';
  return { val: v, value: v, icon: raw >= 0 ? 'arrow-up' : 'arrow-down', cls: raw >= 0 ? 'text-green-400' : 'text-red-400' };
}


function toNumOrNull(v) {
  const n = parseNum(v);
  if (n === 'N/A' || n === null || n === undefined) return null;
  return Number.isFinite(n) ? n : null;
}

function getTrend(wh, col) {
  const months = monthList.slice(Math.max(0, monthList.length - 6));
  return months.map(m => toNumOrNull(getMetric(m, wh, col)));
}

function getLast3Months(wh, col) {
  const currentMonth = document.getElementById('monthSelect')?.value;
  const idx = monthList.indexOf(currentMonth);
  if (idx === -1) return [];

  const out = [];
  for (let i = Math.max(0, idx - 2); i <= idx; i++) {
    const m = monthList[i];
    out.push({ month: m, value: toNumOrNull(getMetric(m, wh, col)) });
  }
  return out;
}

function renderOverview(currentMonth, previousMonth) {
  selectedWarehouses.forEach(wh => {
    const curOrders = toNumOrNull(getMetric(currentMonth, wh, 'Orders/Month'));
    const prevOrders = toNumOrNull(getMetric(previousMonth, wh, 'Orders/Month'));
    createCard(
      'row-orders',
      wh,
      formatNum(curOrders),
      'Orders',
      calcDiff(curOrders, prevOrders),
      getTrend(wh, 'Orders/Month'),
      'blue',
      getLast3Months(wh, 'Orders/Month')
    );

    const curReturns = toNumOrNull(getMetric(currentMonth, wh, 'Returns'));
    const prevReturns = toNumOrNull(getMetric(previousMonth, wh, 'Returns'));
    createCard(
      'row-returns',
      wh,
      formatNum(curReturns),
      'Returns',
      calcDiff(curReturns, prevReturns),
      getTrend(wh, 'Returns'),
      'red',
      getLast3Months(wh, 'Returns')
    );
  });
}


function renderStorage(c, p) {
        selectedWarehouses.forEach(wh => {
            const cap = getMetric(c, wh, 'Capacity'); const used = getMetric(c, wh, 'Utalized');
            let pct = 0; if (cap > 0 && used >= 0) { pct = ((used / cap) * 100).toFixed(1); } else if (used > 0 && cap === 0) { pct = 100; }
            const prevCap = getMetric(p, wh, 'Capacity'); const prevUsed = getMetric(p, wh, 'Utalized'); let prevPct = 0; if (prevCap > 0 && prevUsed >= 0) { prevPct = ((prevUsed / prevCap) * 100).toFixed(1); }
            const cid = `chart-storage-${wh.replace(/\s/g, '')}-${Math.random().toString(36).substr(2, 5)}`;
            const html = `<div class="glass-card rounded-2xl p-6 border-l-4 border-orange-500"><div class="flex justify-between items-start mb-4"><div><h4 class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">${wh}</h4><div class="flex items-baseline gap-2 mt-1"><span class="text-3xl font-bold text-white num-font">${pct}%</span><span class="text-xs text-slate-500">Utilized</span></div></div><div class="text-right"><p class="text-xs text-slate-400 flex justify-between gap-4"><span>Capacity:</span> <span class="text-white font-mono font-bold">${formatNum(cap)}</span></p><p class="text-xs text-slate-400 flex justify-between gap-4"><span>Used:</span> <span class="text-white font-mono font-bold">${formatNum(used)}</span></p></div></div><div class="w-full bg-dark-800 h-2 rounded-full overflow-hidden mb-4 relative"><div class="bg-orange-500 h-full transition-all duration-500" style="width: ${Math.min(pct, 100)}%"></div></div><div class="h-24 w-full mt-2"><canvas id="${cid}"></canvas></div></div>`;
            document.getElementById('storage-grid').insertAdjacentHTML('beforeend', html);
            setTimeout(() => { const ctx = document.getElementById(cid); if (ctx) { new Chart(ctx, { type: 'bar', data: { labels: ['Previous', 'Current'], datasets: [{ label: 'Utilization %', data: [prevPct, pct], backgroundColor: ['#334155', '#f97316'], borderRadius: 4, barThickness: 30 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, grid: { color: '#1e293b' }, ticks: { display: false } }, x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 10 } } } } } }); } }, 50);
        });
    }

    function renderQuality(c, p) {
        selectedWarehouses.forEach(wh => {
            const el = document.getElementById('quality-grid'); if (!el) return;
            const metrics = [{ name: 'On-Time Delivery', col: 'On-Time Delivery' }, { name: 'Order Fill Rate', col: 'Order Fill Rate' }, { name: 'Order Accuracy', col: 'Order Accuracy' }, { name: 'Correct Documentation', col: 'Correct Documentation' }, { name: 'Customer Claims', col: 'Customer Claims' }, { name: 'Shipping utilization', col: 'Shipping utilization' }];
            let rowsHtml = '';
            metrics.forEach(m => { const val = getMetric(c, wh, m.col, true); const pct = val || 0; rowsHtml += `<div class="mb-2"><div class="flex justify-between text-xs mb-1"><span class="text-slate-300">${m.name}</span><span class="font-bold text-white">${pct.toFixed(1)}%</span></div><div class="w-full bg-dark-700 h-1.5"><div class="bg-green-500 h-1.5" style="width:${pct}%"></div></div></div>`; });
            el.insertAdjacentHTML('beforeend', `<div class="glass-card rounded-2xl p-6 border-l-4 border-green-500"><h4 class="text-slate-400 text-xs font-bold uppercase mb-4">${wh}</h4>${rowsHtml}</div>`);
        });
    }
    function renderInbound(c, p) { renderMetricGroup('inbound-cases-grid', c, p, 'inbound Case', 'Box'); renderMetricGroup('inbound-pallets-grid', c, p, 'Inbound Pallets', 'Plt'); renderMetricGroup('inbound-trucks-grid', c, p, 'Inbound Trucks 45 ft', 'Trk'); }
  function renderOutbound(c, p) { 
    renderMetricGroup('outbound-cases-grid', c, p, 'Outbound Case', 'Box'); 
    
    renderMetricGroup('outbound-pallets-grid', c, p, 'Outbound Pallets', 'Plt'); 
    
    renderOutboundTrucksDetailed(c, p); 

    renderMetricGroup('outbound-destinations-grid', c, p, 'TOTAL DESTINATIONS', 'Dest'); 

    renderMetricGroup('outbound-trips-grid', c, p, 'TOTAL TRIPS', 'Trips'); 
}

function renderOutboundTrucksDetailed(c, p) {
    const container = document.getElementById('outbound-total-trucks-grid');
    if (!container) return;
    container.innerHTML = '';

    const safeVal = (val) => {
        if (val === 'N/A' || val === null || val === undefined || isNaN(val)) return 0;
        return parseFloat(val);
    };

    const getTotalTrucksForMonth = (month, wh) => {
        const v45 = safeVal(getMetric(month, wh, 'Outbound Trucks 45 ft'));
        const v20 = safeVal(getMetric(month, wh, 'Outbound_20_TON'));
        const v10 = safeVal(getMetric(month, wh, 'Outbound_10_TON'));
        const v5  = safeVal(getMetric(month, wh, 'Outbound_5_TON'));
        return v45 + v20 + v10 + v5;
    };

    selectedWarehouses.forEach(wh => {
        let clr = '#6366f1'; 
        if (wh === 'PROCEED') clr = '#60a5fa';      
        else if (wh === 'DSV') clr = '#60a5fa';     
        else if (wh === 'SPIMACO') clr = '#60a5fa'; 

        const t45 = safeVal(getMetric(c, wh, 'Outbound Trucks 45 ft'));
        const t20 = safeVal(getMetric(c, wh, 'Outbound_20_TON'));
        const t10 = safeVal(getMetric(c, wh, 'Outbound_10_TON'));
        const t5  = safeVal(getMetric(c, wh, 'Outbound_5_TON'));
        const total = t45 + t20 + t10 + t5;
        
        const prevTotal = getTotalTrucksForMonth(p, wh);
        const diff = calcDiff(total, prevTotal);

        let historyHtml = '';
        const currentMonth = document.getElementById('monthSelect').value;
        const idx = monthList.indexOf(currentMonth);
        if(idx !== -1) {

            for(let i = Math.max(0, idx-2); i <= idx; i++) {
                const m = monthList[i];
                const histVal = getTotalTrucksForMonth(m, wh);
                historyHtml += `
                <div class="flex justify-between text-xs text-white border-b border-white/10 pb-1 mb-1 last:border-0 last:mb-0">
                    <span>${m}</span>
                    <span class="font-mono font-bold">${formatNum(histVal)}</span>
                </div>`;
            }
        } else {
            historyHtml = '<div class="text-xs text-slate-400 italic">No history available</div>';
        }


        const html = `
        <div class="glass-card rounded-2xl p-5 border-l-4 relative group" style="border-left-color:${clr}">
            
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h4 class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">${wh} - TRUCKS</h4>
                    <div class="flex items-baseline gap-2">
                        <span class="text-3xl font-bold text-white num-font">${formatNum(total)}</span>
                        <span class="text-xs text-slate-500">Total</span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="h-8 w-8 rounded-full bg-dark-800/50 flex items-center justify-center ml-auto mb-1">
                        <i class="fas fa-truck text-md" style="color:${clr}"></i>
                    </div>
                   <span class="text-xs font-bold ${diff.cls} flex items-center justify-end gap-1">
  <i class="fas fa-${diff.icon}"></i>
  <span class="num-font tracking-tight">${diff.val}</span>
</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2 mt-4 pt-3 border-t border-white/5">
                <div class="flex justify-between items-center text-xs">
                    <span class="text-slate-400">45 FT</span>
                    <span class="font-bold text-white font-mono">${formatNum(t45)}</span>
                </div>
                <div class="flex justify-between items-center text-xs">
                    <span class="text-slate-400">20 TON</span>
                    <span class="font-bold text-white font-mono">${formatNum(t20)}</span>
                </div>
                <div class="flex justify-between items-center text-xs">
                    <span class="text-slate-400">10 TON</span>
                    <span class="font-bold text-white font-mono">${formatNum(t10)}</span>
                </div>
                <div class="flex justify-between items-center text-xs">
                    <span class="text-slate-400">5 TON</span>
                    <span class="font-bold text-white font-mono">${formatNum(t5)}</span>
                </div>
            </div>

            <div class="absolute inset-0 bg-dark-900/95 backdrop-blur-sm z-20 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 p-4 rounded-2xl pointer-events-none">
                <h5 class="text-brand-400 text-xs font-bold uppercase mb-3 border-b border-brand-500/30 pb-1 w-full text-center">Last 3 Months</h5>
                <div class="w-full space-y-1">
                    ${historyHtml}
                </div>
            </div>

        </div>`;

        container.insertAdjacentHTML('beforeend', html);
    });
}

	
    function renderMetricGroup(id, c, p, col, u) { selectedWarehouses.forEach(wh => { createCard(id, wh, formatNum(getMetric(c, wh, col)), u, calcDiff(getMetric(c, wh, col), getMetric(p, wh, col)), getTrend(wh, col), 'blue', getLast3Months(wh, col)); }); }
function renderRSD(c, p) { 
    selectedWarehouses.forEach(wh => { 
        const sap = getMetric(c, wh, 'SAP'); 
        const rsd = getMetric(c, wh, 'RSD'); 
        
        let match = 0;
        if (sap > 0 && rsd > 0) {
            match = (Math.min(sap, rsd) / Math.max(sap, rsd)) * 100;
        } else if (sap === 0 && rsd === 0) {
            match = 100; 
        }

        
        const diffVal = sap - rsd;
        const diffObj = { 
            val: formatNum(Math.abs(diffVal)), 
            icon: diffVal === 0 ? 'check' : 'exclamation-triangle', 
            cls: diffVal === 0 ? 'text-green-400' : 'text-yellow-400' 
        };

        createCard('rsd-grid', wh, match.toFixed(1), '% Match', diffObj, getTrend(wh, 'SAP'), 'green', getLast3Months(wh, 'SAP')); 
    }); 
}
    function renderPending(c, p) { selectedWarehouses.forEach(wh => { createCard('pod-pending-grid', wh, getMetric(c, wh, 'POD pending'), 'POD pending', calcDiff(getMetric(c, wh, 'POD pending'), getMetric(p, wh, 'POD pending')), getTrend(wh, 'POD pending'), 'red', getLast3Months(wh, 'POD pending')); createCard('return-pending-grid', wh, getMetric(c, wh, 'Return pending'), 'Return pending', calcDiff(getMetric(c, wh, 'Return pending'), getMetric(p, wh, 'Return pending')), getTrend(wh, 'Return pending'), 'red', getLast3Months(wh, 'Return pending')); }); }
    function updateAllCharts() {
        Object.keys(chartInstances).forEach(k => { if (chartInstances[k]) chartInstances[k].destroy(); delete chartInstances[k]; });
        const chartsToRender = ['chart-orders-trend', 'chart-orders-dist', 'chart-quality-comp', 'chart-inbound-vol', 'chart-inbound-trucks', 'chart-outbound-vol', 'chart-outbound-trucks', 'chart-outbound-trips-comp', 'chart-outbound-dest-comp'];
        chartsToRender.forEach(id => renderSpecificChart(id, id));
    }
    function renderSpecificChart(type, targetId) {
        const ctx = document.getElementById(targetId); if (!ctx) return;
        let config = null;
        if (type === 'chart-inbound-vol') config = getBarConfig('Inbound Pallets');
        else if (type === 'chart-inbound-trucks') config = getBarConfig('Inbound Trucks 45 ft');
        else if (type === 'chart-outbound-vol') config = getBarConfig('Outbound Pallets');
        else if (type === 'chart-outbound-trucks') config = getBarConfig('Outbound Trucks 45 ft');
        else if (type === 'chart-orders-trend') config = getLineConfig('Orders/Month');
        else if (type === 'chart-orders-dist') config = getDoughnutConfig('Orders/Month');
        else if (type === 'chart-quality-comp') config = getGroupedBarConfig(['Order Accuracy', 'Order Fill Rate']);
        else if (type === 'chart-outbound-trips-comp') { 
    config = { 
        type: 'line', 
        data: { 
            labels: monthList, 
            datasets: [ 
                { 
                    label: 'PROCEED Trips', 
                    
                    data: monthList.map(m => getMetric(m, 'PROCEED', 'TOTAL TRIPS')), 
                    borderColor: CHART_COLORS['PROCEED'] || '#10b981', 
                    backgroundColor: (CHART_COLORS['PROCEED'] || '#10b981') + '30', 
                    fill: false 
                }, 
                { 
                    label: 'DSV Trips', 
                    
                    data: monthList.map(m => getMetric(m, 'DSV', 'TOTAL TRIPS')), 
                    borderColor: CHART_COLORS['DSV'] || '#3b82f6', 
                    backgroundColor: (CHART_COLORS['DSV'] || '#3b82f6') + '30', 
                    fill: false 
                } 
            ] 
        }, 
        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: '' } } } 
    }; 
}
else if (type === 'chart-outbound-dest-comp') { 
    config = { 
        type: 'line', 
        data: { 
            labels: monthList, 
            datasets: [ 
                { 
                    label: 'PROCEED Destinations', 
                    
                    data: monthList.map(m => getMetric(m, 'PROCEED', 'TOTAL DESTINATIONS')), 
                    borderColor: CHART_COLORS['PROCEED'] || '#10b981', 
                    backgroundColor: (CHART_COLORS['PROCEED'] || '#10b981') + '30', 
                    fill: false 
                }, 
                { 
                    label: 'DSV Destinations', 
                    
                    data: monthList.map(m => getMetric(m, 'DSV', 'TOTAL DESTINATIONS')), 
                    borderColor: CHART_COLORS['DSV'] || '#3b82f6', 
                    backgroundColor: (CHART_COLORS['DSV'] || '#3b82f6') + '30', 
                    fill: false 
                } 
            ] 
        }, 
        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: '' } } } 
    }; 
}
		else if (type === 'chart-outbound-dest-comp') { config = { type: 'line', data: { labels: monthList, datasets: [{ label: 'PROCEED Destinations', data: monthList.map(m => getMetric(m, 'PROCEED', 'PROCEED_TOTAL_DESTINATIONS')), borderColor: CHART_COLORS['PROCEED'] || '#10b981', backgroundColor: (CHART_COLORS['PROCEED'] || '#10b981') + '30', fill: false }, { label: 'DSV Destinations', data: monthList.map(m => getMetric(m, 'DSV', 'DSV_TOTAL_DESTINATIONS')), borderColor: CHART_COLORS['DSV'] || '#3b82f6', backgroundColor: (CHART_COLORS['DSV'] || '#3b82f6') + '30', fill: false }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: '' } } } }; }
        if (config) chartInstances[targetId] = new Chart(ctx, config);
    }
    function toNumOrNull(v) {
  const n = parseNum(v);
  return (n === 'N/A' || n === null || n === undefined || !isFinite(n)) ? null : n;
}

function toNumOrZero(v) {
  const n = parseNum(v);
  return (n === 'N/A' || n === null || n === undefined || !isFinite(n)) ? 0 : n;
}

function getBarConfig(col) {
  return {
    type: 'bar',
    data: {
      labels: monthList,
      datasets: selectedWarehouses.map(wh => ({
        label: wh,
        data: monthList.map(m => toNumOrZero(getMetric(m, wh, col))),
        backgroundColor: CHART_COLORS[wh]
      }))
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { x: { stacked: true }, y: { stacked: true } },
      plugins: { title: { display: true, text: col } }
    }
  };
}

function getLineConfig(col) {
  return {
    type: 'line',
    data: {
      labels: monthList,
      datasets: selectedWarehouses.map(wh => ({
        label: wh,
        data: monthList.map(m => toNumOrNull(getMetric(m, wh, col))),
        borderColor: CHART_COLORS[wh],
        spanGaps: true
      }))
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { title: { display: true, text: col } }
    }
  };
}

function getDoughnutConfig(col) {
  const cur = document.getElementById('monthSelect').value;
  const labels = selectedWarehouses;
  const totals = labels.map(w => toNumOrZero(getMetric(cur, w, col)));
  const bgColors = labels.map(w => CHART_COLORS[w]);

  return {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{ data: totals, backgroundColor: bgColors }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'right',
          labels: {
            color: '#e2e8f0',
            generateLabels: function (chart) {
              const data = chart.data.datasets[0].data || [];
              return chart.data.labels.map((label, i) => {
                const value = typeof data[i] === 'number' && isFinite(data[i]) ? data[i] : 0;
                const c = chart.data.datasets[0].backgroundColor[i];
                return {
                  text: `${label}: ${value.toLocaleString('en-US')}`,
                  fillStyle: c,
                  strokeStyle: c,
                  index: i,
                  fontColor: '#94a3b8',
                  color: '#94a3b8'
                };
              });
            }
          }
        },
        title: { display: false }
      }
    }
  };
}

function getGroupedBarConfig(cols) {
  const cur = document.getElementById('monthSelect').value;
  const datasets = cols.map((col, idx) => ({
    label: col,
    data: selectedWarehouses.map(w => toNumOrZero(getMetric(cur, w, col, true))),
    backgroundColor: idx === 0 ? '#60a5fa' : '#34d399'
  }));

  return {
    type: 'bar',
    data: { labels: selectedWarehouses, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { title: { display: true, text: cols.join(' vs ') } }
    }
  };
}

    async function addNewEmployee() { const { value: name } = await Swal.fire({ title: 'New Staff', input: 'text', background: '#1e293b', color: '#fff' }); if (name) { employees.push({ name: escapeHTML(name), id: Date.now() }); renderEmpTable(); saveGithub('employees.json', employees); } }
    function renderEmpTable() { const rows = employees.map((e, i) => { return `<tr class="border-b border-white/5 hover:bg-white/5"><td class="p-4 text-white font-medium">${escapeHTML(e.name)}</td><td class="p-4 text-center"><button onclick="confirmDelEmployee(${i})" class="text-red-400 hover:text-red-300 admin-only"><i class="fas fa-trash"></i></button></td></tr>`; }).join(''); const body = document.getElementById('emp-table-body'); if (body) body.innerHTML = rows; }
    async function confirmDelEmployee(index) { const res = await Swal.fire({ title: 'Delete employee?', text: 'This action cannot be undone.', icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes, delete', cancelButtonText: 'Cancel', background: '#1e293b', color: '#fff' }); if (res.isConfirmed) { employees.splice(index, 1); await saveGithub('employees.json', employees); renderEmpTable(); Swal.fire({ toast: true, icon: 'success', title: 'Deleted', timer: 1500, position: 'top-end', showConfirmButton: false }); } }

    function renderCSVEditor() { if (!rawCSVData || !rawCSVData.length) return; const headers = Object.keys(rawCSVData[0]); let html = `<thead><tr>` + headers.map(h => `<th class="p-3 bg-dark-800 text-slate-400 sticky top-0 border-b border-dark-600 font-bold whitespace-nowrap">${escapeHTML(h)}</th>`).join('') + `<th class="p-3 bg-dark-800 text-slate-400 sticky top-0 border-b border-dark-600 font-bold whitespace-nowrap">Actions</th></tr></thead><tbody>`; rawCSVData.forEach((row, i) => { html += `<tr class="hover:bg-dark-800/50 transition-colors">`; headers.forEach(key => { html += `<td class="border-b border-dark-700 p-0"><input type="text" class="w-full bg-transparent p-2 outline-none num-font text-xs text-slate-300 focus:text-white focus:bg-brand-600/10" value="${escapeHTML(row[key])}" onchange="updateCSVCell(${i}, '${key}', this.value)"></td>`; }); html += `<td class="border-b border-dark-700 p-0 text-center"><button onclick="deleteCSVRow(${i})" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button></td></tr>`; }); html += '</tbody>'; const tableEl = document.getElementById('csv-editor-table'); if (tableEl) tableEl.innerHTML = html; }
    function updateCSVCell(idx, key, val) { rawCSVData[idx][key] = val; }

        async function saveCSV() { try { if (!rawCSVData || rawCSVData.length === 0) await saveGithub('WHSdata.json', []); else await saveGithub('WHSdata.json', rawCSVData); const updElem = document.getElementById('lastUpdateTxt'); if (updElem) updElem.innerText = 'Auditing...'; await backgroundRefresh(); Swal.fire({ toast: true, icon: 'success', title: 'Data Saved', timer: 1500, position: 'top-end', showConfirmButton: false }); } catch (err) { Swal.fire('Error', 'Failed to save data.', 'error'); } }
        async function savePalletsJSON() { await saveGithub('pallets.json', pallets); }
        async function savePalletsClosedJSON() { await saveGithub('pallets_closed.json', palletsClosed); }
        
        async function importDatasetCSV(input) { const file = input.files && input.files[0]; if (!file) return; Papa.parse(file, { header: true, skipEmptyLines: true, complete: async function(results) { try { const rows = results.data; let added = 0; rows.forEach(row => { const obj = {}; Object.keys(row).forEach(k => { const key = k.trim(); obj[key] = row[k]; }); normalizeWHSData([obj]); rawData.push(obj); added++; }); rawCSVData = rawData.map(r => ({ ...r })); await saveGithub('WHSdata.json', rawData); await backgroundRefresh(); Swal.fire({ toast:true, icon:'success', title:`Imported ${added} records from CSV`, timer:2000, position:'top-end', showConfirmButton:false }); } catch (err) { Swal.fire('Error','Failed to import CSV data','error'); } input.value = ''; } }); }
        function renderCSVForm() {
    const tabsContainer = document.getElementById('csv-form-tabs'); 
    const contentsContainer = document.getElementById('csv-form-contents'); 
    if (!tabsContainer || !contentsContainer) return;

    
    const categories = {
        'General': ['Report_Month', 'Warehouse_Name', 'Orders/Month', 'Returns'],
        'Storage': ['Capacity', 'Utalized'],
        'Quality': ['On-Time Delivery', 'Order Fill Rate', 'Order Accuracy', 'Correct Documentation', 'Customer Claims', 'Shipping utilization'],
        'Inbound': ['inbound Case', 'Inbound Pallets', 'Inbound Trucks 45 ft'],
        
        
        'Outbound': [
            'Outbound Case', 'Outbound Pallets', 
            'Outbound Trucks 45 ft', 'Outbound_20_TON', 'Outbound_10_TON', 'Outbound_5_TON', 
            'TOTAL TRIPS', 'TOTAL DESTINATIONS'
        ], 
        
        'Reconciliation': ['SAP', 'RSD'],
        'Pending': ['POD pending', 'Return pending']
    };

    tabsContainer.innerHTML = '';
    contentsContainer.innerHTML = '';

    Object.keys(categories).forEach((cat, idx) => {
        
        const btn = document.createElement('button');
        btn.textContent = cat;
        btn.className = 'bg-dark-800 text-slate-400 px-3 py-1 rounded text-xs font-bold transition-colors hover:bg-dark-700';
        if (idx === 0) btn.classList.add('csv-tab-active', 'bg-brand-600', 'text-white');
        
        btn.onclick = () => {
            document.querySelectorAll('#csv-form-tabs button').forEach(b => b.className = 'bg-dark-800 text-slate-400 px-3 py-1 rounded text-xs font-bold transition-colors hover:bg-dark-700');
            btn.className = 'bg-brand-600 text-white px-3 py-1 rounded text-xs font-bold shadow-lg';
            document.querySelectorAll('.csv-section').forEach(s => s.style.display = 'none');
            document.getElementById(`csv-section-${cat.replace(/\s/g,'')}`).style.display = 'grid';
        };
        tabsContainer.appendChild(btn);

        
        const section = document.createElement('div');
        section.id = `csv-section-${cat.replace(/\s/g,'')}`;
        section.className = 'csv-section grid grid-cols-1 md:grid-cols-2 gap-4 animate-fade-in';
        section.style.display = idx === 0 ? 'grid' : 'none';

        categories[cat].forEach(col => {
            const wrapper = document.createElement('div');
            const label = document.createElement('label');
            label.className = 'text-[10px] text-slate-500 uppercase block mb-1 font-bold';
            label.textContent = col.replace(/_/g, ' ');
            
            let input;
            if (col === 'Report_Month') {
                input = document.createElement('input'); input.type = 'month';
            } else if (col === 'Warehouse_Name') {
                input = document.createElement('select');
                WH_ORDER.forEach(w => { const opt = document.createElement('option'); opt.value = w; opt.textContent = w; input.appendChild(opt); });
            } else {
                input = document.createElement('input'); input.type = 'number'; input.step = "0.01";
            }
            
            
            input.id = `csv-form-${col}`;
            input.className = 'w-full bg-dark-800 border border-dark-600 rounded p-2 text-white text-sm focus:border-brand-500 outline-none';
            
            wrapper.appendChild(label); wrapper.appendChild(input);
            section.appendChild(wrapper);
        });
        contentsContainer.appendChild(section);
    });
}
        function toggleTotFields() {
            const whSelect = document.getElementById('csv-form-Warehouse_Name'); if (!whSelect) return; const wh = whSelect.value;
            const pTrip = document.getElementById('csv-form-PROCEED_TOTAL_TRIPS'); const pDest = document.getElementById('csv-form-PROCEED_TOTAL_DESTINATIONS'); const dTrip = document.getElementById('csv-form-DSV_TOTAL_TRIPS'); const dDest = document.getElementById('csv-form-DSV_TOTAL_DESTINATIONS');
            const pTripWrap = pTrip ? pTrip.parentElement : null; const pDestWrap = pDest ? pDest.parentElement : null; const dTripWrap = dTrip ? dTrip.parentElement : null; const dDestWrap = dDest ? dDest.parentElement : null;
            if (wh === 'SPIMACO') { if (pTripWrap) pTripWrap.style.display = 'none'; if (pDestWrap) pDestWrap.style.display = 'none'; if (dTripWrap) dTripWrap.style.display = 'none'; if (dDestWrap) dDestWrap.style.display = 'none'; } else if (wh === 'PROCEED') { if (pTripWrap) pTripWrap.style.display = ''; if (pDestWrap) pDestWrap.style.display = ''; if (dTripWrap) dTripWrap.style.display = 'none'; if (dDestWrap) dDestWrap.style.display = 'none'; } else if (wh === 'DSV') { if (dTripWrap) dTripWrap.style.display = ''; if (dDestWrap) dDestWrap.style.display = ''; if (pTripWrap) pTripWrap.style.display = 'none'; if (pDestWrap) pDestWrap.style.display = 'none'; } else { if (pTripWrap) pTripWrap.style.display = 'none'; if (pDestWrap) pDestWrap.style.display = 'none'; if (dTripWrap) dTripWrap.style.display = 'none'; if (dDestWrap) dDestWrap.style.display = 'none'; }
            updateSectionVisibility();
        }

        function updateSectionVisibility() {
            const showExtra = !(selectedWarehouses.length === 1 && selectedWarehouses[0] !== 'SPIMACO');
            const ids = ['shift-log-display', 'pallets-summary', 'monthly-schedule', 'vacations-section'];
            ids.forEach(id => { const el = document.getElementById(id); if (el) { const isAllowedByRole = permissions[currentUser.role]?.cards?.[id] !== false; if (showExtra && isAllowedByRole) el.classList.remove('hidden'); else el.classList.add('hidden'); } });
        }

        function selectCSVFormTab(cat) {
            const tabs = document.querySelectorAll('#csv-form-tabs button'); tabs.forEach(btn => { if (btn.textContent === cat) btn.classList.add('csv-tab-active'); else btn.classList.remove('csv-tab-active'); });
            const sections = document.querySelectorAll('#csv-form-contents > div'); sections.forEach(sec => { if (sec.id === `csv-form-section-${cat}`) sec.style.display = 'grid'; else sec.style.display = 'none'; });
        }

        function formatMonthInput(val) { if (!val) return ''; const [y, m] = val.split('-'); const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; return `${y.slice(2)}-${months[parseInt(m,10)-1]}`; }
        async function addCSVRow() {
            if (!rawCSVData || rawCSVData.length === 0) return; const newRow = {}; Object.keys(rawCSVData[0]).forEach(col => { const input = document.getElementById(`csv-form-${col}`); if (!input) return; let val = input.value; if (col === 'Report_Month') val = formatMonthInput(val); newRow[col] = val; });
            if (rawCSVData.length === 1 && Object.values(rawCSVData[0]).every(v => v === '')) rawCSVData[0] = newRow; else rawCSVData.push(newRow);
            await saveCSV(); renderCSVEditor(); Object.keys(rawCSVData[0]).forEach(col => { const input = document.getElementById(`csv-form-${col}`); if (input) input.value = ''; }); Swal.fire({ toast:true, icon:'success', title:'Row Added', timer:1500, position:'top-end', showConfirmButton:false });
        }
        async function deleteCSVRow(idx) {
            const res = await Swal.fire({ title: 'Are you sure?', text: 'This will remove the row permanently.', icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes, delete it', cancelButtonText: 'No, keep it', background: '#1e293b', color: '#fff' });
            if (res.isConfirmed) { rawCSVData.splice(idx, 1); await saveCSV(); renderCSVEditor(); Swal.fire({ toast:true, icon:'success', title:'Row deleted', timer:1500, position:'top-end', showConfirmButton:false }); }
        }

        function renderWarehouseFilters() {
            const container = document.getElementById('warehouse-filter'); if (!container) return; container.innerHTML = '';
            WH_ORDER.forEach(wh => { const label = document.createElement('label'); label.className = 'flex items-center gap-1'; const chk = document.createElement('input'); chk.type = 'checkbox'; chk.checked = selectedWarehouses.includes(wh); chk.onchange = () => toggleWarehouseFilter(wh); const span = document.createElement('span'); span.textContent = wh; span.className = 'text-xs'; label.appendChild(chk); label.appendChild(span); container.appendChild(label); });
        }
        function toggleWarehouseFilter(wh) { if (selectedWarehouses.includes(wh)) selectedWarehouses = selectedWarehouses.filter(w => w !== wh); else selectedWarehouses.push(wh); if (selectedWarehouses.length === 0) selectedWarehouses = [...WH_ORDER]; render(); }

async function submitDamageReport() {
            const product = document.getElementById('damage-product').value.trim();
            const batch = document.getElementById('damage-batch').value.trim();
            const qty = parseInt(document.getElementById('damage-qty').value);
            const notes = document.getElementById('damage-notes').value.trim();
            const imgInput = document.getElementById('damage-image');

            if (!product || !batch || !qty) {
                Swal.fire('Missing Data', 'Please enter product, batch and quantity.', 'warning');
                return;
            }

            let imageData = null;
            
            if (imgInput && imgInput.files && imgInput.files[0]) {
                const file = imgInput.files[0];
                try {
                    Swal.fire({
                        title: 'Processing Image...',
                        text: 'Compressing photo...',
                        allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading(); }
                    });
                    imageData = await compressImage(file, 600, 0.3);
                    Swal.close();
                } catch (error) {
                    console.error(error);
                    Swal.fire('Error', 'Failed to process image', 'error');
                    return;
                }
            }

            const report = { date: new Date().toISOString(), product, batch, qty, notes, image: imageData, reporter: currentUser.username };
            damageReports.push(report); 
            await saveGithub('damage_reports.json', damageReports); 
            renderManagerReports();
            
            document.getElementById('damage-product').value = ''; 
            document.getElementById('damage-batch').value = ''; 
            document.getElementById('damage-qty').value = ''; 
            document.getElementById('damage-notes').value = ''; 
            if (imgInput) imgInput.value = '';
            
            Swal.fire({ toast:true, icon:'success', title:'Report Submitted', timer:1500, position:'top-end', showConfirmButton:false });
        }

   async function renderManagerReports() {
            const body = document.getElementById('incident-table-body'); 
            if (!body) return;
            
            if (!damageReports || damageReports.length === 0) { 
                try { 
                    const dr = await fetchGithub('damage_reports.json'); 
                    if (Array.isArray(dr)) damageReports = dr; 
                } catch(e) {} 
            }
            
            body.innerHTML = '';
            
            damageReports.forEach((r, i) => { 
                const date = new Date(r.date); 
                const dateStr = date.toLocaleDateString('en-GB'); 
                const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }); 
                

                const hasImage = r.image && r.image.startsWith('data:image');
                const imgPreview = hasImage 
                    ? `<img src="${r.image}" alt="img" class="h-10 w-10 object-cover rounded border border-dark-600 cursor-pointer" onclick="openIncidentDetailsModal(${i})"/>` 
                    : '<i class="fas fa-image text-slate-500 text-lg opacity-20"></i>'; 
                
                body.insertAdjacentHTML('beforeend', `
                    <tr class="border-b border-dark-700 hover:bg-dark-800/50 transition-colors">
                        <td class="p-3 text-slate-300 font-mono text-xs">${dateStr}<br><span class="text-slate-500">${timeStr}</span></td>
                        <td class="p-3 font-bold text-white">${escapeHTML(r.product)}</td>
                        <td class="p-3 text-slate-400 font-mono text-xs">${escapeHTML(r.batch)}</td>
                        <td class="p-3 text-right font-bold text-brand-400">${escapeHTML(r.qty)}</td>
                        <td class="p-3 text-center">${imgPreview}</td>
                        <td class="p-3 text-center">
                            <button onclick="openIncidentDetailsModal(${i})" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded text-xs font-bold shadow-lg hover:shadow-indigo-500/20 transition-all">
                                <i class="fas fa-eye mr-1"></i> Details
                            </button>
                        </td>
                    </tr>
                `); 
            });
        }
        
 function openIncidentDetailsModal(idx) {
            const report = damageReports[idx]; 
            if (!report) return; 
            
            const modal = document.getElementById('incidentDetailModal'); 
            const content = document.getElementById('incidentDetailModalContent'); 
            const date = new Date(report.date);
            
            
            const getImageSizeInKB = (base64String) => {
                if (!base64String) return 0;
                const stringLength = base64String.length - 'data:image/jpeg;base64,'.length; 
                const sizeInBytes = 4 * Math.ceil((stringLength) / 3) * 0.5624896334383812;
                return (sizeInBytes / 1024).toFixed(1);
            };

            let imgSizeInfo = '';
            let safeImg = null;

            if (report.image && report.image.startsWith('data:image')) {
                safeImg = report.image;
                const sizeKB = getImageSizeInKB(safeImg);
                imgSizeInfo = `<span class="ml-2 text-[10px] bg-dark-900 border border-dark-600 text-slate-400 px-2 py-0.5 rounded-full font-mono">${sizeKB} KB</span>`;
            }

            let html = `
            <div class="space-y-4">
                <div class="flex justify-between items-start border-b border-dark-700 pb-3">
                    <div>
                        <p class="text-[10px] text-slate-500 uppercase tracking-widest">Product</p>
                        <p class="text-lg font-bold text-white">${escapeHTML(report.product)}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-slate-500 uppercase tracking-widest">Reported By</p>
                        <div class="flex items-center justify-end gap-2">
                            <div class="w-5 h-5 rounded-full bg-brand-600 flex items-center justify-center text-[10px] font-bold text-white">${(report.reporter || 'U').charAt(0).toUpperCase()}</div>
                            <span class="font-bold text-slate-300 text-sm">${escapeHTML(report.reporter || 'N/A')}</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 bg-dark-800/50 p-3 rounded-xl border border-dark-700">
                    <div>
                        <p class="text-[10px] text-slate-500 uppercase">Date</p>
                        <p class="text-sm font-mono text-white">${date.toLocaleDateString('en-GB')}</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-500 uppercase">Batch</p>
                        <p class="text-sm font-mono text-white">${escapeHTML(report.batch)}</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-500 uppercase">Quantity</p>
                        <p class="text-sm font-bold text-red-400">${escapeHTML(report.qty)}</p>
                    </div>
                </div>

                <div>
                    <p class="text-sm font-bold text-white mb-2 flex items-center gap-2"><i class="fas fa-sticky-note text-slate-500"></i> Notes</p>
                    <div class="bg-dark-800 p-3 rounded-lg text-slate-300 text-sm whitespace-pre-wrap border border-dark-700 min-h-[60px]">${escapeHTML(report.notes || 'No notes provided.')}</div>
                </div>
            `;
         
            if (safeImg) { 
                html += `
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm font-bold text-white flex items-center gap-2"><i class="fas fa-camera text-slate-500"></i> Attached Photo ${imgSizeInfo}</p>
                        <a href="${safeImg}" download="damage_report_${date.getTime()}.jpg" class="text-[10px] text-blue-400 hover:text-blue-300 underline">Download Original</a>
                    </div>
                    <div class="flex justify-center bg-dark-900 rounded-lg border border-dark-700 p-2">
                        <img src="${safeImg}" alt="Damage Image" class="max-w-full max-h-[300px] object-contain rounded">
                    </div>
                </div>`; 
            } else {
                html += `
                <div class="p-4 border border-dashed border-dark-600 rounded-lg text-center">
                    <p class="text-slate-500 text-xs italic">No image attached to this report.</p>
                </div>`;
            }

            html += `</div>`;
            
            content.innerHTML = html; 
            modal.classList.remove('hidden'); 
            modal.style.display = 'flex';
        }

function renderPalletsTable() {
    const body = document.getElementById('pallets-table-body'); if (!body) return; body.innerHTML = '';
    const searchVal = document.getElementById('pallets-search-open') ? document.getElementById('pallets-search-open').value.toLowerCase() : '';
    pallets.forEach((p, i) => { 
        if (searchVal && !p.po.toLowerCase().includes(searchVal)) return; 
        body.insertAdjacentHTML('beforeend', `<tr class="border-b border-dark-700 hover:bg-dark-800/50"><td class="p-3">${escapeHTML(p.po)}</td><td class="p-3 capitalize">${escapeHTML(p.type)}</td><td class="p-3 text-right">${p.qty}</td><td class="p-3 text-center"><button onclick="usePO(${i})" class="bg-red-600 hover:bg-red-500 text-white px-2 py-1 rounded text-xs font-bold">Use</button></td></tr>`); 
    });
}

        function renderPalletsHistoryTable() {
            const body = document.getElementById('pallets-history-body'); if (!body) return; body.innerHTML = '';
            const searchVal = document.getElementById('pallets-search-history') ? document.getElementById('pallets-search-history').value.toLowerCase() : '';
            palletsClosed.forEach(po => { if (searchVal && !po.po.toLowerCase().includes(searchVal)) return; const totalUsed = Array.isArray(po.history) ? po.history.reduce((sum, h) => sum + h.used, 0) : 0; body.insertAdjacentHTML('beforeend', `<tr class="border-b border-dark-700 hover:bg-dark-800/50"><td class="p-3">${escapeHTML(po.po)}</td><td class="p-3 capitalize">${escapeHTML(po.type)}</td><td class="p-3">${totalUsed}</td><td class="p-3 text-center"><button onclick="openPOHistoryModal('${po.po}')" class="bg-brand-600 hover:bg-brand-500 text-white px-2 py-1 rounded text-xs font-bold">View</button></td></tr>`); });
        }

        function openPOHistoryModal(poNumber) {
            const po = palletsClosed.find(p => p.po === poNumber); if (!po) return;
            const modal = document.getElementById('poHistoryModal'); const title = document.getElementById('poHistoryModalTitle'); const content = document.getElementById('poHistoryModalContent');
            title.textContent = `PO: ${po.po} (${po.type.toUpperCase()})`;
            let historyHtml = '<div class="space-y-4">'; if (Array.isArray(po.history) && po.history.length > 0) { historyHtml += `<h4 class="text-lg font-bold text-white">Transaction Log</h4>`; po.history.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(h => { const date = new Date(h.date); historyHtml += `<div class="bg-dark-800 p-4 rounded-lg border border-dark-700"><p class="text-xs text-slate-400">Date/Time: <span class="font-mono text-white">${date.toLocaleString('en-GB')}</span></p><p class="text-sm font-bold text-red-400">Used: <span class="font-mono text-red-200">${h.used}</span></p><p class="text-xs text-slate-400">Remaining: <span class="font-mono text-white">${h.remaining}</span></p><p class="text-xs text-slate-400">Action By: <span class="font-bold text-white">${h.user || 'N/A'}</span></p></div>`; }); } else { historyHtml += `<p class="text-slate-400 italic">No history recorded for this PO.</p>`; } historyHtml += '</div>';
            content.innerHTML = historyHtml; modal.classList.remove('hidden'); modal.style.display = 'flex';
        }

        async function addPO() {
            const po = document.getElementById('po-number').value.trim(); const type = document.getElementById('po-type').value; const qty = parseInt(document.getElementById('po-qty').value);
            if (!po || !qty || qty <= 0) { Swal.fire('Missing Data', 'Please enter PO number and positive quantity.', 'warning'); return; }
            pallets.push({ po, type, qty, history: [] }); await savePalletsJSON(); renderPalletsTable(); renderPalletsOverview();
            document.getElementById('po-number').value = ''; document.getElementById('po-qty').value = '';
            Swal.fire({ toast:true, icon:'success', title:'PO Added', timer:1500, position:'top-end', showConfirmButton:false });
        }

        async function usePO(index) {
            const po = pallets[index]; if (!po) return;
            const { value: qtyStr } = await Swal.fire({ title: `Use pallets from PO ${po.po}`, input: 'number', inputLabel: 'Quantity to use', inputAttributes: { min: 1, max: po.qty, step: 1 }, showCancelButton: true, confirmButtonText: 'Confirm', background: '#1e293b', color: '#fff' });
            if (!qtyStr) return; const qty = parseInt(qtyStr); if (qty <= 0 || qty > po.qty) { Swal.fire('Invalid', 'Quantity not valid.', 'warning'); return; }
            po.qty -= qty; if (!Array.isArray(po.history)) po.history = []; po.history.push({ date: new Date().toISOString(), user: currentUser.username || '', used: qty, remaining: po.qty });
            if (po.qty === 0) { palletsClosed.push({ po: po.po, type: po.type, qty: 0, history: po.history }); pallets.splice(index, 1); await savePalletsJSON(); await savePalletsClosedJSON(); } else { await savePalletsJSON(); }
            renderPalletsTable(); renderPalletsHistoryTable(); renderPalletsOverview();
            Swal.fire({ toast:true, icon:'success', title:'Pallets deducted', timer:1500, position:'top-end', showConfirmButton:false });
        }

        function renderPalletsOverview() {
            let euroTotal = 0; let usedTotal = 0; pallets.forEach(p => { if (p.type === 'euro') euroTotal += p.qty; else usedTotal += p.qty; });
            const euroEl = document.getElementById('pallets-euro-count'); const usedEl = document.getElementById('pallets-used-count');
            if (euroEl) euroEl.textContent = euroTotal; if (usedEl) usedEl.textContent = usedTotal;
        }

        

        async function addVacation() {
            const empName = document.getElementById('vacationEmpSelect').value;
            const start = document.getElementById('vacationStart').value;
            const end = document.getElementById('vacationEnd').value;
            const type = document.getElementById('vacationType').value;

            if(!empName || !start || !end) return Swal.fire('Error', 'Please fill all fields', 'warning');
            if(new Date(start) > new Date(end)) return Swal.fire('Error', 'Start date cannot be after end date', 'warning');

            
            if(!Array.isArray(vacations)) vacations = [];
            
            vacations.push({
                id: Date.now(),
                name: empName,
                start,
                end,
                type
            });

            await saveGithub('vacations.json', vacations);
            
            
            renderVacationsManager();
            renderVacationsDashboard();
            initPlannerMatrix(); 
            
            
            document.getElementById('vacationStart').value = '';
            document.getElementById('vacationEnd').value = '';
            Swal.fire({ toast: true, icon: 'success', title: 'Vacation Scheduled', timer: 1500, position: 'top-end', showConfirmButton: false });
        }

        function renderVacationsManager() {
        const tbody = document.getElementById('vacations-table-body');
        if(!tbody) return;
        
        if(!Array.isArray(vacations)) vacations = [];

        
        const sorted = [...vacations].sort((a,b) => new Date(a.start) - new Date(b.start));
        
        tbody.innerHTML = sorted.map(v => {
            const s = new Date(v.start);
            const e = new Date(v.end);
            const diffTime = Math.abs(e - s);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 

            const sStr = !isNaN(s) ? s.toLocaleDateString('en-GB') : 'Invalid Date';
            const eStr = !isNaN(e) ? e.toLocaleDateString('en-GB') : 'Invalid Date';

            
            return `<tr class="border-b border-dark-700 hover:bg-dark-800/50">
                <td class="p-3 font-bold text-white">${escapeHTML(v.name)}</td>
                <td class="p-3">${sStr}</td>
                <td class="p-3">${eStr}</td>
                <td class="p-3"><span class="bg-purple-900/50 text-purple-300 px-2 py-1 rounded text-xs">${escapeHTML(v.type)}</span></td>
                <td class="p-3 font-mono">${diffDays} days</td>
                <td class="p-3 text-center">
                    <button onclick="deleteVacation(${v.id})" class="text-red-400 hover:text-red-300 admin-only"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        }).join('');
        
        applyRoleUI(currentUser.role);
    }

        async function deleteVacation(id) {
            const res = await Swal.fire({ title: 'Cancel Vacation?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes', background: '#1e293b', color: '#fff' });
            if(res.isConfirmed) {
                vacations = vacations.filter(v => v.id !== id);
                await saveGithub('vacations.json', vacations);
                renderVacationsManager();
                renderVacationsDashboard();
                initPlannerMatrix();
                Swal.fire({ toast: true, icon: 'success', title: 'Deleted', timer: 1000, position: 'top-end', showConfirmButton: false });
            }
        }

function renderVacationsDashboard() {
        const container = document.getElementById('dashboard-vacations-list');
        if(!container) return;
        
        const section = document.getElementById('vacations-section');
        if (permissions[currentUser.role]?.cards?.['vacations-section'] === false) {
             if(section) section.classList.add('hidden');
             return;
        } else {
             if(section) section.classList.remove('hidden');
        }

        
        const today = new Date();
        today.setHours(0,0,0,0);

        if(!Array.isArray(vacations)) vacations = [];

        
        const upcoming = vacations.filter(v => {
            const end = new Date(v.end);
            end.setHours(23, 59, 59, 999); 
            return !isNaN(end) && end >= today;
        }).sort((a,b) => new Date(a.start) - new Date(b.start)).slice(0, 4);

        if(upcoming.length === 0) {
            container.innerHTML = '<div class="col-span-full text-center text-slate-500 italic py-4">No upcoming vacations scheduled.</div>';
            return;
        }

        container.innerHTML = upcoming.map(v => {
            const s = new Date(v.start);
            s.setHours(0,0,0,0); 
            
            const e = new Date(v.end);
            e.setHours(23,59,59,999); 

            if (isNaN(s) || isNaN(e)) return '';

            
            const isOngoing = today >= s && today <= e;
            
            const statusColor = isOngoing ? 'text-green-400' : 'text-purple-400';
            
            let statusText = '';
            if(isOngoing) {
                statusText = 'On Vacation';
            } else {
                
                const diffTime = s - today;
                const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if(daysUntil <= 0) statusText = 'Starting Today'; 
                else statusText = `Starts in ${daysUntil} days`;
            }

            return `
            <div class="glass-card p-4 rounded-xl border-t-4 border-purple-500 flex flex-col justify-between">
                <div>
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-white">${escapeHTML(v.name)}</h4>
                        <span class="text-[10px] bg-dark-800 text-slate-400 px-2 py-0.5 rounded">${escapeHTML(v.type)}</span>
                    </div>
                    <div class="text-xs text-slate-300 space-y-1">
                        <p><i class="far fa-calendar-alt w-4 text-slate-500"></i> ${s.toLocaleDateString('en-GB')} - ${e.toLocaleDateString('en-GB')}</p>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-white/5 flex justify-between items-center">
                    <span class="text-xs font-bold ${statusColor}">${statusText}</span>
                </div>
            </div>`;
        }).join('');
    }

        let presentationActive = false; let presentationIndex = 0; let presentationInterval = null; let presentationOrder = []; let presentationOverlay = null;
        // Use "let" instead of "const" so the variable is hoisted and avoids temporal dead zone errors.
        let presentationRestore = new Map();

        function getPresentationSections() {
            
            const defaultSlides = ['overview','storage','quality','inbound','outbound-cards-slide','outbound-charts-slide','finance','pending'];
            let sectionIds = [];
            try {
                const slideConfig = (typeof permissions !== 'undefined' && permissions && currentUser && currentUser.role && permissions[currentUser.role] && permissions[currentUser.role].slides) ? permissions[currentUser.role].slides : null;
                defaultSlides.forEach(id => {
                    if (id === 'outbound-cards-slide' || id === 'outbound-charts-slide') {
                        if (!slideConfig || slideConfig['outbound'] !== false) sectionIds.push(id);
                    } else {
                        if (!slideConfig || slideConfig[id] !== false) sectionIds.push(id);
                    }
                });
            } catch (e) { sectionIds = defaultSlides.slice(); }
            return sectionIds.filter(id => document.getElementById(id));
        }

        function setupPresentationOverlay() {
            presentationOverlay = document.createElement('div'); presentationOverlay.id = 'presentation-overlay'; presentationOverlay.style.cssText = `position:fixed; inset:0; z-index:99999; background:#020617; padding:16px 20px; overflow:hidden;`;
            presentationOverlay.innerHTML = `<div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;"><div id="pres-title" style="color:white; font-weight:700; font-size:14px; opacity:.9;">Presentation</div><div style="display:flex; gap:8px; align-items:center;"><button id="pres-prev" style="background:#111827;color:white;padding:8px 12px;border-radius:10px;border:1px solid #334155;">Prev</button><button id="pres-next" style="background:#111827;color:white;padding:8px 12px;border-radius:10px;border:1px solid #334155;">Next</button><button id="pres-auto" style="background:#0f172a;color:white;padding:8px 12px;border-radius:10px;border:1px solid #334155;">Auto</button><button id="pres-exit" style="background:#b91c1c;color:white;padding:8px 12px;border-radius:10px;border:1px solid #7f1d1d;">Exit</button></div></div><div id="presentation-stage" style="position:relative; width:100%; height:calc(100vh - 70px); overflow:auto; background:#0b1220; border:1px solid #1f2a44; border-radius:14px; padding:12px;"></div>`;
            document.body.appendChild(presentationOverlay);
        }

        function fitSlideToScreen(el) {
  if (!presentationOverlay) return;

  const stage = presentationOverlay.querySelector('#presentation-stage');
  if (!stage) return;

  // Reset any previous transforms
  el.style.transform = 'none';
  el.style.transformOrigin = 'top center';

  // Use stage size (more accurate than window - magic numbers)
  const padding = 24; // stage internal padding safety
  const vw = Math.max(200, stage.clientWidth - padding);
  const vh = Math.max(200, stage.clientHeight - padding);

  // Measure after it's visible
  const rect = el.getBoundingClientRect();
  if (!rect.width || !rect.height) return;

  const scaleX = vw / rect.width;
  const scaleY = vh / rect.height;

  // Allow upscale to fill screen (cap to avoid over-zoom)
  let scale = Math.min(scaleX, scaleY);
  scale = Math.max(0.25, Math.min(scale, 1.35));

  el.style.transform = `scale(${scale})`;
}


        function showLiveSlide(i) {
            const id = presentationOrder[i]; 
            const target = document.getElementById(id); 
            if (!target) return;
            
            presentationOrder.forEach(sid => { 
                const el = document.getElementById(sid); 
                if (el) el.style.display = 'none'; 
            });
            
            target.style.display = 'block'; 
            fitSlideToScreen(target);
            
            const title = presentationOverlay.querySelector('#pres-title'); 
            if (title) {
                
                title.textContent = `Slide ${i + 1} / ${presentationOrder.length} - ${id.replace('-cards-slide',' (Stats)').replace('-charts-slide',' (Charts)')}`;
            }
        }

        function presentationKeyHandler(e) {
            if (!presentationOverlay) return;
            if (e.key === 'Escape') stopPresentation();
            if (e.key === 'ArrowRight') { presentationIndex = (presentationIndex + 1) % presentationOrder.length; showLiveSlide(presentationIndex); }
            if (e.key === 'ArrowLeft') { presentationIndex = (presentationIndex - 1 + presentationOrder.length) % presentationOrder.length; showLiveSlide(presentationIndex); }
        }

        function presentationResizeHandler() { if (!presentationOverlay) return; showLiveSlide(presentationIndex); }

        function bindPresentationControls() {
            const prevBtn = presentationOverlay.querySelector('#pres-prev'); const nextBtn = presentationOverlay.querySelector('#pres-next'); const autoBtn = presentationOverlay.querySelector('#pres-auto'); const exitBtn = presentationOverlay.querySelector('#pres-exit');
            prevBtn.onclick = () => { presentationIndex = (presentationIndex - 1 + presentationOrder.length) % presentationOrder.length; showLiveSlide(presentationIndex); };
            nextBtn.onclick = () => { presentationIndex = (presentationIndex + 1) % presentationOrder.length; showLiveSlide(presentationIndex); };
            autoBtn.onclick = () => { if (presentationInterval) { clearInterval(presentationInterval); presentationInterval = null; autoBtn.textContent = 'Auto'; } else { presentationInterval = setInterval(() => { presentationIndex = (presentationIndex + 1) % presentationOrder.length; showLiveSlide(presentationIndex); }, 6000); autoBtn.textContent = 'Stop'; } };
            exitBtn.onclick = stopPresentation;
            window.addEventListener('keydown', presentationKeyHandler); window.addEventListener('resize', presentationResizeHandler);
        }

        async function startPresentation() {
            if (presentationActive) return; presentationActive = true;
            try { if (typeof backgroundRefresh === 'function') await backgroundRefresh(); if (typeof updateAllCharts === 'function') updateAllCharts(); } catch (e) {}
            presentationOrder = getPresentationSections();
            if (!presentationOrder.length) { presentationActive = false; return Swal.fire('Error', 'No sections are configured for presentation mode.', 'warning'); }
            setupPresentationOverlay(); bindPresentationControls();
            const stage = presentationOverlay.querySelector('#presentation-stage');
            presentationOrder.forEach(id => {
                const el = document.getElementById(id); if (!el) return;
                const placeholder = document.createComment(`restore:${id}`);
                el.parentNode.insertBefore(placeholder, el);
                presentationRestore.set(id, { placeholder, originalParent: placeholder.parentNode });
                stage.appendChild(el); el.style.margin = '0'; el.style.display = 'none';
            });
            presentationIndex = 0; showLiveSlide(presentationIndex);
            window.presentationUpdateInterval = setInterval(async () => { try { if (typeof backgroundRefresh === 'function') await backgroundRefresh(); if (typeof updateAllCharts === 'function') updateAllCharts(); showLiveSlide(presentationIndex); } catch (e) {} }, 300000);
        }

        function stopPresentation() {
            if (!presentationActive) return; presentationActive = false;
            if (presentationInterval) { clearInterval(presentationInterval); presentationInterval = null; } clearInterval(window.presentationUpdateInterval);
            presentationOrder.forEach(id => {
                const el = document.getElementById(id); const info = presentationRestore.get(id); if (!el || !info) return;
                info.originalParent.insertBefore(el, info.placeholder); info.placeholder.remove();
                el.style.transform = ''; el.style.transformOrigin = ''; el.style.display = '';
            });
            presentationRestore.clear(); presentationOrder = [];
            window.removeEventListener('keydown', presentationKeyHandler); window.removeEventListener('resize', presentationResizeHandler);
            if (presentationOverlay) { presentationOverlay.remove(); presentationOverlay = null; }
        }
function jumpToCurrentMonth() {
    const now = new Date();
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    
    const yearShort = String(now.getFullYear()).slice(2);
    const monthShort = months[now.getMonth()];
    const currentMonthStr = `${yearShort}-${monthShort}`;

    renderMonthlySchedule(currentMonthStr);

    const btn = document.querySelector('#monthly-schedule button');
    const title = document.querySelector('#monthly-schedule .section-title');
    
    if(title) title.innerHTML = `<i class="far fa-calendar-alt mr-2"></i> Monthly Schedule <span class="text-brand-400">(${monthShort} ${now.getFullYear()})</span>`;
    
    Swal.fire({
        toast: true,
        position: 'top-end',
        icon: 'info',
        title: `Switched to Current Month (${monthShort})`,
        showConfirmButton: false,
        timer: 2000,
        background: '#1e293b',
        color: '#fff'
    });
}	
function collectVisibleCardsSnapshot() {
    const grids = [
        'row-orders','row-returns',
        'storage-grid','quality-grid',
        'inbound-cases-grid','inbound-pallets-grid','inbound-trucks-grid',
        'outbound-cases-grid','outbound-pallets-grid','outbound-total-trucks-grid',
        'outbound-destinations-grid','outbound-trips-grid',
        'rsd-grid','pod-pending-grid','return-pending-grid'
    ];

    const snap = [];
    grids.forEach(gridId => {
        const host = document.getElementById(gridId);
        if (!host) return;

        const cards = host.querySelectorAll('.glass-card');
        cards.forEach(card => {
            const title = card.getAttribute('data-title') || card.querySelector('h4')?.innerText?.trim() || '';
            const value = card.getAttribute('data-value') || card.querySelector('.num-font')?.innerText?.trim() || '';
            const unit  = card.getAttribute('data-unit')  || card.querySelector('.text-slate-500')?.innerText?.trim() || '';
            const wh    = card.querySelector('h4.text-slate-400.text-xs.font-bold.uppercase')?.innerText?.trim() || '';

            snap.push({
                grid: gridId,
                warehouse: wh,
                title,
                value,
                unit
            });
        });
    });

    return snap;
}
async function getDailySummary() {
    const modal = document.getElementById('aiSummaryModal');
    const content = document.getElementById('aiSummaryContent');
    const cacheIndicator = document.getElementById('ai-cache-status');

    if(!modal || !content) return;

    modal.classList.remove('hidden');
    modal.style.display = 'flex';
    if(cacheIndicator) cacheIndicator.classList.add('hidden');

    content.innerHTML = `
        <div class="flex flex-col items-center justify-center py-12 space-y-4">
            <div class="relative">
                <div class="w-12 h-12 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center"><i class="fas fa-brain text-purple-400 text-xs"></i></div>
            </div>
            <p class="text-slate-400 animate-pulse text-xs uppercase tracking-widest">Generating Insights...</p>
        </div>`;

    const currentMonth = document.getElementById('monthSelect')?.value || '';
    const todayStr = new Date().toISOString().split('T')[0];
    const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];

    const logDates = Object.keys(masterShiftLogs || {}).sort();
    const lastLogDate = logDates[logDates.length - 1] || '';
    const lastLog = (masterShiftLogs && lastLogDate && masterShiftLogs[lastLogDate]) ? masterShiftLogs[lastLogDate] : {};

    const derived_context = {
        meta: {
            today: todayStr,
            report_month: currentMonth,
            last_update: document.getElementById('lastUpdateTxt')?.innerText || '',
            last_shift_log_date: lastLogDate
        },
        inbound_data: (WH_ORDER || []).map(wh => ({
            warehouse: wh,
            pallets: getMetric(currentMonth, wh, 'Inbound Pallets'),
            cases: getMetric(currentMonth, wh, 'inbound Case'),
            trucks_45ft: getMetric(currentMonth, wh, 'Inbound Trucks 45 ft')
        })),
        outbound_data: (WH_ORDER || []).map(wh => ({
            warehouse: wh,
            pallets: getMetric(currentMonth, wh, 'Outbound Pallets'),
            cases: getMetric(currentMonth, wh, 'Outbound Case'),
            trucks_45ft: getMetric(currentMonth, wh, 'Outbound Trucks 45 ft'),
            trucks_20t: getMetric(currentMonth, wh, 'Outbound_20_TON'),
            trucks_10t: getMetric(currentMonth, wh, 'Outbound_10_TON'),
            trips: getMetric(currentMonth, wh, 'TOTAL TRIPS'),
            destinations: getMetric(currentMonth, wh, 'TOTAL DESTINATIONS')
        })),
        last_shift_performance: {
            date: lastLogDate,
            morning_actual_trucks: lastLog?.morning?.act ?? null,
            evening_actual_trucks: lastLog?.evening?.act ?? null
        },
        pallet_tracking: {
            available_euro: (pallets || []).filter(p => p.type === 'euro').reduce((a, b) => a + (Number(b.qty) || 0), 0),
            available_used: (pallets || []).filter(p => p.type === 'used').reduce((a, b) => a + (Number(b.qty) || 0), 0),
            closed_pos_count: (palletsClosed || []).length
        },
        vacations: {
            today: (vacations || []).filter(v => todayStr >= v.start && todayStr <= v.end).map(v => v.name),
            tomorrow: (vacations || []).filter(v => tomorrowStr >= v.start && tomorrowStr <= v.end).map(v => v.name)
        },
        shift_manpower: {
            morning_count: (shifts && shifts[todayStr]?.morning ? shifts[todayStr].morning.length : 0),
            evening_count: (shifts && shifts[todayStr]?.evening ? shifts[todayStr].evening.length : 0),
            night_count: (shifts && shifts[todayStr]?.night ? shifts[todayStr].night.length : 0)
        },
        pending_actions: (WH_ORDER || []).map(wh => ({
            warehouse: wh,
            pod_pending: getMetric(currentMonth, wh, 'POD pending'),
            return_pending: getMetric(currentMonth, wh, 'Return pending')
        })),
        stock_reconciliation: (WH_ORDER || []).map(wh => ({
            warehouse: wh,
            sap_balance: getMetric(currentMonth, wh, 'SAP'),
            rsd_balance: getMetric(currentMonth, wh, 'RSD')
        }))
    };

    const visible_cards = collectVisibleCardsSnapshot();

    const snapshot = {
        meta: derived_context.meta,
        visible_cards,
        derived_context,
        raw_sources_hint: {
            whs: 'WHSdata.json',
            employees: 'employees.json',
            shifts: 'shifts.json',
            overtime: 'overtime.json',
            custom_cards: 'custom_cards.json',
            shift_logs: 'shift_logs_master.json',
            manual_metrics: 'manual_metrics.json',
            vacations: 'vacations.json'
        }
    };

    try {
        const token = localStorage.getItem('authToken');

        const response = await fetch(`${WORKER_URL}/api/ai-summary`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                contextData: {
                    meta: { today: todayStr },
                    snapshot
                }
            })
        });

        const data = await response.json();

        if (!response.ok) {
            const msg = data?.errorText || data?.error || 'AI Service Unavailable';
            throw new Error(msg);
        }

        let htmlContent = String(data.summary || '')
            .replace(/^### (.*$)/gim, '<h4 class="text-lg font-bold text-white mt-4 mb-2">$1</h4>')
            .replace(/^## (.*$)/gim, '<h3 class="text-xl font-bold text-brand-400 mt-6 mb-3">$1</h3>')
            .replace(/^\- (.*$)/gim, '<li class="ml-4 text-slate-300">$1</li>')
            .replace(/^\* (.*$)/gim, '<li class="ml-4 text-slate-300">$1</li>')
            .replace(/\*\*(.*)\*\*/gim, '<strong class="text-white">$1</strong>')
            .replace(/\n/g, '<br>');

        content.innerHTML = `<div class="prose prose-invert prose-sm max-w-none leading-relaxed">${htmlContent}</div>`;

        if (data.cached && cacheIndicator) {
            cacheIndicator.classList.remove('hidden');
        }

    } catch (e) {
        console.error(e);
        content.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-3"></i>
                <p class="text-red-400 font-bold">Failed to generate summary.</p>
                <p class="text-slate-500 text-xs mt-2">${e.message || "Check API configuration"}</p>
            </div>`;
    }
}
	
</script>
</body>
</html>
